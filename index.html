<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© DA/í¼í¬ë¨¼ìŠ¤ ìº í˜ì¸ ì‹¬ì¸µ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse CSV Library CDN (REMOVED) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .scroll-container::-webkit-scrollbar { height: 8px; }
        .scroll-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .scroll-container::-webkit-scrollbar-track { background: #f1f5f9; }
        
        /* 4-Quadrant Matrix Styling */
        .quadrant-matrix {
            position: relative;
            width: 100%;
            height: 480px; 
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }
        .quadrant {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            /* *** (Request 2) ìˆ˜ì •: flex-start -> center *** */
            justify-content: center; 
            align-items: center; 
            position: relative;
            z-index: 10;
        }
        /* Quadrant Colors & Labels for Intuitive Interpretation */
        /* *** (Problem 1.3) ìˆ˜ì •: ë°°ê²½ìƒ‰ë§Œ ë‚¨ê¸°ê³  ë¼ë²¨ ì œê±° *** */
        .quadrant-top-right { background-color: rgba(16, 185, 129, 0.05); } /* Top-Right */
        .quadrant-top-left { background-color: rgba(59, 130, 246, 0.05); } /* Top-Left */
        .quadrant-bottom-right { background-color: rgba(245, 158, 11, 0.05); } /* Bottom-Right */
        .quadrant-bottom-left { background-color: rgba(239, 68, 68, 0.05); } /* Bottom-Left */
        
        /* *** (Request 1) ìˆ˜ì •: ì›Œí„°ë§ˆí¬(.quadrant-label) ì œê±° *** */
        .quadrant-label {
            display: none;
        }
        
        /* Quadrant Middle Lines (New Improvement) */
        .matrix-lines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 20;
        }
        .v-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            border-left: 2px dashed #9ca3af; /* Gray dashed line for mid-point */
            transform: translateX(-1px);
        }
        .h-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            border-top: 2px dashed #9ca3af; /* Gray dashed line for mid-point */
            transform: translateY(-1px);
        }
        .chart-dot {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 50;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid #fff;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
        }
        .chart-dot:hover {
            transform: scale(1.5);
            z-index: 60;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .sortable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sortable:hover {
            background-color: #e5e7eb;
        }
        
        /* Custom styles for validation table headers */
        #validation-input-table thead th {
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #e5e7eb; /* Light gray border for separation */
        }
        #validation-input-table thead tr:first-child th {
            border-bottom: none; /* No double line between first and second header row */
            border-right: 1px solid #d1d5db; /* Darker line for group separation */
        }
        #validation-input-table thead tr:last-child th {
             border-right: 1px solid #e5e7eb; /* Separator for bottom row cells */
             padding-top: 4px; /* Adjust padding for better look */
        }
        
        /* Style for header sub-text */
        .header-subtext {
            display: block;
            font-size: 0.65rem; /* 10.4px */
            font-weight: 500;
            color: #4b5563; /* gray-600 */
            margin-top: 1px;
        }
        
        /* Style for prefill input text */
        .input-prefill {
            color: #9ca3af; /* gray-400 */
        }
        .input-prefill:focus {
            color: #111827; /* gray-900 (default text color) */
        }
        
        /* *** AI UPLOAD: ë¡œë”© ìŠ¤í”¼ë„ˆ (REMOVED) *** */
    </style>
</head>
<body class="p-4 md:p-8"> <!-- ì¢Œìš° íŒ¨ë”©ì„ ì¤„ì˜€ìŠµë‹ˆë‹¤ -->
    <div id="app" class="w-full mx-auto bg-white rounded-xl shadow-2xl p-8 md:p-12">
        <!-- Header and Campaign Selector -->
        <header class="mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">í†µí•© ìº í˜ì¸ ì„±ê³¼ ì‹¬ì¸µ ë¶„ì„ ëŒ€ì‹œë³´ë“œ (PC)</h1>
            <p class="text-gray-500">DA/í¼í¬ë¨¼ìŠ¤ ëª©í‘œë³„ íš¨ìœ¨ ë¶„ì„ ë° ì†Œì¬ ë“±ê¸‰ë³„ ì§ê´€ì  ì¸ì‚¬ì´íŠ¸ ë„ì¶œ</p>
        </header>
        <!-- Campaign Selector Tabs -->
        <div class="flex space-x-2 p-1 bg-gray-100 rounded-lg max-w-lg mb-8" role="tablist">
            <button id="tab-da" data-camp="DA" class="campaign-tab flex-1 py-3 px-6 text-base font-semibold rounded-lg bg-indigo-600 text-white shadow-lg transition-all">
                DA ìº í˜ì¸ (ë°˜ì‘ ëª©í‘œ)
            </button>
            <button id="tab-perf" data-camp="PERF" class="campaign-tab flex-1 py-3 px-6 text-base font-medium text-gray-600 hover:bg-white hover:text-indigo-600 transition-all">
                í¼í¬ë¨¼ìŠ¤ ìº í˜ì¸ (ì „í™˜ ëª©í‘œ)
            </button>
        </div>
        <!-- Campaign Validation Input Section -->
        <div id="validation-section" class="mb-10">
            <!-- Title and Toggle Button -->
            <div class="flex items-center justify-between mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold text-gray-800">
                    ìº í˜ì¸ ëª©í‘œ & ì„±ê³¼ ê²€ì¦ í•­ëª© ì…ë ¥
                </h2>
                <!-- Initial text is now 'ì…ë ¥ í…Œì´ë¸” ì ‘ê¸°' -->
                <button id="toggle-validation-table" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 text-sm font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                    <span id="toggle-text">ì…ë ¥ í…Œì´ë¸” ì ‘ê¸°</span> 
                    <!-- Initial icon is now 'rotate-180' (handled in JS for consistency) -->
                    <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1 transform transition-transform rotate-180"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <!-- Collapsible Input Table Container (Removed 'hidden' class) -->
            <div id="validation-table-content" class="transition-all duration-300 overflow-hidden">
                <div class="bg-gray-50 p-4 rounded-xl shadow-inner border">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-sm text-gray-600">
                            <span id="validation-campaign-label" class="font-bold text-indigo-600">DA ìº í˜ì¸</span> íš¨ìœ¨ ê²€ì¦ í•­ëª©ì„ ì§ì ‘ ê¸°ì¬í•´ì£¼ì„¸ìš”.
                        </p>
                        <!-- *** (LocalStorage) NEW: ë²„íŠ¼ ê·¸ë£¹ *** -->
                        <div class="flex items-center space-x-2">
                            <span id="save-status" class="text-sm text-green-600 font-medium hidden">ì €ì¥ë¨!</span>
                            <button id="save-data-button" class="bg-blue-500 text-white hover:bg-blue-600 text-xs font-semibold py-1 px-3 rounded-md transition-colors">
                                ğŸ’¾ í˜„ì¬ ë‚´ìš© ì €ì¥
                            </button>
                            <button id="reset-data-button" class="bg-red-500 text-white hover:bg-red-600 text-xs font-semibold py-1 px-3 rounded-md transition-colors">
                                ğŸ”„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                            </button>
                            <button id="add-validation-row" class="bg-green-500 text-white hover:bg-green-600 text-xs font-semibold py-1 px-3 rounded-md transition-colors">
                                + í•­ëª© ì¶”ê°€
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table id="validation-input-table" class="min-w-full divide-y divide-gray-200 border-separate border-spacing-0">
                            <thead id="validation-table-header" class="bg-gray-100 sticky top-0">
                                <!-- Table Headers will be injected here (2 rows) -->
                            </thead>
                            <tbody id="validation-table-body">
                                <!-- Input Rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Trigger Button (Keep for manual re-run) -->
        <div class="mb-10 text-center">
            <button id="run-analysis-button" class="bg-blue-600 text-white hover:bg-blue-700 text-xl font-bold py-3 px-8 rounded-xl shadow-xl transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                 ğŸ“Š  ì…ë ¥ ë°ì´í„° ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ ë¶„ì„ ì¬ì‹¤í–‰
            </button>
        </div>
        <!-- Analysis Results Container (REMOVED 'hidden' class) -->
        <div id="analysis-results"> 
            <!-- 1. Overall Performance Summary Table -->
            <div class="mb-10">
                <!-- *** ìˆ˜ì •: (2.1) <h2>ì— ID ì¶”ê°€ *** -->
                <h2 id="summary-main-title" class="text-2xl font-bold text-gray-800 mb-4">
                    ì¢…í•© ì„±ê³¼ ìš”ì•½ 
                    <span id="summary-title" class="text-indigo-600 text-lg ml-2"></span>
                </h2>
                <!-- *** ìˆ˜ì •: (2.4) ê°€ë¡œ ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì¶”ê°€ *** -->
                <div class="scroll-container overflow-x-auto rounded-xl shadow-lg border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50">
                            <tr id="summary-header" class="text-sm font-semibold text-indigo-700 uppercase tracking-wider">
                                <!-- Summary Headers -->
                            </tr>
                        </thead>
                        <tbody id="summary-body" class="bg-white divide-y divide-gray-200">
                            <!-- Summary Data -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 2. Visualization and Insights (3-Column Layout) -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-10">
                
                <!-- Left 2/3: 4-Quadrant Matrix (Existing Logic) -->
                <div class="xl:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <!-- *** (Problem 4) ìˆ˜ì •: íƒ€ì´í‹€ ë³€ê²½ *** -->
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            ì†Œì¬ ì„±ê³¼ ë§¤íŠ¸ë¦¬ìŠ¤
                            <!-- *** (Problem 2) ìˆ˜ì •: ë¶€ì œ span ì‚­ì œ *** -->
                        </h2>
                        
                        <div class="quadrant-matrix" id="quadrant-matrix">
                            <!-- Quadrant Lines (NEW) -->
                            <div class="matrix-lines">
                                <div class="v-line"></div>
                                <div class="h-line"></div>
                            </div>
                            
                            <!-- *** (Problem 1) ìˆ˜ì •: Top-Leftì™€ Top-Right ìˆœì„œ ë³€ê²½ *** -->
                            
                            <!-- Quadrant 1 -> 2: Top Left (Potential) -->
                            <div class="quadrant quadrant-top-left">
                                <!-- *** (Request 1) ìˆ˜ì •: h-full ì œê±°, justify-center ì¶”ê°€ *** -->
                                <div class="relative z-10 flex flex-col justify-center text-center">
                                    <h3 class="text-xl font-extrabold text-blue-700">High Potential</h3>
                                    <p class="text-sm text-gray-500 mt-2">ë…¸ì¶œ íš¨ìœ¨(Low) ì†Œì¬ ë§¤ë ¥ë„(High)</p>
                                    <p class="text-sm text-gray-700 mt-2">í›…í‚¹ì„±ì€ ë†’ì§€ë§Œ ì˜ ì•Œë ¤ì§€ì§€ ì•Šì€ ì†Œì¬</p>
                                    <div class="mt-4">
                                        <span class="inline-block py-1 px-3 rounded-full text-sm font-semibold text-blue-800 bg-blue-100">
                                            Action : íƒ€ê²ŸíŒ… í™•ì¥
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Quadrant 2 -> 1: Top Right (Top) -->
                            <div class="quadrant quadrant-top-right">
                                <!-- *** (Request 1) ìˆ˜ì •: h-full ì œê±°, justify-center ì¶”ê°€ *** -->
                                <div class="relative z-10 flex flex-col justify-center text-center">
                                    <h3 class="text-xl font-extrabold text-green-700">STAR</h3>
                                    <p class="text-sm text-gray-500 mt-2">ë…¸ì¶œ íš¨ìœ¨(High) ì†Œì¬ ë§¤ë ¥ë„(High)</p>
                                    <p class="text-sm text-gray-700 mt-2">ëŒ€ì¤‘ì ìœ¼ë¡œ ê°€ì¥ ë°˜ì‘ì´ ìš°ìˆ˜í•œ ì†Œì¬</p>
                                    <div class="mt-4">
                                        <span class="inline-block py-1 px-3 rounded-full text-sm font-semibold text-green-800 bg-green-100">
                                            Action : ìœ ì§€ / ì˜ˆì‚° ì¦ëŒ€
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Quadrant 3: Bottom Left (Low) -->
                            <div class="quadrant quadrant-bottom-left">
                                <!-- *** (Request 1) ìˆ˜ì •: h-full ì œê±°, justify-center ì¶”ê°€ *** -->
                                <div class="relative z-10 flex flex-col justify-center text-center">
                                    <h3 class="text-xl font-extrabold text-red-700">Question Mark</h3>
                                    <p class="text-sm text-gray-500 mt-2">ë…¸ì¶œ íš¨ìœ¨(Low) ì†Œì¬ ë§¤ë ¥ë„(Low)</p>
                                    <p class="text-sm text-gray-700 mt-2">ì˜ˆì‚° ë‚­ë¹„ ê°€ëŠ¥ì„±ì´ ë†’ì€ ì†Œì¬</p>
                                    <div class="mt-4">
                                        <span class="inline-block py-1 px-3 rounded-full text-sm font-semibold text-red-800 bg-red-100">
                                            Action : ê´‘ê³ OFF / ì˜ˆì‚°ì´ê´€
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Quadrant 4: Bottom Right (Focus) -->
                            <div class="quadrant quadrant-bottom-right">
                                <!-- *** (Request 1) ìˆ˜ì •: h-full ì œê±°, justify-center ì¶”ê°€ *** -->
                                <div class="relative z-10 flex flex-col justify-center text-center">
                                    <h3 class="text-xl font-extrabold text-amber-700">Niche</h3>
                                    <p class="text-sm text-gray-500 mt-2">ë…¸ì¶œ íš¨ìœ¨(High) ì†Œì¬ ë§¤ë ¥ë„(Low)</p>
                                    <p class="text-sm text-gray-700 mt-2">ì†Œìˆ˜ì˜ ì§‘ë‹¨ì—ì„œ ë°˜ì‘ì´ ë†’ì€ ì†Œì¬</p>
                                    <div class="mt-4">
                                        <span class="inline-block py-1 px-3 rounded-full text-sm font-semibold text-amber-800 bg-amber-100">
                                            Action : ë²”ìš©ì  ì†Œì¬ / í›…í‚¹ì„± ê°•í™”
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Dots are injected here -->
                        </div>
                        
                        <!-- *** (Problem 3) ìˆ˜ì •: í•˜ë‹¨ ë¼ë²¨ í…ìŠ¤íŠ¸ ì „ì²´ ì‚­ì œ *** -->
                    </div>
                </div>
                <!-- Right 1/3: Key Insights (Existing Logic) -->
                <div class="xl:col-span-1 space-y-6">
                    <div class="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200 h-full">
                        <!-- *** ìˆ˜ì •: (2.1) íƒ€ì´í‹€ ë³€ê²½ *** -->
                        <h2 class="text-2xl font-bold text-indigo-700 mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                            MEDIA INSIGHT
                        </h2>
                        <ul id="insight-list" class="space-y-4 text-gray-700 text-sm">
                            <!-- Insights will be injected here -->
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 3. Efficiency Data Table (Existing Logic) -->
            <div class="mt-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ìº í˜ì¸ ìƒì„¸ íš¨ìœ¨ ì§€í‘œ (ì†Œì¬ë³„)</h2>
                <div class="scroll-container overflow-x-auto rounded-xl shadow-inner border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr id="table-header" class="text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <!-- Headers will be injected here -->
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- *** AI UPLOAD: ì—ëŸ¬ ëª¨ë‹¬ (REMOVED) *** -->
    
    <script>
        // Firebase Config (Mandatory, though not used for persistence here)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        // *** (LocalStorage) NEW: í‚¤ ì •ì˜ ***
        const LOCAL_STORAGE_KEY = 'campaignDashboardData';
        
        // *** ìˆ˜ì •: (1.2) ì „ì—­ í”Œë˜ê·¸ ì¶”ê°€ ***
        let isPrefillActive = true; 
        
        // *** (LocalStorage) NEW: Function to save data ***
        function saveDataToLocalStorage() {
            try {
                // validationDataì—ëŠ” rowIdê°™ì€ ì„ì‹œ IDê°€ ìˆìœ¼ë¯€ë¡œ ì €ì¥
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(validationData));
                
                // (LocalStorage) NEW: Show save status
                const saveStatus = document.getElementById('save-status');
                saveStatus.classList.remove('hidden');
                setTimeout(() => {
                    saveStatus.classList.add('hidden');
                }, 2000); // 2ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¹€
                
            } catch (e) {
                console.error("Error saving to localStorage", e);
                // (Optional) UI alert if storage is full
            }
        }
        
        // Helper function for formatting numbers with commas
        const formatNumericInput = (value) => {
            // Remove all non-digit characters
            const cleanValue = value.toString().replace(/[^\d]/g, ''); 
            if (cleanValue === '') return '';
            // Add thousand separators
            return parseInt(cleanValue, 10).toLocaleString('ko-KR');
        };
        // Helper function for formatting numbers for display
        const formatNumber = (num, type) => {
            if (typeof num !== 'number' || isNaN(num) || num === null) return '-';
            switch (type) {
                case 'percent': return `${(num * 100).toFixed(2)}%`; // Assumes num is fraction (e.g., 0.005)
                case 'currency': return `${Math.round(num).toLocaleString('ko-KR')}ì›`;
                case 'score': return num.toFixed(2);
                default: return num.toLocaleString('ko-KR');
            }
        };
        // Mock data structure (only used for headers to maintain consistency)
        const campaignData = {
            'DA': {
                name: 'DA ìº í˜ì¸ (ë°˜ì‘ ëª©í‘œ)',
                metrics: { xAxis: 'ì†Œì¬ ê´€ì‹¬ë„ (B)', yAxis: 'ìœ íš¨ ë…¸ì¶œ ê¸°ì—¬ë„ (A)' },
                headers: [
                    { name: 'ë§¤ì²´', key: 'media' }, 
                    { name: 'ìƒí’ˆ', key: 'placement' }, // 'ì†Œì¬ êµ¬ë¶„' -> 'ìƒí’ˆ'
                    { name: 'ì†Œì¬ëª…', key: 'creativeName' }, // 'ì†Œì¬ëª…' ì¶”ê°€
                    { name: 'ê´‘ê³ ë¹„(ì›)', key: 'cost' }, // ìˆœì„œ ë³€ê²½
                    { name: 'ë…¸ì¶œìˆ˜', key: 'imp' }, // ìˆœì„œ ë³€ê²½
                    { name: 'í´ë¦­ìˆ˜', key: 'click' }, // ìˆœì„œ ë³€ê²½
                    { name: 'CPM(ì›)', key: 'cpm' }, 
                    { name: 'CTR(%)', key: 'ctr' }, { name: 'CPC(ì›)', key: 'cpc' }, 
                    { name: 'A ì ìˆ˜', key: 'scoreA' }, { name: 'B ì ìˆ˜', key: 'scoreB' }, 
                    { name: 'ì´ì ', key: 'total' }, { name: 'INSIGHT', key: 'insight' }, 
                    { name: 'í”¼ë“œë°±', key: 'action' } // *** (Problem 3) ìˆ˜ì •: 'êµì²´ ìœ ë¬´' -> 'í”¼ë“œë°±' ***
                ],
                data: [
                    // *** ìˆ˜ì •ëœ Mock Data ***
                    { media: 'ë„¤ì´ë²„', creative: 'ì†Œì¬A_ìŠ¤í˜ì…œDA', cost: 11480000, imp: 7200000, click: 16000, cpm: null, ctr: null, cpc: null, scoreA: null, scoreB: null, total: null, insight: null, color: null, mediaInsight: null },
                    { media: 'ì¹´ì¹´ì˜¤', creative: 'ì†Œì¬B_ë¹„ì¦ˆë³´ë“œ', cost: 150000000, imp: 170000000, click: 250000, cpm: null, ctr: null, cpc: null, scoreA: null, scoreB: null, total: null, insight: null, color: null, mediaInsight: null },
                    { media: 'êµ¬ê¸€', creative: 'ì†Œì¬C_GDN', cost: 80000000, imp: 9500000, click: 25000, cpm: null, ctr: null, cpc: null, scoreA: null, scoreB: null, total: null, insight: null, color: null, mediaInsight: null },
                    { media: 'ë²„ì¦ˆë¹Œ', creative: 'ì†Œì¬D_ë„¤íŠ¸ì›Œí¬', cost: null, imp: null, click: null, cpm: null, ctr: null, cpc: null, scoreA: null, scoreB: null, total: null, insight: null, color: null, mediaInsight: null },
                ],
            },
            'PERF': {
                name: 'í¼í¬ë¨¼ìŠ¤ ìº í˜ì¸ (ì „í™˜ ëª©í‘œ)',
                metrics: { xAxis: 'ì „í™˜ ê¸°ì—¬ë„ (B)', yAxis: 'ê´‘ê³  ê´€ì‹¬ë„ (A)' },
                headers: [
                    { name: 'ë§¤ì²´', key: 'media' }, 
                    { name: 'ìƒí’ˆ', key: 'placement' }, // 'ì†Œì¬ êµ¬ë¶„' -> 'ìƒí’ˆ'
                    { name: 'ì†Œì¬ëª…', key: 'creativeName' }, // 'ì†Œì¬ëª…' ì¶”ê°€
                    { name: 'ê´‘ê³ ë¹„(ì›)', key: 'cost' }, // ìˆœì„œ ë³€ê²½
                    { name: 'ë…¸ì¶œìˆ˜', key: 'imp' }, // ìˆœì„œ ë³€ê²½
                    { name: 'í´ë¦­ìˆ˜', key: 'click' }, // ìˆœì„œ ë³€ê²½
                    { name: 'ì „í™˜ìˆ˜', key: 'conv' }, { name: 'ë§¤ì¶œì•¡(ì›)', key: 'revenue' }, 
                    { name: 'CTR(%)', key: 'ctr' }, 
                    { name: 'CPA(ì›)', key: 'cpa' }, { name: 'ROAS(%)', key: 'roas' },
                    { name: 'A ì ìˆ˜', key: 'scoreA' }, { name: 'B ì ìˆ˜', key: 'scoreB' }, 
                    { name: 'ì´ì ', key: 'total' }, { name: 'INSIGHT', key: 'insight' }, 
                    { name: 'í”¼ë“œë°±', key: 'action' } // *** (Problem 3) ìˆ˜ì •: 'êµì²´ ìœ ë¬´' -> 'í”¼ë“œë°±' ***
                ],
                data: [
                    { media: 'êµ¬ê¸€ SA', creative: 'ì†Œì¬_í‚¤ì›Œë“œ1', cost: 2000000, imp: 150000, click: 7500, conv: 100, revenue: 15000000, ctr: 0.050, cpa: 20000, roas: 750, scoreA: 5.0, scoreB: 4.8, total: 4.9, insight: 'Top ì†Œì¬', color: '#10b981', mediaInsight: 'SA Top í‚¤ì›Œë“œëŠ” ë…ë³´ì ì¸ íš¨ìœ¨ì…ë‹ˆë‹¤. ì˜ˆì‚° ìµœëŒ€ í™•ëŒ€ë¥¼ ê³ ë ¤.' },
                    { media: 'í˜ì´ìŠ¤ë¶/ì¸ìŠ¤íƒ€', creative: 'ì†Œì¬_ì—¬ì„±íƒ€ê²Ÿ', cost: 1800000, imp: 500000, click: 4000, conv: 80, revenue: 8000000, ctr: 0.008, cpa: 22500, roas: 444, scoreA: 4.0, scoreB: 4.5, total: 4.25, insight: 'Top ì†Œì¬', color: '#10b981', mediaInsight: 'SNSëŠ” ê´€ì‹¬ë„(A)ëŠ” ìš°ìˆ˜í•˜ë‚˜, CPA ê°œì„ ì„ ìœ„í•´ ëœë”©í˜ì´ì§€ ìµœì í™”(LPO)ê°€ í•„ìš”í•©ë‹ˆë‹¤.' },
                    { media: 'ë„¤ì´ë²„ ì‡¼í•‘ê²€ìƒ‰', creative: 'ì†Œì¬_ìƒí’ˆA', cost: 1200000, imp: 200000, click: 1500, conv: 50, revenue: 5000000, ctr: 0.0075, cpa: 24000, roas: 416, scoreA: 3.5, scoreB: 3.0, total: 3.25, insight: 'Potential ì†Œì¬', color: '#3b82f6', mediaInsight: 'ì‡¼í•‘ê²€ìƒ‰ì€ ì „í™˜ ë³¼ë¥¨(B)ì„ ëŠ˜ë ¤ì•¼ í•©ë‹ˆë‹¤. ì˜ˆì‚° ì¦ì•¡ë³´ë‹¤ëŠ” ì†Œì¬(A) ê°œì„  í•„ìš”.' },
                    { media: 'êµ¬ê¸€ GDN', creative: 'ì†Œì¬_ë¦¬íƒ€ê²ŸíŒ…', cost: 1000000, imp: 400000, click: 500, conv: 20, revenue: 2000000, ctr: 0.00125, cpa: 50000, roas: 200, scoreA: 1.5, scoreB: 1.0, total: 1.25, insight: 'Low ì†Œì¬', color: '#ef4444', mediaInsight: 'Low íš¨ìœ¨ ë¦¬íƒ€ê²ŸíŒ… ìº í˜ì¸ì€ ì¦‰ì‹œ OFFí•˜ê±°ë‚˜ íƒ€ê²ŸíŒ… ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ë§¤ìš° ì¢ê²Œ ì¬ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.' },
                ],
            }
        };
        let sortColumn = 'total';
        let sortDirection = 'desc';
        let currentCampaign = 'DA';
        let liveAnalysisData = null; // New variable to hold calculated data
        // --- NEW: Validation Table Logic & Data Setup (Updated for 2-level header) ---
        
        const validationTableConfigs = {
            'DA': {
                label: 'DA ìº í˜ì¸',
                // Define the Level 1 Header Groups
                headerGroups: [
                    { name: 'ê¸°ë³¸ ì •ë³´', cols: ['media', 'placement', 'creativeName', 'cost', 'imp'] },
                    { name: 'ë…¸ì¶œ ì„±ê³¼ (CPM)', cols: ['targetCpm', 'actualCpm'] },
                    { name: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)', cols: ['click', 'targetCpc', 'actualCpc', 'targetCtr', 'actualCtr'] },
                    { name: 'ì¡°íšŒ ì„±ê³¼ (CPV)', cols: ['view', 'targetCpv', 'actualCpv'] },
                ],
                // Define the Level 2 Columns
                cols: [
                    { name: 'ë§¤ì²´', key: 'media', type: 'text', placeholder: 'ë§¤ì²´', width: 'w-24', group: 'ê¸°ë³¸ ì •ë³´' },
                    { name: 'ìƒí’ˆ', key: 'placement', type: 'text', placeholder: 'ìƒí’ˆ', width: 'w-24', group: 'ê¸°ë³¸ ì •ë³´' },
                    { name: 'ì†Œì¬ëª…', key: 'creativeName', type: 'text', placeholder: 'ì†Œì¬ëª…', width: 'w-24', group: 'ê¸°ë³¸ ì •ë³´' },
                    { name: 'ê´‘ê³ ë¹„(ì›)', key: 'cost', type: 'number', placeholder: 'ê¸ˆì•¡', width: 'w-24', isLargeNumber: true, group: 'ê¸°ë³¸ ì •ë³´' }, // ë¼ë²¨ ë³€ê²½
                    { name: 'ë…¸ì¶œìˆ˜', key: 'imp', type: 'number', placeholder: 'íšŸìˆ˜', width: 'w-20', isLargeNumber: true, group: 'ê¸°ë³¸ ì •ë³´' }, 
                    
                    // ëª©í‘œ CPM, CPC, CPVì— isLargeNumber: true ì ìš© (ìš”ì²­ ì‚¬í•­ ë°˜ì˜)
                    { name: 'ëª©í‘œ CPM(ì›)', key: 'targetCpm', type: 'currency', placeholder: 'ëª©í‘œCPM', width: 'w-24', isLargeNumber: true, group: 'ë…¸ì¶œ ì„±ê³¼ (CPM)' },
                    { name: 'ì„±ê³¼ CPM(ì›)', key: 'actualCpm', type: 'currency', placeholder: 'ì„±ê³¼CPM', width: 'w-24', calculated: true, group: 'ë…¸ì¶œ ì„±ê³¼ (CPM)' },
                    
                    { name: 'í´ë¦­ìˆ˜', key: 'click', type: 'number', placeholder: 'íšŸìˆ˜', width: 'w-20', isLargeNumber: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' }, 
                    { name: 'ëª©í‘œ CPC(ì›)', key: 'targetCpc', type: 'currency', placeholder: 'ëª©í‘œCPC', width: 'w-24', isLargeNumber: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    { name: 'ì„±ê³¼ CPC(ì›)', key: 'actualCpc', type: 'currency', placeholder: 'ì„±ê³¼CPC', width: 'w-24', calculated: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    { name: 'ëª©í‘œ CTR(%)', key: 'targetCtr', type: 'percent', placeholder: 'ëª©í‘œCTR', width: 'w-24', group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    { name: 'ì„±ê³¼ CTR(%)', key: 'actualCtr', type: 'percent', placeholder: 'ì„±ê³¼CTR', width: 'w-24', calculated: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    
                    { name: 'ì¡°íšŒìˆ˜', key: 'view', type: 'number', placeholder: 'íšŸìˆ˜', width: 'w-20', isLargeNumber: true, group: 'ì¡°íšŒ ì„±ê³¼ (CPV)' }, 
                    { name: 'ëª©í‘œ CPV(ì›)', key: 'targetCpv', type: 'currency', placeholder: 'ëª©í‘œCPV', width: 'w-24', isLargeNumber: true, group: 'ì¡°íšŒ ì„±ê³¼ (CPV)' },
                    { name: 'ì„±ê³¼ CPV(ì›)', key: 'actualCpv', type: 'currency', placeholder: 'ì„±ê³¼CPV', width: 'w-24', calculated: true, group: 'ì¡°íšŒ ì„±ê³¼ (CPV)' },
                ],
            },
            'PERF': {
                label: 'í¼í¬ë¨¼ìŠ¤ ìº í˜ì¸',
                // Define the Level 1 Header Groups
                headerGroups: [
                    { name: 'ê¸°ë³¸ ì •ë³´', cols: ['media', 'placement', 'creativeName', 'cost', 'imp'] },
                    { name: 'ë…¸ì¶œ ì„±ê³¼ (CPM)', cols: ['targetCpm', 'actualCpm'] },
                    { name: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)', cols: ['click', 'targetCpc', 'actualCpc', 'targetCtr', 'actualCtr'] },
                    { name: 'ì „í™˜ ì„±ê³¼ (CPA)', cols: ['conv', 'targetCpa', 'actualCpa', 'revenue'] }, // PERF-specific
                ],
                // Define the Level 2 Columns
                cols: [
                    { name: 'ë§¤ì²´', key: 'media', type: 'text', placeholder: 'ë§¤ì²´', width: 'w-24', group: 'ê¸°ë³¸ ì •ë³´' },
                    { name: 'ìƒí’ˆ', key: 'placement', type: 'text', placeholder: 'ìƒí’ˆ', width: 'w-24', group: 'ê¸°ë³¸ ì •ë³´' },
                    { name: 'ì†Œì¬ëª…', key: 'creativeName', type: 'text', placeholder: 'ì†Œì¬ëª…', width: 'w-24', group: 'ê¸°ë³¸ ì •ë³´' },
                    { name: 'ê´‘ê³ ë¹„(ì›)', key: 'cost', type: 'number', placeholder: 'ê¸ˆì•¡', width: 'w-24', isLargeNumber: true, group: 'ê¸°ë³¸ ì •ë³´' }, // ë¼ë²¨ ë³€ê²½
                    { name: 'ë…¸ì¶œìˆ˜', key: 'imp', type: 'number', placeholder: 'íšŸìˆ˜', width: 'w-20', isLargeNumber: true, group: 'ê¸°ë³¸ ì •ë³´' }, 
                    
                    // ëª©í‘œ CPM, CPC, CPAì— isLargeNumber: true ì ìš© (ìš”ì²­ ì‚¬í•­ ë°˜ì˜)
                    { name: 'ëª©í‘œ CPM(ì›)', key: 'targetCpm', type: 'currency', placeholder: 'ëª©í‘œCPM', width: 'w-24', isLargeNumber: true, group: 'ë…¸ì¶œ ì„±ê³¼ (CPM)' },
                    { name: 'ì„±ê³¼ CPM(ì›)', key: 'actualCpm', type: 'currency', placeholder: 'ì„±ê³¼CPM', width: 'w-24', calculated: true, group: 'ë…¸ì¶œ ì„±ê³¼ (CPM)' },
                    
                    { name: 'í´ë¦­ìˆ˜', key: 'click', type: 'number', placeholder: 'íšŸìˆ˜', width: 'w-20', isLargeNumber: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' }, 
                    { name: 'ëª©í‘œ CPC(ì›)', key: 'targetCpc', type: 'currency', placeholder: 'ëª©í‘œCPC', width: 'w-24', isLargeNumber: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    { name: 'ì„±ê³¼ CPC(ì›)', key: 'actualCpc', type: 'currency', placeholder: 'ì„±ê³¼CPC', width: 'w-24', calculated: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    { name: 'ëª©í‘œ CTR(%)', key: 'targetCtr', type: 'percent', placeholder: 'ëª©í‘œCTR', width: 'w-24', group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    { name: 'ì„±ê³¼ CTR(%)', key: 'actualCtr', type: 'percent', placeholder: 'ì„±ê³¼CTR', width: 'w-24', calculated: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    
                    { name: 'ì „í™˜ìˆ˜', key: 'conv', type: 'number', placeholder: 'íšŸìˆ˜', width: 'w-20', isLargeNumber: true, group: 'ì „í™˜ ì„±ê³¼ (CPA)' }, 
                    { name: 'ëª©í‘œ CPA(ì›)', key: 'targetCpa', type: 'currency', placeholder: 'ëª©í‘œCPA', width: 'w-24', isLargeNumber: true, group: 'ì „í™˜ ì„±ê³¼ (CPA)' },
                    { name: 'ì„±ê³¼ CPA(ì›)', key: 'actualCpa', type: 'currency', placeholder: 'ì„±ê³¼CPA', width: 'w-24', calculated: true, group: 'ì „í™˜ ì„±ê³¼ (CPA)' },
                    { name: 'êµ¬ë§¤/ê°€ì…ì•¡(ì›)', key: 'revenue', type: 'currency', placeholder: 'ê¸ˆì•¡', width: 'w-24', isLargeNumber: true, group: 'ì „í™˜ ì„±ê³¼ (CPA)' }, 
                ],
            }
        };
        /**
         * Converts core campaign data into the structure required for the validation input table.
         * Takes the first 4 items and initializes them with core performance metrics and mock targets.
         */
        // *** AI UPLOAD: (REVERT) `data` íŒŒë¼ë¯¸í„° ì œê±° ***
        const mapCampaignDataToValidation = (sourceData, campaignType) => {
            
            // *** AI UPLOAD: (REVERT) dataToMapì´ sourceData.slice(0, 4)ê°€ ë˜ë„ë¡ ìˆ˜ì • ***
            const dataToMap = sourceData; 
            const configCols = validationTableConfigs[campaignType].cols;
            
            return dataToMap.map((sourceItem) => {
                const row = { id: crypto.randomUUID() };
                
                // *** ìˆ˜ì •: (1) isPrefill í”Œë˜ê·¸ ì¶”ê°€ ***
                // sourceItem.mediaê°€ ì¡´ì¬í•˜ë©´ (ì¦‰, {}ê°€ ì•„ë‹ˆë©´) prefillë¡œ ê°„ì£¼
                // *** AI UPLOAD: (REVERT) AIë¡œ ì±„ì›Œì§„ ë°ì´í„°ëŠ” isPrefill: false ***
                row.isPrefill = !!sourceItem.media; 
                
                configCols.forEach(col => {
                    row[col.key] = null; // Initialize all fields to null
                });
                
                // --- Core Metric Mapping (DA/PERF Common) ---
                // *** ìˆ˜ì •: (3) sourceItemì´ ì—†ì„ ê²½ìš°(ìƒˆ í–‰) media, creative, placementë¥¼ nullë¡œ ì„¤ì • ***
                row.media = sourceItem.media || null;
                // *** ìˆ˜ì •: 'undefined' ë²„ê·¸ ë°©ì§€ ***
                const parts = sourceItem.creative ? String(sourceItem.creative).split('_') : [null, null];
                // *** AI UPLOAD: (REVERT) AIê°€ creativeName, placementë¥¼ ì§ì ‘ ì¤„ ìˆ˜ ìˆìŒ ***
                row.creativeName = parts[0]; 
                row.placement = parts[1]; 
                
                // Raw Performance Data
                // *** ìˆ˜ì •: (2) 'undefined' ë²„ê·¸ ìˆ˜ì • (|| null ì¶”ê°€) ***
                row.cost = sourceItem.cost || null;
                row.imp = sourceItem.imp || null;
                row.click = sourceItem.click || null;
                
                // --- Campaign Specific Mapping & Defaults ---
                if (campaignType === 'DA') {
                    
                    // *** AI UPLOAD: (REVERT) AIê°€ ê°’ì„ ì£¼ë©´(isPrefill=false) ê·¸ ê°’ì„ ì‚¬ìš© ***
                    if (row.isPrefill) {
                         if (sourceItem.media === 'ë„¤ì´ë²„') {
                            row.targetCpm = 2000;
                            row.targetCpc = 740;
                            row.targetCtr = 0.0020; // 0.20%
                        } else if (sourceItem.media === 'ì¹´ì¹´ì˜¤') {
                            row.targetCpm = 900;
                            row.targetCpc = 400;
                            row.targetCtr = 0.0025; // 0.25%
                        } else if (sourceItem.media === 'êµ¬ê¸€') {
                            row.targetCpm = 5000;
                            row.targetCpc = 2000;
                            row.targetCtr = 0.0040; // 0.40%
                        } else if (sourceItem.media === 'ë²„ì¦ˆë¹Œ') {
                            row.targetCpm = null;
                            row.targetCpc = null;
                            row.targetCtr = null;
                        } else {
                            row.targetCpm = null; 
                            row.targetCpc = null;
                            row.targetCtr = null;
                        }
                    } else {
                        // AIê°€ ì±„ìš´ ê°’ (ë˜ëŠ” ìƒˆ í–‰)
                        row.targetCpm = sourceItem.targetCpm || null;
                        row.targetCpc = sourceItem.targetCpc || null;
                        row.targetCtr = sourceItem.targetCtr || null;
                    }
                    
                    // *** ìˆ˜ì •: (5) ë²„ì¦ˆë¹Œ ë° ìƒˆ í–‰ì˜ targetCpv, view nullë¡œ ì„¤ì • ***
                    // *** AI UPLOAD: (REVERT) AIê°€ ê°’ì„ ì£¼ë©´(isPrefill=false) ê·¸ ê°’ì„ ì‚¬ìš© ***
                    if (row.isPrefill && sourceItem.media === 'ë²„ì¦ˆë¹Œ') { 
                        row.targetCpv = null;
                        row.view = null;
                    } else if (row.isPrefill) {
                        // ë„¤ì´ë²„, ì¹´ì¹´ì˜¤, êµ¬ê¸€ì€ ê¸°ì¡´ ë¡œì§ ìœ ì§€
                        row.targetCpv = 100; 
                        row.view = (sourceItem.imp !== null) ? Math.round(sourceItem.imp / 50) : null; 
                    } else {
                        // AIê°€ ì±„ìš´ ê°’ (ë˜ëŠ” ìƒˆ í–‰)
                        row.targetCpv = sourceItem.targetCpv || null;
                        row.view = sourceItem.view || null;
                    }
                    
                } else if (campaignType === 'PERF') {
                    // *** ìˆ˜ì •: (2) 'undefined' ë²„ê·¸ ìˆ˜ì • (|| null ì¶”ê°€) ***
                    row.conv = sourceItem.conv || null;
                    row.revenue = sourceItem.revenue || null;
                    
                    // (PERF ìº í˜ì¸ë„ ìƒˆ í–‰ì¼ ê²½ìš° nullë¡œ ì„¤ì •)
                    if (row.isPrefill) {
                        row.targetCpm = 5000; 
                        row.targetCpa = 25000;
                        row.targetCpc = 2000;
                        row.targetCtr = 0.01;
                    } else {
                        // *** AI UPLOAD: (REVERT) AIê°€ ì±„ìš´ ê°’ (ë˜ëŠ” ìƒˆ í–‰) ***
                        row.targetCpm = sourceItem.targetCpm || null; 
                        row.targetCpa = sourceItem.targetCpa || null;
                        row.targetCpc = sourceItem.targetCpc || null;
                        row.targetCtr = sourceItem.targetCtr || null;
                    }
                }
                
                return row;
            });
        };
        // 1. Generate Prefilled Data
        const prefillDaData = mapCampaignDataToValidation(campaignData.DA.data, 'DA');
        const prefillPerfData = mapCampaignDataToValidation(campaignData.PERF.data, 'PERF');
        // 2. Initialize validationData with the prefilled rows (4 rows for each)
        let isValidationTableOpen = true; 
        // *** (LocalStorage) NEW: ê¸°ë³¸ê°’ì„ mock ë°ì´í„°ë¡œ ì„¤ì • ***
        const defaultValidationData = { 
            'DA': mapCampaignDataToValidation(campaignData.DA.data, 'DA'), 
            'PERF': mapCampaignDataToValidation(campaignData.PERF.data, 'PERF')
        };
        let validationData = { ...defaultValidationData };
        
        // --- NEW Element references ---
        const runAnalysisButton = document.getElementById('run-analysis-button');
        const analysisResults = document.getElementById('analysis-results'); 
        const validationTableContent = document.getElementById('validation-table-content');
        const toggleValidationTableButton = document.getElementById('toggle-validation-table');
        const validationTableHeader = document.getElementById('validation-table-header');
        const validationTableBody = document.getElementById('validation-table-body');
        const validationCampaignLabel = document.getElementById('validation-campaign-label');
        const addValidationRowButton = document.getElementById('add-validation-row');
        // *** (LocalStorage) NEW: ë²„íŠ¼ DOM ìš”ì†Œ ***
        const saveDataButton = document.getElementById('save-data-button');
        const resetDataButton = document.getElementById('reset-data-button');
        
        function toggleValidationTable() {
            isValidationTableOpen = !isValidationTableOpen;
            const toggleIcon = document.getElementById('toggle-icon');
            const toggleText = document.getElementById('toggle-text');
            if (isValidationTableOpen) {
                validationTableContent.classList.remove('hidden');
                toggleText.textContent = 'ì…ë ¥ í…Œì´ë¸” ì ‘ê¸°';
                toggleIcon.classList.add('rotate-180');
            } else {
                validationTableContent.classList.add('hidden');
                toggleText.textContent = 'ì…ë ¥ í…Œì´ë¸” ì—´ê¸°';
                toggleIcon.classList.remove('rotate-180');
            }
        }
        
        // *** AI UPLOAD: ì—ëŸ¬ ëª¨ë‹¬ í‘œì‹œ (REMOVED) ***
        
        /**
         * Calculates actual performance metrics (CPM, CPC, CTR, CPV, CPA) for a given row.
         */
        function calculateValidationMetrics(row, campaignType) {
            // Note: cost, imp, click, view, conv are stored as actual numbers (not strings with commas)
            const { cost, imp, click, view, conv } = row;
            // Helper to handle division by zero or invalid input
            const safeDivide = (numerator, denominator) => {
                // Ensure numerator and denominator are valid positive numbers before division
                if (typeof numerator !== 'number' || typeof denominator !== 'number' || denominator <= 0 || isNaN(numerator) || isNaN(denominator) || numerator === null || denominator === null) {
                    return null;
                }
                return numerator / denominator;
            };
            // Common metrics
            // CPM = (Cost / Imp) * 1000
            row.actualCpm = safeDivide(cost, imp) !== null ? safeDivide(cost, imp) * 1000 : null;
            // CPC = Cost / Click
            row.actualCpc = safeDivide(cost, click);
            // CTR = Click / Imp (Stored as fraction, e.g., 0.005)
            row.actualCtr = safeDivide(click, imp); 
            if (campaignType === 'DA') {
                // CPV = Cost / View
                row.actualCpv = safeDivide(cost, view);
                row.actualCpa = null; 
            } else if (campaignType === 'PERF') {
                // CPA = Cost / Conversion
                row.actualCpa = safeDivide(cost, conv);
                row.actualCpv = null; 
            }
        }
        /**
         * Updates only the calculated columns in the DOM without destroying input focus.
         * @param {string} rowId - The unique ID of the row.
         * @param {object} rowData - The data object for the row.
         */
        function updateCalculatedColumnsInDOM(rowId, rowData) {
            // Find the table row element using the data-row-id attribute
            const rowElement = document.querySelector(`#validation-table-body tr[data-row-id="${rowId}"]`);
            if (!rowElement) return;
            const config = validationTableConfigs[currentCampaign];
            
            // Iterate through columns to find calculated fields
            config.cols.forEach((col, colIndex) => {
                if (col.calculated) {
                    // Find the TD based on the column index (colIndex). This relies on the order being consistent.
                    const td = rowElement.children[colIndex]; 
                    if (!td) return; // (ì˜¤ë¥˜ ë°©ì§€)
                    const inputElement = td.querySelector('input');
                    if (!inputElement) return;
                    const rawValue = rowData[col.key];
                    let displayValue = '-';
                    
                    if (rawValue !== null) {
                        if (col.type === 'currency') {
                            displayValue = formatNumber(Math.round(rawValue), 'currency').replace('ì›', ''); 
                        } else if (col.type === 'percent') {
                            displayValue = `${(rawValue * 100).toFixed(2)}%`; 
                        } else {
                            displayValue = rawValue.toFixed(2);
                        }
                    }
                    // Update the input field value
                    inputElement.value = displayValue;
                }
            });
        }
        function handleValidationInputChange(rowId, key, event) {
            const index = validationData[currentCampaign].findIndex(r => r.id === rowId);
            if (index > -1) {
                const config = validationTableConfigs[currentCampaign].cols.find(c => c.key === key);
                if (!config) return; // (ì˜¤ë¥˜ ë°©ì§€)
                let inputValue = event.target.value;
                let rawValueToStore = inputValue; 
                
                // --- Input Parsing and Storage ---
                if (config.isLargeNumber) {
                    const originalCursorPos = event.target.selectionStart;
                    const originalValue = event.target.value; 
                    
                    const cleanValue = inputValue.replace(/[^\d]/g, ''); 
                    
                    const originalValuePrefix = originalValue.substring(0, originalCursorPos);
                    const cleanPrefix = originalValuePrefix.replace(/[^\d]/g, '');
                    
                    const formattedValue = formatNumericInput(cleanValue);
                    event.target.value = formattedValue;
                    
                    let newCursorPos = 0;
                    let digitCount = 0;
                    
                    for (let i = 0; i < formattedValue.length; i++) {
                        if (digitCount === cleanPrefix.length) {
                            newCursorPos = i;
                            break;
                        }
                        if (/\d/.test(formattedValue[i])) {
                            digitCount++;
                        }
                        newCursorPos = i + 1;
                    }
                    
                    setTimeout(() => event.target.setSelectionRange(newCursorPos, newCursorPos), 0);
                    
                    rawValueToStore = cleanValue === '' ? null : parseInt(cleanValue, 10);
                } else if (config.type === 'number' || config.type === 'currency' || config.type === 'percent') {
                    // For other numeric fields, allow decimals
                    // *** ìˆ˜ì •: (4) % ê¸°í˜¸ ì œê±° ***
                    const cleanValue = inputValue.replace(/[^\d.]/g, ''); 
                    rawValueToStore = cleanValue === '' || cleanValue === '.' ? null : parseFloat(cleanValue);
                    
                    // Convert displayed percentage back to fraction for internal storage if it's a target CTR
                    if (key.includes('targetCtr') && rawValueToStore !== null) {
                        rawValueToStore = rawValueToStore / 100;
                    }
                } else if (config.type === 'text') {
                    rawValueToStore = inputValue;
                }
                
                // Update the stored data with the cleaned/parsed value
                validationData[currentCampaign][index][key] = rawValueToStore;
                
                // --- Targeted Calculation and DOM Update ---
                const baseMetrics = ['cost', 'imp', 'click', 'view', 'conv', 'revenue'];
                
                // Recalculate and update calculated fields if a base metric changes
                if (baseMetrics.includes(key)) {
                    calculateValidationMetrics(validationData[currentCampaign][index], currentCampaign);
                    updateCalculatedColumnsInDOM(rowId, validationData[currentCampaign][index]);
                }
                
                // *** (LocalStorage) REMOVED: Auto-save on input ***
            }
        }
        
        function addValidationRow() {
            // Get an empty row template, using the current campaign type
            const row = mapCampaignDataToValidation([{}], currentCampaign)[0];
            validationData[currentCampaign].push(row);
            
            // *** (LocalStorage) REMOVED: Auto-save on add ***
            renderValidationTable();
        }
        function removeValidationRow(rowId) {
            validationData[currentCampaign] = validationData[currentCampaign].filter(r => r.id !== rowId);
            if (validationData[currentCampaign].length === 0) {
                 // Ensure at least one row exists
                 validationData[currentCampaign].push(mapCampaignDataToValidation([{}], currentCampaign)[0]);
            }
            
            // *** (LocalStorage) REMOVED: Auto-save on remove ***
            
            // Re-render the table and re-run analysis
            renderValidationTable();
            runAnalysis();
        }
        /**
         * Renders the validation input table with 2-level headers.
         */
        function renderValidationTable() {
            const config = validationTableConfigs[currentCampaign];
            validationCampaignLabel.textContent = config.label;
            
            validationTableHeader.innerHTML = '';
            
            // --- 1. Render Level 1 Header (Groups) ---
            const trGroup = document.createElement('tr');
            trGroup.className = 'bg-gray-200 border-b-2 border-gray-300';
            
            // Generate Group Headers (Level 1)
            config.headerGroups.forEach(group => {
                const th = document.createElement('th');
                th.className = 'px-2 py-2 text-xs font-bold text-gray-700 uppercase tracking-wider sticky top-0 bg-gray-300';
                th.textContent = group.name;
                th.colSpan = group.cols.length; // Span across all columns in this group
                trGroup.appendChild(th);
            });
            
            // Last column (Action column - 'ì‚­ì œ') spans two rows
            const thDeleteTop = document.createElement('th');
            thDeleteTop.className = 'px-1 py-2 text-xs font-bold text-gray-700 sticky top-0 bg-gray-300 w-10';
            thDeleteTop.textContent = 'ì‚­ì œ';
            thDeleteTop.rowSpan = 2; // Spans both header rows
            trGroup.appendChild(thDeleteTop);
            validationTableHeader.appendChild(trGroup);
            // --- 2. Render Level 2 Header (Details) ---
            const trDetail = document.createElement('tr');
            trDetail.className = 'bg-gray-100 border-b border-gray-200';
            
            // Generate Detail Headers (Level 2)
            config.cols.forEach(col => {
                const th = document.createElement('th');
                th.className = `px-2 py-2 text-xs font-semibold text-gray-700 uppercase tracking-wider sticky top-0 border-r border-gray-200 ${col.width || 'w-24'}`;
                
                // ìˆ˜ì •: 'ê´‘ê³ ë¹„(ì›)'ì— (ì†Œì§„ ê¸ˆì•¡) ì¶”ê°€
                if (col.key === 'cost') {
                    th.innerHTML = `${col.name} <span class="header-subtext">(ì†Œì§„ ê¸ˆì•¡)</span>`;
                } else {
                    th.textContent = col.name;
                }
                
                trDetail.appendChild(th);
            });
            
            validationTableHeader.appendChild(trDetail);
            
            
            // --- 3. Render Body ---
            validationTableBody.innerHTML = '';
            validationData[currentCampaign].forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors'; // Changed hover color to gray for input section
                tr.dataset.rowId = row.id; 
                
                config.cols.forEach(col => {
                    const td = document.createElement('td');
                    td.className = 'p-1 text-xs whitespace-nowrap border-r border-gray-100';
                    
                    let rawValue = row[col.key];
                    let displayValue = rawValue === null ? '' : rawValue;
                    
                    const isCalculated = col.calculated;
                    if (isCalculated) {
                        // Calculated fields: Read-only, centered, specific styling
                        if (rawValue !== null) {
                            if (col.type === 'currency') {
                                // Round to nearest won and format for display
                                displayValue = formatNumber(Math.round(rawValue), 'currency').replace('ì›', '');
                            } else if (col.type === 'percent') {
                                displayValue = `${(rawValue * 100).toFixed(2)}%`; 
                            } else {
                                displayValue = rawValue.toFixed(2);
                            }
                        } else {
                            displayValue = '-';
                        }
                        
                        const inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        inputElement.readOnly = true;
                        inputElement.className = 'w-full p-1 border rounded-md text-xs bg-indigo-50 font-semibold text-indigo-700 pointer-events-none text-center'; 
                        inputElement.value = displayValue;
                        td.appendChild(inputElement);
                    } else {
                        // Regular input (text/number/currency/percent)
                        const inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        // *** ìˆ˜ì •: (3) placeholderë¥¼ col.placeholderì—ì„œ ê°€ì ¸ì˜¤ë„ë¡ ìˆ˜ì • ***
                        inputElement.placeholder = col.placeholder;
                        // *** ìˆ˜ì •: (1) data-key ì¶”ê°€ ***
                        inputElement.dataset.key = col.key;
                        
                        // Base classes
                        let inputClasses = `w-full p-1 border rounded-md text-xs focus:ring-indigo-500 focus:border-indigo-500 ${col.type === 'number' || col.type === 'currency' || col.type === 'percent' || col.isLargeNumber ? 'text-right' : 'text-left'}`;
                        
                        // Display the formatted number in the input field
                        if (col.isLargeNumber && typeof rawValue === 'number') {
                            displayValue = formatNumericInput(rawValue);
                        } else if (col.type === 'percent' && typeof rawValue === 'number') {
                            // *** ìˆ˜ì •: (4) ëª©í‘œ CTR(%)ì—ë„ % ê¸°í˜¸ ì¶”ê°€ ***
                            displayValue = `${(rawValue * 100).toFixed(2).replace(/\.00$/, '')}%`;
                        } else if ((col.type === 'currency' || col.type === 'number') && typeof rawValue === 'number') {
                            displayValue = rawValue;
                        } else {
                            displayValue = displayValue; // text or null
                        }
                        
                        // *** ìˆ˜ì •: (1) isPrefill ê°’ì— ë”°ë¼ prefill í´ë˜ìŠ¤ ì ìš© ***
                        // *** AI UPLOAD: (REVERT) isPrefillActiveê°€ falseì—¬ë„, row.isPrefillì´ trueë©´ íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œ ***
                        // *** (LocalStorage) NEW: isPrefillActiveëŠ” ë¡œë“œ ì‹œ ì„¤ì •ë¨ ***
                        if (isPrefillActive && row.isPrefill && (displayValue || displayValue === 0)) { // 0ë„ í‘œì‹œ
                            inputClasses += ' input-prefill';
                        }
                        inputElement.className = inputClasses;
                        inputElement.value = displayValue;
                        
                        // Store the default display value for placeholder logic
                        inputElement.dataset.defaultValue = displayValue;

                        // *** (Problem 1) ON FOCUS: ë¡œì§ ìˆ˜ì • ***
                        inputElement.addEventListener('focus', (e) => {
                            const clickedRowId = row.id;
                            const clickedKey = col.key;

                            // (1) ì „ì—­ ì´ˆê¸°í™” (ìµœì´ˆ 1íšŒ)
                            if (isPrefillActive) {
                                isPrefillActive = false; // í”Œë˜ê·¸ ë¹„í™œì„±í™”
                                
                                // (1.1) ë°ì´í„° ëª¨ë¸(validationData)ì„ ë¨¼ì € ì „ì²´ ì´ˆê¸°í™”
                                validationData[currentCampaign].forEach(dataRow => {
                                    // (1.2) ëª¨ë“  í–‰ì˜ ì„±ê³¼ ì§€í‘œ ì´ˆê¸°í™”
                                    dataRow.actualCpm = null;
                                    dataRow.actualCpc = null;
                                    dataRow.actualCtr = null;
                                    dataRow.actualCpv = null;
                                    dataRow.actualCpa = null;
                                    
                                    if (dataRow.isPrefill) { // prefill í–‰ë§Œ
                                        dataRow.isPrefill = false; // ìƒíƒœ ë³€ê²½
                                        
                                        // (1.3) ëª¨ë“  'ê¸°ì¬' ë°ì´í„° nullë¡œ ë³€ê²½
                                        config.cols.forEach(c => {
                                            if (!c.calculated) {
                                                dataRow[c.key] = null; 
                                            }
                                        });
                                    }
                                });

                                // (1.4) DOMì„ ìˆ˜ë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (renderValidationTable() í˜¸ì¶œ ì•ˆí•¨)
                                
                                // (1.4.1) ëª¨ë“  'ê¸°ì¬ í•­ëª©' inputì„ ì°¾ì•„ì„œ
                                const allInputs = validationTableBody.querySelectorAll('input:not([readonly])');
                                allInputs.forEach(input => {
                                    input.value = ''; // ê°’ì„ ë¹„ì›€
                                    input.classList.remove('input-prefill'); // íšŒìƒ‰ ê¸€ì”¨ ì œê±°
                                });

                                // (1.4.2) ëª¨ë“  'ì„±ê³¼' input (readonly)ì„ ì°¾ì•„ì„œ
                                const allCalculatedInputs = validationTableBody.querySelectorAll('input[readonly]');
                                allCalculatedInputs.forEach(input => {
                                    input.value = '-'; // '-'ë¡œ ì´ˆê¸°í™”
                                });
                                
                                // (1.4.3) e.target (ì§€ê¸ˆ í´ë¦­í•œ input)ì€ ì´ë¯¸ allInputsì—ì„œ
                                // .value = ''ê°€ ë˜ì—ˆìœ¼ë¯€ë¡œ, ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ focusë¥¼ ìœ ì§€í•¨.
                                
                                // *** (LocalStorage) NEW: Save the cleared prefill state ***
                                // saveDataToLocalStorage(); // (save on click is disabled)
                                
                                return; // ì „ì—­ ì´ˆê¸°í™” ì‹¤í–‰ í›„ í•¨ìˆ˜ ì¢…ë£Œ
                            }
                            
                            // *** (Problem 1) ìˆ˜ì •: 'ì„±ê³¼' ì´ˆê¸°í™” ë¡œì§ ì‚­ì œ ***
                            // (2) ì „ì—­ ì´ˆê¸°í™”ê°€ ëë‚œ í›„ì˜ ì¼ë°˜ í¬ì»¤ìŠ¤ ë¡œì§
                            // (focus ì´ë²¤íŠ¸ëŠ” ì´ì œ prefill ì œê±°ë§Œ ë‹´ë‹¹)
                            e.target.classList.remove('input-prefill');
                        });

                        // *** (ì˜¤ë¥˜ ìˆ˜ì •) ON BLUR: ë¡œì§ ìˆ˜ì • ***
                        inputElement.addEventListener('blur', (e) => {
                            // 1. Save the final value
                            handleValidationInputChange(row.id, col.key, e);
                            
                            const index = validationData[currentCampaign].findIndex(r => r.id === row.id);
                            if (index === -1) return;
                            const rawValue = validationData[currentCampaign][index][col.key];

                            // 2. Re-format % if needed
                            if (col.type === 'percent' && typeof rawValue === 'number' && !e.target.value.includes('%')) {
                                e.target.value = `${(rawValue * 100).toFixed(2).replace(/\.00$/, '')}%`;
                            }
                        });

                        // *** (ì˜¤ë¥˜ ìˆ˜ì •) ON INPUT: handleValidationInputChangeë§Œ í˜¸ì¶œ ***
                        inputElement.addEventListener('input', (e) => {
                            e.target.classList.remove('input-prefill');
                            handleValidationInputChange(row.id, col.key, e);
                        });
                        
                        td.appendChild(inputElement);
                    }
                    tr.appendChild(td);
                });
                
                // Action column
                const actionTd = document.createElement('td');
                actionTd.className = 'p-1 text-center';
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'X';
                deleteButton.className = 'text-red-500 hover:text-red-700 font-bold text-sm transition-colors p-1';
                deleteButton.addEventListener('click', () => removeValidationRow(row.id));
                actionTd.appendChild(deleteButton);
                tr.appendChild(actionTd);
                validationTableBody.appendChild(tr);
            });
        }
        // --- END Validation Table Logic ---
        
        // --- NEW: 5-Point Scale Scoring Functions ---
        
        /**
         * Aì ìˆ˜: ëª©í‘œ CPM ê¸°ì¤€ 5ì  ì²™ë„í™” (Lower is Better)
         */
        // *** [STEP 1] ìˆ˜ì •: ì—‘ì…€ íŒŒì¼ ê¸°ì¤€ (ë³€ê²½ ì—†ìŒ) ***
        const getScoreCpm = (actualCpm, targetCpm) => {
            if (actualCpm === null || targetCpm === null || targetCpm <= 0) return 1; // ë°ì´í„° ì—†ìœ¼ë©´ 1ì 
            const ratio = actualCpm / targetCpm;
            
            if (ratio < 0.8) return 5;  // 80% ë¯¸ë§Œ
            if (ratio < 1.0) return 4;  // 100% ë¯¸ë§Œ
            if (ratio < 1.3) return 3;  // 130% ë¯¸ë§Œ
            if (ratio < 1.6) return 2;  // 160% ë¯¸ë§Œ
            return 1; // 160% ì´ˆê³¼ (ì´ìƒ)
        };
        /**
         * Bì ìˆ˜(1): ëª©í‘œ CTR ê¸°ì¤€ 5ì  ì²™ë„í™” (Higher is Better)
         */
        // *** [STEP 1] ìˆ˜ì •: ì—‘ì…€ íŒŒì¼ ê¸°ì¤€ (ë¡œì§ ë³€ê²½) ***
        const getScoreCtr = (actualCtr, targetCtr) => {
            if (actualCtr === null || targetCtr === null || targetCtr <= 0) return 1;
            const ratio = actualCtr / targetCtr;
            
            // ì—‘ì…€ íŒŒì¼ì˜ "ìˆ˜ì •ì™„ë£Œ" ì‹œíŠ¸ ê¸°ì¤€
            if (ratio > 1.3) return 5;  // 130% ì´ˆê³¼
            if (ratio > 1.1) return 4;  // 110% ì´ˆê³¼
            if (ratio > 1.0) return 3;  // 100% ì´ˆê³¼
            if (ratio > 0.5) return 2;  // 50% ì´ˆê³¼
            return 1; // 50% ì´í•˜
        };
        /**
         * Bì ìˆ˜(2): ëª©í‘œ CPC ê¸°ì¤€ 5ì  ì²™ë„í™” (Lower is Better)
         */
        // *** [STEP 1] ìˆ˜ì •: ì—‘ì…€ íŒŒì¼ ê¸°ì¤€ (ë¡œì§ ë³€ê²½) ***
        const getScoreCpc = (actualCpc, targetCpc) => {
            if (actualCpc === null || targetCpc === null || targetCpc <= 0) return 1;
            const ratio = actualCpc / targetCpc;
            
            // ì—‘ì…€ íŒŒì¼ì˜ "ìˆ˜ì •ì™„ë£Œ" ì‹œíŠ¸ ê¸°ì¤€
            if (ratio < 0.85) return 5;  // 85% ë¯¸ë§Œ
            if (ratio < 0.95) return 4;  // 95% ë¯¸ë§Œ
            if (ratio < 1.04) return 3;  // 104% ë¯¸ë§Œ
            if (ratio < 1.4) return 2;  // 140% ë¯¸ë§Œ
            return 1; // 140% ì´ìƒ
        };
        
        /**
         * [INSIGHT] 16ê°œ ì¡°ê±´ ì—‘ì…€ ìˆ˜ì‹
         * @returns {object} { grade: string, text: string }
         */
        // *** [STEP 1] ìˆ˜ì •: ì—‘ì…€ íŒŒì¼ ê¸°ì¤€ (ë¡œì§ ë³€ê²½) ***
        const getDaInsight = (scoreA, scoreB) => {
            // V8 = scoreA, W8 = scoreB
            if (scoreA >= 4 && scoreB >= 4) return { grade: "Top ì†Œì¬", text: "ë…¸ì¶œì´ ë§¤ìš° ì›í™œí•˜ê³ , ì†Œì¬ ê´€ì‹¬ë„ë„ ë§¤ìš° ë†’ì•„ íƒ€ê²ŸíŒ…ê³¼ ë©”ì‹œì§€ íš¨ê³¼ì ì¸ ì†Œì¬" };
            if (scoreA >= 4 && scoreB >= 3) return { grade: "Top ì†Œì¬", text: "ë…¸ì¶œì´ ë§¤ìš° ì›í™œí•˜ê³ , ì†Œì¬ ê´€ì‹¬ì€ ìš°ìˆ˜í•œ í¸ì´ë¯€ë¡œ ì¢€ ë” ë²”ìš©ì ì¸ ì†Œì¬ë¡œ ê°œì„  í•„ìš”" };
            if (scoreA >= 4 && scoreB >= 1.5) return { grade: "Mid ì†Œì¬", text: "ë…¸ì¶œì€ ë§¤ìš° ì›í• í•˜ì§€ë§Œ, ì†Œì¬ ê´€ì‹¬ì´ ë‚®ì€ í¸ìœ¼ë¡œ í›…í‚¹ì„±ì„ ë†’ì¸ ì†Œì¬ë¡œ ìˆ˜ì • í•„ìš”" };
            if (scoreA >= 4 && scoreB >= 0) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œì€ ë§¤ìš° ì›í™œí•˜ì§€ë§Œ ê·¹ì†Œìˆ˜ì˜ ì§‘ë‹¨ì—ì„œ ë°˜ì‘ì´ ë°œìƒí•¨ìœ¼ë¡œ ì†Œì¬ í›…í‚¹ì„± ì¦ëŒ€ í•„ìš”" };
            
            if (scoreA >= 3 && scoreB >= 4) return { grade: "Top ì†Œì¬", text: "ë…¸ì¶œì´ ì ì ˆí•˜ë©°, ì†Œì¬ ê´€ì‹¬ì´ ë§¤ìš° ë†’ì•„ ë©”ì‹œì§€ íš¨ê³¼ì„±ì´ ë†’ì€ ì†Œì¬" };
            if (scoreA >= 3 && scoreB >= 3) return { grade: "Topì†Œì¬", text: "ë…¸ì¶œì´ ì ì ˆí•˜ê³ , ì†Œì¬ ê´€ì‹¬ë„ ë™ë°˜ë˜ì–´ ìš°ìˆ˜í•œ ì†Œì¬" };
            if (scoreA >= 3 && scoreB >= 1.5) return { grade: "Mid ì†Œì¬", text: "ë…¸ì¶œì€ ì ì ˆí•˜ì§€ë§Œ ì†Œì¬ ê´€ì‹¬ì´ ë‚®ì€ í¸ìœ¼ë¡œ íƒ€ê²ŸíŒ… í™•ì¥ ë° ë²”ìš©ì ì¸ ì†Œì¬ë¡œ ê°œì„  í•„ìš”" };
            if (scoreA >= 3 && scoreB >= 0) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œì€ ì ì ˆí•˜ì§€ë§Œ ê´€ì‹¬ì´ ì €ì¡°í•˜ì—¬ ì†Œì¬ OFF ë° ì˜ˆì‚° ì´ê´€ ê³ ë ¤" };
            
            if (scoreA >= 1.5 && scoreB >= 4) return { grade: "Midì†Œì¬", text: "ì†Œì¬ ê´€ì‹¬ì´ ë§¤ìš° ë†’ì§€ë§Œ ë…¸ì¶œì´ ì›í™œí•˜ì§€ ì•ŠëŠ” ì†Œì¬ë¡œ íƒ€ê²ŸíŒ… ì¡°ì • ë° ì˜ˆì‚° ì¦ì•¡ìœ¼ë¡œ ë…¸ì¶œ ì¦ëŒ€ë°©ì•ˆ ê³ ë ¤" };
            if (scoreA >= 1.5 && scoreB >= 3) return { grade: "Lowì†Œì¬", text: "ì†Œì¬ í›…í‚¹ì„±ì€ ìˆì§€ë§Œ ë…¸ì¶œì´ ì›í™œí•˜ì§€ ì•ŠëŠ” ì†Œì¬ë¡œ íƒ€ê²ŸíŒ… í™•ì¥ í•„ìš”" };
            if (scoreA >= 1.5 && scoreB >= 1.5) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œê³¼ ì†Œì¬ ê´€ì‹¬ì´ ë‚®ì€ í¸ìœ¼ë¡œ ì†Œì¬ OFF ë° ì˜ˆì‚° ì´ê´€ ê³ ë ¤" };
            if (scoreA >= 1.5 && scoreB >= 0) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œê³¼ ì†Œì¬ ê´€ì‹¬ì´ ì €ì¡°í•˜ì—¬ ì†Œì¬ OFF ë° ì˜ˆì‚° ì´ê´€ ê³ ë ¤" };
            
            if (scoreA >= 0 && scoreB >= 4) return { grade: "Lowì†Œì¬", text: "ì†Œì¬ ê´€ì‹¬ì€ ë§¤ìš° ë†’ì§€ë§Œ ê·¹ì†Œìˆ˜ì˜ ì§‘ë‹¨ì—ë§Œ ë…¸ì¶œë˜ì–´ íƒ€ê²ŸíŒ… í™•ì¥ ë° ì˜ˆì‚° ì¦ì•¡ìœ¼ë¡œ ë…¸ì¶œ ì¦ëŒ€ë°©ì•ˆ ê³ ë ¤" };
            if (scoreA >= 0 && scoreB >= 3) return { grade: "Lowì†Œì¬", text: "ì†Œì¬ í›…í‚¹ì„±ì€ ìˆì§€ë§Œ ê·¹ì†Œìˆ˜ì˜ ì§‘ë‹¨ì—ë§Œ ë…¸ì¶œë˜ì–´ íƒ€ê²ŸíŒ… í™•ì¥ í•„ìš”" };
            if (scoreA >= 0 && scoreB >= 1.5) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œì´ ì €ì¡°í•˜ê³  ì†Œì¬ ê´€ì‹¬ì´ ë‚®ì€ í¸ìœ¼ë¡œ ì†Œì¬ OFF ë° ì˜ˆì‚° ì´ê´€ ê³ ë ¤" };
            if (scoreA >= 0 && scoreB >= 0) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œê³¼ ì†Œì¬ ê´€ì‹¬ì´ ì €ì¡°í•˜ì—¬ ì†Œì¬ OFF ë° ì˜ˆì‚° ì´ê´€ ê³ ë ¤" };
            
            return { grade: "ì˜¤ë¥˜", text: "ì ìˆ˜ ê³„ì‚° ì˜¤ë¥˜" };
        };
        
        // *** [STEP 1] ìˆ˜ì •: ì—‘ì…€ íŒŒì¼ ê¸°ì¤€ (ë¡œì§ ë³€ê²½) ***
        const getDaFeedback = (scoreA, scoreB) => {
            if (scoreA === null || scoreB === null) return ''; // ë°ì´í„° ì—†ìœ¼ë©´ ë¹ˆì¹¸
            
            // V8 = scoreA, W8 = scoreB
            if (scoreA >= 4 && scoreB >= 4) return "ìœ ì§€/ê°•í™”";
            if (scoreA >= 4 && scoreB >= 3) return "ë²”ìš©ì  ë©”ì‹œì§€ ê°•í™”";
            if (scoreA >= 4 && scoreB >= 1.5) return "í›…í‚¹ì„± ì¦ëŒ€";
            if (scoreA >= 4 && scoreB >= 0) return "í›…í‚¹ì„± ì¦ëŒ€";
            
            if (scoreA >= 3 && scoreB >= 4) return "ìœ ì§€/ê°•í™”";
            if (scoreA >= 3 && scoreB >= 3) return "ìœ ì§€/ê°•í™”";
            if (scoreA >= 3 && scoreB >= 1.5) return "íƒ€ê²ŸíŒ… í™•ì¥/ë²”ìš©ì  ë©”ì‹œì§€";
            if (scoreA >= 3 && scoreB >= 0) return "íƒ€ê²ŸíŒ… í™•ì¥+í›…í‚¹ì„± ì¦ëŒ€";
            
            if (scoreA >= 1.5 && scoreB >= 4) return "íƒ€ê²ŸíŒ… í™•ì¥+ì˜ˆì‚° ì¦ëŒ€";
            if (scoreA >= 1.5 && scoreB >= 3) return "íƒ€ê²ŸíŒ… ì¡°ì •";
            if (scoreA >= 1.5 && scoreB >= 1.5) return "ì˜ˆì‚°ì´ê´€";
            if (scoreA >= 1.5 && scoreB >= 0) return "ì˜ˆì‚°ì´ê´€";
            
            if (scoreA >= 0 && scoreB >= 4) return "íƒ€ê²ŸíŒ… í™•ì¥+ì˜ˆì‚° ì¦ëŒ€";
            if (scoreA >= 0 && scoreB >= 3) return "íƒ€ê²ŸíŒ… ì¡°ì •+í›…í‚¹ì„± ì¦ëŒ€";
            if (scoreA >= 0 && scoreB >= 1.5) return "ì˜ˆì‚°ì´ê´€";
            if (scoreA >= 0 && scoreB >= 0) return "ì˜ˆì‚°ì´ê´€";
            
            return ""; // ì˜¤ë¥˜ ì‹œ ë¹ˆì¹¸
        };
        
        
        // --- NEW: Data Aggregation and Scoring Logic (Updated) ---
        /**
         * Calculates all scores (A, B, Total) and insight labels based on input data and targets.
         */
        function calculateScoresAndInsight(row, campaignType) {
            let scoreA = null; // *** ìˆ˜ì •: 0 -> null ***
            let scoreB = null; // *** ìˆ˜ì •: 0 -> null ***
            let totalScore = null; // *** ìˆ˜ì •: 0 -> null ***
            let insight = 'ë°ì´í„° ë¶€ì¡±';
            let color = '#94a3b8'; // Gray
            let mediaInsight = 'ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            
            // *** (Problem 2.2) ìˆ˜ì •: mediaPrefix ë¡œì§ ***
            const mediaPrefix = (row.media || row.placement || row.creativeName) 
                ? `${row.media || 'N/A'}/${row.placement || 'N/A'}/${row.creativeName || 'N/A'}` 
                : 'ë§¤ì²´ ìƒí’ˆê³¼ ì†Œì¬ëª… ì—†ìŒ';
            
            // Helper to calculate score for metrics where 'Higher is Better' (e.g., CTR) - PERFìš©
            const scoreHigherIsBetter = (actual, target) => {
                if (actual === null || target === null || target <= 0) return 0;
                const ratioDelta = (actual - target) / target;
                return Math.max(0, Math.min(5, 2.5 + 2.5 * ratioDelta));
            };
            // Helper to calculate score for metrics where 'Lower is Better' (e.g., CPM, CPA) - PERFìš©
            const scoreLowerIsBetter = (actual, target) => {
                if (actual === null || target === null || target <= 0) return 0;
                const ratio = actual / target;
                return Math.max(0, Math.min(5, 2.5 * (2 - ratio)));
            };
            
            // Check for critical missing data (no cost/imp or primary target)
            // *** (Problem 1.1) ìˆ˜ì •: criticalMissing ë¡œì§ ê°•í™” ***
            let criticalMissing = row.cost === null || row.imp === null || row.cost === 0 || row.imp === 0;
            
            if (campaignType === 'DA') {
                // [Aì ìˆ˜] [Bì ìˆ˜] ê³„ì‚°ì— í•„ìš”í•œ ëª¨ë“  'ê¸°ë³¸' ë° 'ëª©í‘œ' ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                const daCriticalMissing = row.cost === null || row.cost === 0 || 
                                          row.imp === null || row.imp === 0 || 
                                          row.click === null || // Bì ìˆ˜(CPC, CTR)ì— í•„ìš”
                                          row.targetCpm === null || // Aì ìˆ˜ì— í•„ìš”
                                          row.targetCpc === null || // Bì ìˆ˜(CPC)ì— í•„ìš”
                                          row.targetCtr === null;   // Bì ìˆ˜(CTR)ì— í•„ìš”
                
                criticalMissing = daCriticalMissing; // DA ìº í˜ì¸ì˜ criticalMissing ë®ì–´ì“°ê¸°

                if (!daCriticalMissing) {
                    // --- DA: 5ì  ì²™ë„í™” (ì‹ ê·œ ë¡œì§) ---
                    
                    // [Aì ìˆ˜] ë…¸ì¶œ ê¸°ì—¬ë„ : ëª©í‘œ CPM ê¸°ì¤€ 5ì  ì²™ë„í™”
                    scoreA = getScoreCpm(row.actualCpm, row.targetCpm);
                    
                    // [Bì ìˆ˜] (1) CTR ê¸°ì¤€ê³¼ (2) CPC ê¸°ì¤€ìœ¼ë¡œ ì‚°ì¶œëœ ì ìˆ˜ì˜ í‰ê· ê°’
                    const bScoreCtr = getScoreCtr(row.actualCtr, row.targetCtr);
                    const bScoreCpc = getScoreCpc(row.actualCpc, row.targetCpc);
                    scoreB = (bScoreCtr + bScoreCpc) / 2;
                    
                    // [ì´ì ]
                    totalScore = (scoreA + scoreB) / 2;
                    
                    // [INSIGHT] 16ê°œ ì¡°ê±´ ì—‘ì…€ ìˆ˜ì‹ ì ìš©
                    const daInsight = getDaInsight(scoreA, scoreB);
                    insight = daInsight.grade;
                    mediaInsight = `${mediaPrefix}: ${daInsight.text}`;
                    
                    // [Color] Insight ë“±ê¸‰ì— ë”°ë¥¸ ìƒ‰ìƒ ë§¤í•‘
                    if (insight.includes("Top")) color = '#10b981'; // Green
                    else if (insight.includes("Mid")) color = '#f59e0b'; // Amber
                    else if (insight.includes("Low")) color = '#ef4444'; // Red
                    else color = '#94a3b8'; // Gray
                }
                
            } else if (campaignType === 'PERF') {
                // --- PERF: ê¸°ì¡´ ì„ í˜• ë¡œì§ (ìœ ì§€) ---
                // PERF: A(ê´‘ê³  ê´€ì‹¬ë„) = CTR (Higher is better), B(ì „í™˜ ê¸°ì—¬ë„) = CPA (Lower is better)
                
                // (PERFìš© criticalMissingì„ ì—¬ê¸°ì„œ ì •ì˜)
                const perfCriticalMissing = row.cost === null || row.cost === 0 || 
                                            row.imp === null || row.imp === 0 || 
                                            row.click === null || // Aì ìˆ˜(CTR)ì— í•„ìš”
                                            row.conv === null || // Bì ìˆ˜(CPA)ì— í•„ìš”
                                            row.targetCpa === null || // Bì ìˆ˜(CPA)ì— í•„ìš”
                                            row.targetCtr === null; // Aì ìˆ˜(CTR)ì— í•„ìš”
                
                criticalMissing = perfCriticalMissing;

                if (!perfCriticalMissing) {
                    scoreA = scoreHigherIsBetter(row.actualCtr, row.targetCtr);
                    scoreB = scoreLowerIsBetter(row.actualCpa, row.targetCpa);
                    totalScore = (scoreA + scoreB) / 2;
                    
                    // --- Insight Grouping & Color Assignment (PERFìš©) ---
                    if (totalScore >= 4.0 && scoreA >= 2.5 && scoreB >= 2.5) {
                        insight = 'Top ì†Œì¬'; color = '#10b981';
                    } else if (totalScore >= 2.5 && scoreA >= 2.5 && scoreB < 2.5) {
                        insight = 'Focus ì†Œì¬'; color = '#f59e0b';
                    } else if (totalScore >= 2.5 && scoreA < 2.5 && scoreB >= 2.5) {
                        insight = 'Potential ì†Œì¬'; color = '#3b82f6';
                    } else {
                        insight = 'Low ì†Œì¬'; color = '#ef4444';
                    }
                    
                    // --- Dynamic Insight Message Generation (PERFìš©) ---
                    if (insight === 'Top ì†Œì¬') {
                        mediaInsight = `${mediaPrefix}: íš¨ìœ¨ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤. ì˜ˆì‚°ì„ í™•ëŒ€í•˜ê³  A/B í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ì¶”ê°€ ê°œì„ ì ì„ ì°¾ìœ¼ì„¸ìš”.`;
                    } else if (insight === 'Focus ì†Œì¬') {
                        mediaInsight = `${mediaPrefix}: CPA(ì „í™˜ ê¸°ì—¬ë„) ëª©í‘œ ë‹¬ì„±ì´ ë¯¸í¡í•©ë‹ˆë‹¤. í•´ë‹¹ ì§€í‘œ ê°œì„ ì— ì§‘ì¤‘í•˜ì—¬ Top ì†Œì¬ë¡œ ìœ¡ì„±í•´ì•¼ í•©ë‹ˆë‹¤.`;
                    } else if (insight === 'Potential ì†Œì¬') {
                        mediaInsight = `${mediaPrefix}: ì „í™˜ íš¨ìœ¨ì€ ì¢‹ìœ¼ë‚˜ CTR(ê´‘ê³  ê´€ì‹¬ë„)ì´ ë‚®ìŠµë‹ˆë‹¤. íƒ€ê²ŸíŒ… í™•ëŒ€ë¥¼ í†µí•´ ë…¸ì¶œ ê¸°ì—¬ë„(A)ë¥¼ ê°œì„ í•´ì•¼ ì ì¬ë ¥ì„ ë°œíœ˜í•©ë‹ˆë‹¤.`;
                    } else if (insight === 'Low ì†Œì¬') {
                        mediaInsight = `${mediaPrefix}: íš¨ìœ¨ ê¸°ì¤€ì¹˜(ì´ì  2.5ì ) ë¯¸ë‹¬ì…ë‹ˆë‹¤. ì¦‰ì‹œ OFF/êµì²´ë¥¼ ê³ ë ¤í•˜ê³ , ì˜ˆì‚°ì„ Top ì†Œì¬ë¡œ ì´ê´€í•˜ì„¸ìš”.`;
                    }
                }
            }
            
            // í•„ìˆ˜ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 0ì ì´ ì•„ë‹Œ nullë¡œ ì²˜ë¦¬
            if (criticalMissing) {
                scoreA = null;
                scoreB = null;
                totalScore = null;
                insight = 'ë¯¸ë””ì–´ ì„±ê³¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”'; // *** (Problem 1.1 / 1.2) ìˆ˜ì • ***
                color = '#94a3b8'; // Gray
                mediaInsight = `${mediaPrefix}: ${insight}`; // *** (Problem 2.2) ìˆ˜ì • ***
            }
            
            // Final Scored Row Structure
            return {
                // Scores
                scoreA: scoreA !== null ? parseFloat(scoreA.toFixed(2)) : null,
                scoreB: scoreB !== null ? parseFloat(scoreB.toFixed(2)) : null,
                total: totalScore !== null ? parseFloat(totalScore.toFixed(2)) : null,
                insight: insight,
                color: color,
                mediaInsight: mediaInsight,
                // Raw/Calculated Metrics for Detail Table
                media: row.media,
                placement: row.placement || '', // 'ìƒí’ˆ' í‚¤
                creativeName: row.creativeName || '', // 'ì†Œì¬ëª…' í‚¤
                cost: row.cost || 0,
                imp: row.imp || 0,
                click: row.click || 0,
                view: row.view || 0, // *** (2.2) view ì¶”ê°€ ***
                conv: row.conv || 0,
                revenue: row.revenue || 0,
                ctr: row.actualCtr || 0, // fraction
                cpm: row.actualCpm || 0, // won
                cpc: row.actualCpc || 0, // won
                cpv: row.actualCpv || 0, // *** (2.2) cpv ì¶”ê°€ ***
                cpa: row.actualCpa || 0, // won
                roas: (campaignType === 'PERF' && row.cost > 0) ? (row.revenue / row.cost) * 100 : 0 // percentage
            };
        }
        /**
         * Aggregates input data, calculates scores/insights, and computes summary metrics.
         * Sets the global 'liveAnalysisData'.
         */
        function aggregateAndScoreData() {
            const rawInputData = validationData[currentCampaign];
            const campaignType = currentCampaign;
            
            const scoredData = rawInputData
                // *** (Problem 1.1) ìˆ˜ì •: costê°€ 0ì´ ì•„ë‹Œ nullì¼ ë•Œë„ í¬í•¨í•˜ë„ë¡ filter ì¡°ê±´ ë³€ê²½ ***
                .filter(row => row.media || row.creativeName || row.cost !== null || row.imp !== null)
                .map(row => {
                     // 1. Recalculate actual metrics (ensure all numbers are fresh)
                     calculateValidationMetrics(row, campaignType); 
                     // 2. Calculate scores and insight
                     return calculateScoresAndInsight(row, campaignType);
                });
            // --- Calculate Summary Metrics ---
            let totalCost = 0;
            let totalImp = 0;
            let totalClick = 0;
            let totalConv = 0;
            let totalRevenue = 0;
            let totalView = 0; // *** (2.2) totalView ì¶”ê°€ ***
            
            scoredData.forEach(item => {
                totalCost += item.cost || 0; // || 0 ì¶”ê°€
                totalImp += item.imp || 0;
                totalClick += item.click || 0;
                totalConv += item.conv || 0;
                totalRevenue += item.revenue || 0;
                totalView += item.view || 0; // *** (2.2) totalView ì§‘ê³„ ***
            });
            
            const avgCpm = totalImp > 0 ? (totalCost / totalImp) * 1000 : 0;
            const avgCtr = totalImp > 0 ? (totalClick / totalImp) : 0; // fraction
            const avgCpc = totalClick > 0 ? (totalCost / totalClick) : 0;
            const avgCpv = totalView > 0 ? (totalCost / totalView) : 0; // *** (2.2) avgCpv ê³„ì‚° ***
            const avgCpa = totalConv > 0 ? (totalCost / totalConv) : 0;
            const avgRoas = totalCost > 0 ? (totalRevenue / totalCost) * 100 : 0; // percentage
            
            let summaryMetrics = [];
            let metricsAxes = {};
            let campaignName = validationTableConfigs[campaignType].label;
            
            if (campaignType === 'DA') {
                // *** ìˆ˜ì •: (2.1) (2.2) (2.3) ***
                campaignName = 'ì§‘í–‰ ì„±ê³¼ ìš”ì•½';
                metricsAxes = { xAxis: 'ë…¸ì¶œ ì˜í–¥ë ¥ (Aì ìˆ˜)', yAxis: 'ì†Œì¬ ê´€ì‹¬ë„ (Bì ìˆ˜)' }; // *** (Problem 1.1) ìˆ˜ì • ***
                summaryMetrics = [
                    { label: 'ì´ ê´‘ê³ ë¹„', key: 'cost', value: totalCost, type: 'currency' },
                    { label: 'ì´ ë…¸ì¶œìˆ˜', key: 'imp', value: totalImp, type: 'number',
                        subMetrics: [
                            { label: 'ì„±ê³¼ CPM', value: avgCpm, type: 'currency' }
                        ]
                    },
                    { label: 'ì´ í´ë¦­ìˆ˜', key: 'click', value: totalClick, type: 'number',
                        subMetrics: [
                            { label: 'ì„±ê³¼ CPC', value: avgCpc, type: 'currency' },
                            { label: 'ì„±ê³¼ CTR', value: avgCtr, type: 'percent' }
                        ]
                    },
                    { label: 'ì´ ì¡°íšŒìˆ˜', key: 'view', value: totalView, type: 'number',
                        subMetrics: [
                            { label: 'ì„±ê³¼ CPV', value: avgCpv, type: 'currency' }
                        ]
                    },
                ];
            } else if (campaignType === 'PERF') {
                campaignName = 'ì§‘í–‰ ì„±ê³¼ ìš”ì•½'; // PERFë„ ë™ì¼í•˜ê²Œ 'ì§‘í–‰ ì„±ê³¼ ìš”ì•½'ìœ¼ë¡œ ë³€ê²½
                metricsAxes = { xAxis: 'ì „í™˜ ê¸°ì—¬ë„ (B) - CPA ê¸°ë°˜', yAxis: 'ê´‘ê³  ê´€ì‹¬ë„ (A) - CTR ê¸°ë°˜' };
                summaryMetrics = [
                    { label: 'ì´ ê´‘ê³ ë¹„', key: 'cost', value: totalCost, type: 'currency' },
                    { label: 'ì´ ë§¤ì¶œì•¡', key: 'revenue', value: totalRevenue, type: 'currency' },
                    { label: 'ì´ ì „í™˜ìˆ˜', key: 'conv', value: totalConv, type: 'number' },
                    { label: 'í‰ê·  CPA', key: 'cpa_avg', value: avgCpa, type: 'currency' },
                    { label: 'í‰ê·  ROAS', key: 'roas_avg', value: avgRoas, type: 'percent' },
                ];
            }
            
            // Set global data source for rendering
            liveAnalysisData = { 
                data: scoredData, 
                summary: summaryMetrics, 
                metrics: metricsAxes,
                headers: campaignData[campaignType].headers, // Reuse mock headers structure
                name: campaignName
            };
            return liveAnalysisData;
        }
        // --- Rendering Functions (Updated to use liveAnalysisData) ---
        const matrixContainer = document.getElementById('quadrant-matrix');
        const tableBody = document.getElementById('table-body');
        const tooltip = document.createElement('div');
        tooltip.id = 'chart-tooltip';
        // *** (Request 2) ìˆ˜ì •: absolute -> fixed ***
        tooltip.className = 'fixed p-2 bg-gray-800 text-white text-xs rounded-lg shadow-xl pointer-events-none opacity-0 transition-opacity duration-200 z-[100] whitespace-nowrap';
        document.body.appendChild(tooltip);
        function renderChart() {
            // Use liveAnalysisData
            if (!liveAnalysisData || liveAnalysisData.data.length === 0) {
                 matrixContainer.querySelectorAll('.chart-dot').forEach(dot => dot.remove());
                 // *** (Problem 2) ìˆ˜ì •: ë¼ë²¨ ì„¤ì • ì½”ë“œ ì‚­ì œ ***
                 return;
            }
            const data = liveAnalysisData;
            const matrixRect = matrixContainer.getBoundingClientRect();
            const W = matrixRect.width;
            const H = matrixRect.height;
            matrixContainer.querySelectorAll('.chart-dot').forEach(dot => dot.remove());
            const MIN_SCORE = 0;
            const MAX_SCORE = 5;
            const PADDING = 25;
            const plotW = W - 2 * PADDING;
            const plotH = H - 2 * PADDING;
            const scaleX = plotW / (MAX_SCORE - MIN_SCORE);
            const scaleY = plotH / (MAX_SCORE - MIN_SCORE);
            
            // *** ìˆ˜ì •: (2.1) íƒ€ì´í‹€ ì„¤ì • ***
            const summaryTitleEl = document.getElementById('summary-main-title');
            const summarySubtitleEl = document.getElementById('summary-title');
            if (currentCampaign === 'DA') {
                summaryTitleEl.childNodes[0].nodeValue = 'ì§‘í–‰ ì„±ê³¼ ìš”ì•½ '; // h2 í…ìŠ¤íŠ¸
                summarySubtitleEl.textContent = ''; // *** (ë°˜ì‘ ëª©í‘œ) ì‚­ì œ ***
            } else {
                summaryTitleEl.childNodes[0].nodeValue = 'ì§‘í–‰ ì„±ê³¼ ìš”ì•½ '; // h2 í…ìŠ¤íŠ¸
                summarySubtitleEl.textContent = '(ì „í™˜ ëª©í‘œ)'; // span í…ìŠ¤íŠ¸
            }
            
            // *** (Problem 2, 3) ìˆ˜ì •: ë¼ë²¨ ì„¤ì • ì½”ë“œ ì‚­ì œ ***
            
            data.data.forEach((item, index) => {
                // *** (Problem 1.1) ìˆ˜ì •: ì ìˆ˜ê°€ nullì´ ì•„ë‹ ë•Œë§Œ dot ìƒì„± ***
                if (item.scoreA !== null && item.scoreB !== null) { 
                    // *** (Problem 1.1) ìˆ˜ì •: Xì¶•=scoreA, Yì¶•=scoreB ***
                    let x = PADDING + (item.scoreA - MIN_SCORE) * scaleX; 
                    let y = H - PADDING - (item.scoreB - MIN_SCORE) * scaleY;
                    const dot = document.createElement('div');
                    dot.className = 'chart-dot';
                    dot.style.backgroundColor = item.color;
                    
                    const DOT_SIZE = 14;
                    x = Math.max(PADDING + DOT_SIZE / 2, Math.min(W - PADDING - DOT_SIZE / 2, x));
                    y = Math.max(PADDING + DOT_SIZE / 2, Math.min(H - PADDING - DOT_SIZE / 2, y));
                    dot.style.left = `${x - DOT_SIZE / 2}px`;
                    dot.style.top = `${y - DOT_SIZE / 2}px`;
                    
                    dot.dataset.index = index;
                    dot.dataset.campaign = currentCampaign;
                    dot.dataset.creative = `${item.placement}_${item.creativeName}`; // ìˆ˜ì •ë¨
                    dot.dataset.insight = item.insight;
                    dot.dataset.scoreA = item.scoreA.toFixed(1);
                    dot.dataset.scoreB = item.scoreB.toFixed(1);
                    dot.dataset.total = item.total.toFixed(2);
                    
                    dot.addEventListener('mouseenter', showTooltip);
                    dot.addEventListener('mousemove', moveTooltip);
                    dot.addEventListener('mouseleave', hideTooltip);
                    matrixContainer.appendChild(dot);
                }
            });
        }
        
        function showTooltip(e) { 
            const item = e.target.dataset;
            // *** (Problem 1) ìˆ˜ì •: ê´„í˜¸ ì œê±° ***
            const insightText = item.insight;
            
            const tooltipContent = `
                <div class="font-bold text-base">${item.creative}</div>
                <div class="mt-1">ë“±ê¸‰: ${insightText}</div>
                <div class="mt-0.5 text-xs text-indigo-300">A Score: ${item.scoreA} | B Score: ${item.scoreB} | Total: ${item.total}</div>
            `;
            tooltip.innerHTML = tooltipContent;
            tooltip.classList.add('opacity-100');
            moveTooltip(e);
        }
        // *** (Request 2) ìˆ˜ì •: pageX/Y -> clientX/Y ***
        function moveTooltip(e) {
            let x = e.clientX + 15;
            let y = e.clientY - 15;
            
            const tooltipRect = tooltip.getBoundingClientRect();
            // *** (Problem 1.4) íˆ´íŒ ìœ„ì¹˜ ì¡°ì • ë¡œì§ ê°•í™” ***
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Xì¶•: ì˜¤ë¥¸ìª½ ê°€ì¥ìë¦¬ë¥¼ ë„˜ì–´ê°€ë©´ ì™¼ìª½ìœ¼ë¡œ ë¶™ì„
            if (x + tooltipRect.width + 15 > viewportWidth) {
                x = e.clientX - tooltipRect.width - 15;
            }
            // Yì¶•: ìœ„ìª½ ê°€ì¥ìë¦¬ë¥¼ ë„˜ì–´ê°€ë©´ ì•„ë˜ë¡œ ë¶™ì„
            if (y - 15 < 0) {
                 y = e.clientY + 15;
            }
            // Yì¶•: ì•„ë˜ìª½ ê°€ì¥ìë¦¬ë¥¼ ë„˜ì–´ê°€ë©´ ìœ„ë¡œ ë¶™ì„ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            else if (y + tooltipRect.height > viewportHeight) {
                y = viewportHeight - tooltipRect.height - 10;
            }
            
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;
        }
        function hideTooltip() { 
            tooltip.classList.remove('opacity-100');
        }
        
        // *** ìˆ˜ì •: (2.2) (2.3) renderSummaryTable ì „ë©´ ì¬ì‘ì„± ***
        function renderSummaryTable() {
            if (!liveAnalysisData || liveAnalysisData.summary.length === 0) return;
            const data = liveAnalysisData;
            const headerRow = document.getElementById('summary-header');
            const body = document.getElementById('summary-body');
            headerRow.innerHTML = '';
            body.innerHTML = '';
            
            // --- 1. Header Row ---
            data.summary.forEach(metric => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-center min-w-[150px]'; // min-width ì¶”ê°€
                th.textContent = metric.label;
                headerRow.appendChild(th);
            });
            
            // --- 2. Body Row (Data) ---
            const tr = document.createElement('tr');
            tr.className = 'text-gray-900';
            
            data.summary.forEach(metric => {
                const td = document.createElement('td');
                td.className = 'px-6 py-4 whitespace-nowrap text-center align-top';
                
                // Main Value
                let mainValueText = formatNumber(metric.value, metric.type);
                // PERF ìº í˜ì¸ì˜ ROASì™€ CPAëŠ” %ë‚˜ ì› í‘œì‹œê°€ ì´ë¯¸ ë˜ì–´ìˆìŒ (ì˜ˆì™¸ì²˜ë¦¬)
                if (currentCampaign === 'PERF' && (metric.key === 'roas_avg')) {
                    mainValueText = `${Math.round(metric.value).toLocaleString('ko-KR')}%`;
                } else if (currentCampaign === 'PERF' && metric.key === 'cpa_avg') {
                     mainValueText = formatNumber(metric.value, 'currency');
                }
                
                let tdHtml = `<div class="text-lg font-bold">${mainValueText}</div>`;
                
                // Sub-Metrics
                if (metric.subMetrics) {
                    metric.subMetrics.forEach(sub => {
                        const subValueText = formatNumber(sub.value, sub.type);
                        tdHtml += `<div class="text-sm text-gray-600 mt-2">
                                     <span class="font-semibold">${sub.label}:</span> ${subValueText}
                                   </div>`;
                    });
                }
                
                td.innerHTML = tdHtml;
                tr.appendChild(td);
            });
            body.appendChild(tr);
        }
        
        function sortData(key) {
            if (sortColumn === key) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = key;
                sortDirection = 'desc';
            }
            const data = liveAnalysisData.data;
            data.sort((a, b) => {
                const aVal = a[key];
                const bVal = b[key];
                let comparison = 0;
                if (aVal > bVal) {
                    comparison = 1;
                } else if (aVal < bVal) {
                    comparison = -1;
                }
                return sortDirection === 'asc' ? comparison : comparison * -1;
            });
            renderTable();
        }
        function renderTable() {
            if (!liveAnalysisData || liveAnalysisData.data.length === 0) {
                 // *** (Problem 1.2) ìˆ˜ì •: ë¬¸êµ¬ ë³€ê²½ ***
                 tableBody.innerHTML = `<tr><td colspan="15" class="text-center py-4 text-gray-500">ë¯¸ë””ì–´ ì„±ê³¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”</td></tr>`;
                 document.getElementById('table-header').innerHTML = '';
                 return;
            }
            
            const data = liveAnalysisData;
            const headerRow = document.getElementById('table-header');
            tableBody.innerHTML = '';
            headerRow.innerHTML = '';
            data.headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left border-b border-gray-200 text-center sortable whitespace-nowrap';
                
                // *** (Problem 2.1) ìˆ˜ì •: A/B ì ìˆ˜ í—¤ë”ì— ë¶€ì œ ì¶”ê°€ ***
                if (header.key === 'cost') {
                     th.innerHTML = `${header.name} <span class="header-subtext">(ì†Œì§„ ê¸ˆì•¡)</span>`;
                } else if (header.key === 'scoreA') {
                     th.innerHTML = `${header.name} <span class="header-subtext">(ë…¸ì¶œ ì˜í–¥ë ¥)</span>`;
                } else if (header.key === 'scoreB') {
                     th.innerHTML = `${header.name} <span class="header-subtext">(ì†Œì¬ ê´€ì‹¬ë„)</span>`;
                } else {
                    th.textContent = header.name;
                }
                
                th.dataset.key = header.key;
                th.addEventListener('click', () => sortData(header.key));
                
                if (sortColumn === header.key) {
                    th.innerHTML += sortDirection === 'asc' ? ' â–²' : ' â–¼'; // innerHTML ì‚¬ìš©ìœ¼ë¡œ ë³€ê²½
                }
                headerRow.appendChild(th);
            });
            data.data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-indigo-50 transition-colors';
                
                const keys = data.headers.map(h => h.key);
                
                keys.forEach(key => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-600 text-center';
                    
                    let cellValue = item[key];
                    switch(key) {
                        case 'cost':
                        case 'revenue':
                        case 'cpm':
                        case 'cpc':
                        case 'cpa':
                        case 'cpv': // *** (2.2) CPV í¬ë§·íŒ… ì¶”ê°€ ***
                            td.textContent = formatNumber(cellValue, 'currency');
                            break;
                        case 'imp':
                        case 'click':
                        case 'conv':
                        case 'view': // *** (2.2) VIEW í¬ë§·íŒ… ì¶”ê°€ ***
                            td.textContent = formatNumber(cellValue, 'number');
                            break;
                        case 'ctr':
                            td.textContent = formatNumber(cellValue, 'percent');
                            break;
                        case 'roas':
                            td.textContent = `${Math.round(cellValue).toLocaleString('ko-KR')}%`; // ROAS is stored as a percentage (e.g., 500)
                            break;
                        case 'scoreA':
                        case 'scoreB':
                        case 'total':
                            td.textContent = formatNumber(cellValue, 'score');
                            td.classList.add('font-bold', 'text-gray-800');
                            break;
                        case 'insight':
                            // *** (Problem 1) ìˆ˜ì •: ê´„í˜¸ ì œê±° ***
                            const insightText = cellValue;
                            td.innerHTML = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color:${item.color}1A; color:${item.color}">${insightText}</span>`;
                            break;
                        case 'action':
                            // *** (Problem 4) ìˆ˜ì •: 'í”¼ë“œë°±' ì—´ ë¡œì§ ë³€ê²½ ***
                            let actionText = '';
                            let colorClass = 'text-gray-800';
                            
                            if (currentCampaign === 'DA') {
                                // ì—‘ì…€ ë¡œì§: 16ê°œ ì¡°ê±´ì— ë§ëŠ” í”¼ë“œë°± í…ìŠ¤íŠ¸
                                actionText = getDaFeedback(item.scoreA, item.scoreB);
                                
                                // ìƒ‰ìƒ ê²°ì • ë¡œì§ (INSIGHT ë“±ê¸‰ ê¸°ì¤€)
                                if (item.insight.includes("Top")) {
                                    colorClass = 'text-green-600 bg-green-100';
                                } else if (item.insight.includes("Mid")) {
                                    colorClass = 'text-amber-600 bg-amber-100';
                                } else if (item.insight.includes("Low")) {
                                    colorClass = 'text-red-600 bg-red-100';
                                } else {
                                    actionText = ''; // ë°ì´í„° ì—†ìŒ
                                    colorClass = '';
                                }
                                
                            } else {
                                // PERF ìº í˜ì¸ì€ ê¸°ì¡´ ì´ì  2.5 ê¸°ì¤€ ë¡œì§ ìœ ì§€
                                const action = item.total < 2.5 ? 'OFF/êµì²´' : 'ìœ ì§€/í™•ëŒ€';
                                colorClass = item.total < 2.5 ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100';
                                actionText = action;
                            }
                            
                            td.innerHTML = `<span class="font-bold rounded-lg px-2 py-1 ${colorClass}">${actionText}</span>`;
                            break;
                        default:
                            td.textContent = cellValue;
                            td.classList.remove('text-center');
                            td.classList.add('text-left');
                            break;
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        function renderInsights() {
            if (!liveAnalysisData || liveAnalysisData.data.length === 0) {
                 document.getElementById('insight-list').innerHTML = `<li class="text-gray-500">${currentCampaign === 'DA' ? 'ë¯¸ë””ì–´ ì„±ê³¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”' : 'ë¶„ì„ì„ ìœ„í•´ ì…ë ¥ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.'}</li>`; // *** (Problem 1.2) ìˆ˜ì • ***
                 return;
            }
            const data = liveAnalysisData.data; // (liveAnalysisData.dataë¥¼ dataë¡œ ì°¸ì¡°)
            const insightList = document.getElementById('insight-list');
            insightList.innerHTML = '';
            const gradeInsights = {};
            let hasValidData = false; // *** (Problem 1.1) ìˆ˜ì • ***
            
            data.forEach(item => { // (data.data.forEach -> data.forEach)
                // *** (Problem 1.1) ìˆ˜ì •: ì ìˆ˜ê°€ nullì´ ì•„ë‹Œ (ìœ íš¨í•œ) ë°ì´í„°ë§Œ ì§‘ê³„ ***
                if (item.total !== null) { 
                    hasValidData = true;
                    // INSIGHT ë“±ê¸‰('Top ì†Œì¬')ì„ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”
                    const grade = item.insight; 
                    if (!gradeInsights[grade]) {
                        gradeInsights[grade] = [];
                    }
                    gradeInsights[grade].push({ 
                        media: item.media, 
                        insight: item.mediaInsight, // ìƒì„¸ í…ìŠ¤íŠ¸
                        color: item.color
                    });
                }
            });
            
            // *** (Problem 1.1) ìˆ˜ì •: ìœ íš¨í•œ ë°ì´í„°ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ ***
            if (!hasValidData) {
                 insightList.innerHTML = `<li class="text-gray-500">${currentCampaign === 'DA' ? 'ë¯¸ë””ì–´ ì„±ê³¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”' : 'ë¶„ì„ì„ ìœ„í•´ ì…ë ¥ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.'}</li>`;
                 return;
            }
            
            // *** (Problem 1) ìˆ˜ì •: ê´„í˜¸ ì œê±° ***
            const insightOrder = ["Top ì†Œì¬", "Topì†Œì¬", "Mid ì†Œì¬", "Midì†Œì¬", "Lowì†Œì¬", "ë°ì´í„° ë¶€ì¡±", "ì˜¤ë¥˜"]; 
            
            insightOrder.forEach(grade => {
                const items = gradeInsights[grade];
                if (items && items.length > 0) {
                    const gradeColor = items[0].color;
                    // *** (Problem 1) ìˆ˜ì •: ê´„í˜¸ ì œê±° ***
                    const gradeText = grade;
                    
                    const gradeHeader = document.createElement('li');
                    gradeHeader.className = 'pt-2 mb-2 font-extrabold text-base border-b-2 pb-1';
                    gradeHeader.style.borderColor = gradeColor;
                    gradeHeader.style.color = gradeColor;
                    gradeHeader.innerHTML = `[${gradeText}] í•µì‹¬ ì „ëµ (${items.length}ê°œ ì†Œì¬)`;
                    insightList.appendChild(gradeHeader);
                    
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'text-gray-700 text-sm flex items-start';
                        
                        // *** (Problem 2) ìˆ˜ì •: ê°€ë…ì„± í¬ë§·íŒ… (ë³¼ë“œ, ì¤„ë°”ê¿ˆ) ***
                        const insightParts = item.insight.split(/:(.+)/); // [Prefix, Text]
                        let prefix = insightParts[0] ? insightParts[0].trim() : 'ë§¤ì²´ ìƒí’ˆê³¼ ì†Œì¬ëª… ì—†ìŒ';
                        let text = insightParts[1] ? insightParts[1].trim() : 'ì¸ì‚¬ì´íŠ¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';
                    
                        // "ë§¤ì²´ ìƒí’ˆê³¼ ì†Œì¬ëª… ì—†ìŒ" ì¼€ì´ìŠ¤ ì²˜ë¦¬
                        if (prefix === 'ë§¤ì²´ ìƒí’ˆê³¼ ì†Œì¬ëª… ì—†ìŒ') {
                            text = item.insight; // ì›ë³¸ í…ìŠ¤íŠ¸(ì˜ˆ: "ë¯¸ë””ì–´ ì„±ê³¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”")
                            prefix = ''; // ì ‘ë‘ì‚¬ ì—†ìŒ
                        }
                        
                        li.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mt-1 mr-2 flex-shrink-0" style="color:${gradeColor}" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                            <span>
                                ${prefix ? `<strong class="font-bold text-gray-900 block">${prefix}</strong>` : ''}
                                <span class="block ${prefix ? 'mt-1' : ''}">${text}</span>
                            </span>
                        `;
                        insightList.appendChild(li);
                    });
                }
            });
        }
        
        /**
         * Runs all analysis and renders the results section.
         */
        function runAnalysis() {
            try {
                aggregateAndScoreData(); // Calculate and set liveAnalysisData
                renderSummaryTable();
                renderTable();
                renderInsights();
                
                // ì°¨íŠ¸ ë Œë”ë§ì„ DOM ì—…ë°ì´íŠ¸ í›„ë¡œ ì‚´ì§ ì§€ì—° (ë ˆì´ì•„ì›ƒ ë¬¸ì œ í•´ê²°)
                setTimeout(renderChart, 0); 
                
            } catch (error) {
                console.error("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                // ì—¬ê¸°ì— ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ìˆ˜ ìˆëŠ” ì˜¤ë¥˜ ë©”ì‹œì§€ UIë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            }
        }
        function renderDashboard() {
            // *** (LocalStorage) NEW: ìº í˜ì¸ ë³€ê²½ ì‹œ localStorageì—ì„œ ë¡œë“œ ì‹œë„ ***
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            let parsedData = null;
            if (savedData) {
                try {
                    parsedData = JSON.parse(savedData);
                } catch (e) {
                    console.error("localStorage íŒŒì‹± ì˜¤ë¥˜:", e);
                    parsedData = null; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ nullë¡œ
                }
            }
            
            // ì €ì¥ëœ ë°ì´í„°ê°€ ìˆê³ , í˜„ì¬ ìº í˜ì¸ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (parsedData && parsedData[currentCampaign] && parsedData[currentCampaign].length > 0) {
                validationData[currentCampaign] = parsedData[currentCampaign];
                // ì €ì¥ëœ ë°ì´í„°ì˜ isPrefill ìƒíƒœë¥¼ ì „ì—­ í”Œë˜ê·¸ì— ë°˜ì˜
                isPrefillActive = validationData[currentCampaign].some(row => row.isPrefill);
            } else {
                // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ê±°ë‚˜, í˜„ì¬ ìº í˜ì¸ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ mockìœ¼ë¡œ ë¦¬ì…‹
                validationData[currentCampaign] = mapCampaignDataToValidation(campaignData[currentCampaign].data, currentCampaign);
                isPrefillActive = true; // ì´ ê²½ìš°ì—” ë‹¤ì‹œ prefill ìƒíƒœ
            }

            
            // Reset sorting when switching campaigns
            sortColumn = 'total';
            sortDirection = 'desc';
            // Update Tab State
            document.querySelectorAll('.campaign-tab').forEach(tab => {
                if (tab.dataset.camp === currentCampaign) {
                    tab.classList.replace('text-gray-600', 'text-white');
                    tab.classList.add('bg-indigo-600', 'shadow-lg');
                    tab.classList.remove('hover:bg-white', 'hover:text-indigo-600');
                } else {
                    tab.classList.replace('text-white', 'text-gray-600');
                    tab.classList.remove('bg-indigo-600', 'shadow-lg');
                    tab.classList.add('hover:bg-white', 'hover:text-indigo-600');
                }
            });
            
            // *** (ë¬¸ì œ 1 ìˆ˜ì •) ***
            // renderValidationTable() ì „ì— ì„±ê³¼ ê³„ì‚° ë¡œì§ì„ ë¨¼ì € ì‹¤í–‰í•©ë‹ˆë‹¤.
            validationData[currentCampaign].forEach(row => calculateValidationMetrics(row, currentCampaign));

            // 1. Render Validation Table for the current campaign
            renderValidationTable();
            
            // 2. Automatically run analysis
            runAnalysis();
        }
        
        // *** AI UPLOAD: íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜ (REMOVED) ***
        
        // *** AI UPLOAD: Gemini API í˜¸ì¶œ í•¨ìˆ˜ (REMOVED) ***
        
        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // ì•ˆì •ì„±ì„ ìœ„í•´ try...catchë¡œ ê°ìŒ‰ë‹ˆë‹¤.
            try {
                // *** (LocalStorage) NEW: Load saved data on init ***
                const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        // isPrefill ìƒíƒœë¥¼ ë³µì›í•˜ê¸° ìœ„í•´, DA/PERF ë‘˜ ë‹¤ ë®ì–´ì¨ì•¼ í•¨
                        if (parsedData.DA) {
                            validationData.DA = parsedData.DA;
                        }
                        if (parsedData.PERF) {
                             validationData.PERF = parsedData.PERF;
                        }
                        
                        // í˜„ì¬ ìº í˜ì¸(DA)ì˜ isPrefill ìƒíƒœë¥¼ ë³´ê³  ì „ì—­ í”Œë˜ê·¸ ì„¤ì •
                        isPrefillActive = validationData.DA.some(row => row.isPrefill);

                    } catch(e) {
                         console.error("Failed to parse localStorage data", e);
                         isPrefillActive = true; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’(mock) ì‚¬ìš©
                    }
                }
                
                document.querySelectorAll('.campaign-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        currentCampaign = e.target.dataset.camp;
                        renderDashboard(); 
                    });
                });
                
                toggleValidationTableButton.addEventListener('click', toggleValidationTable);
                addValidationRowButton.addEventListener('click', addValidationRow);
                
                // Event listener for the analysis button (manual re-run after input)
                runAnalysisButton.addEventListener('click', runAnalysis);
                
                // *** (LocalStorage) NEW: ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ***
                saveDataButton.addEventListener('click', () => {
                    // ì €ì¥ ì‹œ, í˜„ì¬ isPrefillActive ìƒíƒœë„ í•¨ê»˜ ì €ì¥ (ì˜ë„ì¹˜ ì•Šì€ ì´ˆê¸°í™” ë°©ì§€)
                    // í˜„ì¬ ìº í˜ì¸ì˜ isPrefill ìƒíƒœë¥¼ ëª¨ë“  í–‰ì— ë™ê¸°í™”
                    validationData[currentCampaign].forEach(row => row.isPrefill = isPrefillActive);
                    saveDataToLocalStorage();
                });
                
                resetDataButton.addEventListener('click', () => {
                    // *** (ë¬¸ì œ 2 ìˆ˜ì •) ***
                    // (Optional: Show confirmation modal here)
                    if (confirm("ì„±ê³¼ë¥¼ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì €ì¥ëœ ë‚´ìš©ì´ ëª¨ë‘ ì§€ì›Œì§‘ë‹ˆë‹¤.")) {
                        localStorage.removeItem(LOCAL_STORAGE_KEY);
                        
                        // 'ê¸°ë³¸ê°’(ì˜ˆì‹œ)'ì´ ì•„ë‹Œ 'ê³µë€'ìœ¼ë¡œ ì´ˆê¸°í™”
                        validationData.DA = [mapCampaignDataToValidation([{}], 'DA')[0]];
                        validationData.PERF = [mapCampaignDataToValidation([{}], 'PERF')[0]];
                        isPrefillActive = false; // ê³µë€ ìƒíƒœì´ë¯€ë¡œ prefillì´ ì•„ë‹˜
                        
                        renderDashboard(); // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                    }
                });
                
                
                // *** AI UPLOAD: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (REMOVED) ***
                
                // *** (ë¬¸ì œ 1 ìˆ˜ì •) ***
                // ì´ ê³„ì‚° ë¡œì§ì„ DOMContentLoadedì—ì„œ renderDashboard ë‚´ë¶€ë¡œ ì´ë™ì‹œì¼°ìŠµë‹ˆë‹¤.
                // validationData.DA.forEach(row => calculateValidationMetrics(row, 'DA'));
                // validationData.PERF.forEach(row => calculateValidationMetrics(row, 'PERF'));
                
                renderDashboard(); // Initial render
                
                // Initial UI Setup for Open Table (isValidationTableOpen = true)
                const toggleIcon = document.getElementById('toggle-icon');
                const toggleText = document.getElementById('toggle-text');
                
                if (isValidationTableOpen) {
                    toggleText.textContent = 'ì…ë ¥ í…Œì´ë¸” ì ‘ê¸°';
                    toggleIcon.classList.add('rotate-180');
                }
                
                // Handle window resize for chart responsiveness
                window.addEventListener('resize', renderChart);
                
            } catch (error) {
                 console.error("ì´ˆê¸°í™” ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ ë°œìƒ:", error);
                 document.body.innerHTML = `<div class="p-8 bg-red-100 text-red-700">í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. consoleì„ í™•ì¸í•´ì£¼ì„¸ìš”. ì˜¤ë¥˜: ${error.message}</div>`;
            }
        });
    </script>
</body>
</html>

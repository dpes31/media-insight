<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>통합 DA/퍼포먼스 캠페인 심층 분석 대시보드</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .scroll-container::-webkit-scrollbar { height: 8px; }
        .scroll-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .scroll-container::-webkit-scrollbar-track { background: #f1f5f9; }
        
        /* 4-Quadrant Matrix Styling */
        .quadrant-matrix {
            position: relative;
            width: 100%;
            height: 480px; 
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }

        .quadrant {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            position: relative;
            z-index: 10;
        }

        /* Quadrant Colors & Labels for Intuitive Interpretation */
        .quadrant-top-right { background-color: rgba(16, 185, 129, 0.05); } /* Top: Green */
        .quadrant-top-left { background-color: rgba(59, 130, 246, 0.05); } /* Potential: Blue */
        .quadrant-bottom-right { background-color: rgba(245, 158, 11, 0.05); } /* Focus: Amber */
        .quadrant-bottom-left { background-color: rgba(239, 68, 68, 0.05); } /* Low: Red */

        .quadrant-label {
            font-weight: 700;
            font-size: 1.5rem;
            position: absolute;
            opacity: 0.1; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            user-select: none;
        }
        
        /* Quadrant Middle Lines (New Improvement) */
        .matrix-lines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 20;
        }
        .v-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            border-left: 2px dashed #9ca3af; /* Gray dashed line for mid-point */
            transform: translateX(-1px);
        }
        .h-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            border-top: 2px dashed #9ca3af; /* Gray dashed line for mid-point */
            transform: translateY(-1px);
        }

        .chart-dot {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 50;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid #fff;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
        }

        .chart-dot:hover {
            transform: scale(1.5);
            z-index: 60;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .sortable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sortable:hover {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="p-4 md:p-8"> <!-- 좌우 패딩을 줄였습니다 -->

    <div id="app" class="w-full mx-auto bg-white rounded-xl shadow-2xl p-8 md:p-12"> <!-- max-w-screen-xl 대신 w-full을 사용하여 화면을 꽉 채웁니다 -->

        <!-- Header and Campaign Selector -->
        <header class="mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">통합 캠페인 성과 심층 분석 대시보드 (PC)</h1>
            <p class="text-gray-500">DA/퍼포먼스 목표별 효율 분석 및 소재 등급별 직관적 인사이트 도출</p>
        </header>

        <!-- Campaign Selector Tabs -->
        <div class="flex space-x-2 p-1 bg-gray-100 rounded-lg max-w-lg mb-8" role="tablist">
            <button id="tab-da" data-camp="DA" class="campaign-tab flex-1 py-3 px-6 text-base font-semibold rounded-lg bg-indigo-600 text-white shadow-lg transition-all">
                DA 캠페인 (반응 목표)
            </button>
            <button id="tab-perf" data-camp="PERF" class="campaign-tab flex-1 py-3 px-6 text-base font-medium text-gray-600 hover:bg-white hover:text-indigo-600 transition-all">
                퍼포먼스 캠페인 (전환 목표)
            </button>
        </div>

        <!-- Campaign Validation Input Section -->
        <div id="validation-section" class="mb-10">
            <!-- Title and Toggle Button -->
            <div class="flex items-center justify-between mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold text-gray-800">
                    캠페인 목표 & 성과 검증 항목 입력
                </h2>
                <button id="toggle-validation-table" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 text-sm font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                    <span id="toggle-text">입력 테이블 열기</span>
                    <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1 transform rotate-0 transition-transform"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                </button>
            </div>

            <!-- Collapsible Input Table Container -->
            <div id="validation-table-content" class="hidden transition-all duration-300 overflow-hidden">
                <div class="bg-gray-50 p-4 rounded-xl shadow-inner border">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-sm text-gray-600">
                            <span id="validation-campaign-label" class="font-bold text-indigo-600">DA 캠페인</span> 효율 검증 항목을 직접 기재해주세요.
                        </p>
                        <button id="add-validation-row" class="bg-green-500 text-white hover:bg-green-600 text-xs font-semibold py-1 px-3 rounded-md transition-colors">
                            + 항목 추가
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table id="validation-input-table" class="min-w-full divide-y divide-gray-200 border-separate border-spacing-0">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr id="validation-table-header">
                                    <!-- Table Headers will be injected here -->
                                </tr>
                            </thead>
                            <tbody id="validation-table-body">
                                <!-- Input Rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 1. Overall Performance Summary Table -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">종합 성과 요약 <span id="summary-title" class="text-indigo-600 text-lg ml-2"></span></h2>
            <div class="overflow-hidden rounded-xl shadow-lg border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-50">
                        <tr id="summary-header" class="text-sm font-semibold text-indigo-700 uppercase tracking-wider">
                            <!-- Summary Headers -->
                        </tr>
                    </thead>
                    <tbody id="summary-body" class="bg-white divide-y divide-gray-200">
                        <!-- Summary Data -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 2. Visualization and Insights (3-Column Layout) -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-10">
            
            <!-- Left 2/3: 4-Quadrant Matrix (Existing Logic) -->
            <div class="xl:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        소재 성과 도식화 (4분면 매트릭스)
                        <span id="chart-axes-label" class="ml-3 text-sm text-gray-500"></span>
                    </h2>
                    
                    <div class="quadrant-matrix" id="quadrant-matrix">
                        <!-- Quadrant Lines (NEW) -->
                        <div class="matrix-lines">
                            <div class="v-line"></div>
                            <div class="h-line"></div>
                        </div>

                        <!-- Quadrant 1: Top Right (Top) -->
                        <div class="quadrant quadrant-top-right">
                            <div class="quadrant-label text-green-700">Top Zone</div>
                        </div>
                        <!-- Quadrant 2: Top Left (Potential) -->
                        <div class="quadrant quadrant-top-left">
                            <div class="quadrant-label text-blue-700">Potential Zone</div>
                        </div>
                        <!-- Quadrant 3: Bottom Left (Low) -->
                        <div class="quadrant quadrant-bottom-left">
                            <div class="quadrant-label text-red-700">Low Zone</div>
                        </div>
                        <!-- Quadrant 4: Bottom Right (Focus) -->
                        <div class="quadrant quadrant-bottom-right">
                            <div class="quadrant-label text-amber-700">Focus Zone</div>
                        </div>

                        <!-- Dots are injected here -->
                    </div>
                    
                    <div id="matrix-info" class="mt-4 flex justify-between text-sm text-gray-600 font-medium">
                        <span id="y-low-label"></span>
                        <span id="y-high-label"></span>
                    </div>
                    <p class="text-sm text-gray-500 mt-2 text-center">X축: <span id="x-axis-label" class="font-semibold text-gray-700"></span></p>
                    <p class="text-xs text-gray-400 mt-1 text-center">중앙 기준선: 5점 척도 중 2.5점 (총점 2.5점 미만은 OFF/교체 고려)</p>
                </div>
            </div>

            <!-- Right 1/3: Key Insights (Existing Logic) -->
            <div class="xl:col-span-1 space-y-6">
                <div class="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200 h-full">
                    <h2 class="text-2xl font-bold text-indigo-700 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                        매체/등급별 핵심 인사이트
                    </h2>
                    <ul id="insight-list" class="space-y-4 text-gray-700 text-sm">
                        <!-- Insights will be injected here -->
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 3. Efficiency Data Table (Existing Logic) -->
        <div class="mt-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">캠페인 상세 효율 지표 (소재별)</h2>
            <div class="scroll-container overflow-x-auto rounded-xl shadow-inner border">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr id="table-header" class="text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <!-- Headers will be injected here -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Data rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config (Mandatory, though not used for persistence here)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Helper function for formatting numbers with commas
        const formatNumericInput = (value) => {
            // Remove all non-digit characters
            const cleanValue = value.toString().replace(/[^\d]/g, ''); 
            if (cleanValue === '') return '';
            // Add thousand separators
            return parseInt(cleanValue, 10).toLocaleString('ko-KR');
        };

        // Mock data structure (unchanged)
        const campaignData = {
            'DA': {
                name: 'DA 캠페인 (반응 목표)',
                metrics: { xAxis: '소재 관심도 (B)', yAxis: '유효 노출 기여도 (A)' },
                summary: [
                    { label: '총 광고비', key: 'cost', value: 4500000, type: 'currency' },
                    { label: '총 노출수', key: 'imp', value: 9500000, type: 'number' },
                    { label: '평균 CPM', key: 'cpm_avg', value: 473.68, type: 'currency' },
                    { label: '평균 CTR', key: 'ctr_avg', value: 0.42, type: 'percent' },
                    { label: '평균 CPC', key: 'cpc_avg', value: 112.5, type: 'currency' },
                ],
                headers: [
                    { name: '매체', key: 'media' }, { name: '소재 구분', key: 'creative' }, 
                    { name: '노출수', key: 'imp' }, { name: '클릭수', key: 'click' }, 
                    { name: '광고비(원)', key: 'cost' }, { name: 'CPM(원)', key: 'cpm' }, 
                    { name: 'CTR(%)', key: 'ctr' }, { name: 'CPC(원)', key: 'cpc' }, 
                    { name: 'A (노출 기여도)', key: 'scoreA' }, { name: 'B (소재 관심도)', key: 'scoreB' }, 
                    { name: '총점', key: 'total' }, { name: 'INSIGHT', key: 'insight' }, 
                    { name: '교체 유무', key: 'action' }
                ],
                data: [
                    { media: '네이버 GFA', creative: '소재A_블랙', cost: 1200000, imp: 2500000, click: 12500, cpm: 480, ctr: 0.0050, cpc: 96, scoreA: 4.8, scoreB: 4.5, total: 4.65, insight: 'Top 소재', color: '#10b981', mediaInsight: 'GFA Top 소재는 노출과 관심도 모두 높습니다. 예산 집중(확대).' },
                    { media: '카카오 비즈보드', creative: '소재B_레드', cost: 1000000, imp: 2200000, click: 8800, cpm: 454.5, ctr: 0.0040, cpc: 113.6, scoreA: 4.0, scoreB: 4.0, total: 4.0, insight: 'Top 소재', color: '#10b981', mediaInsight: '비즈보드 Top 소재는 안정적입니다. A/B 테스트로 관심도(B) 개선 시도.' },
                    { media: '구글 GDN', creative: '소재C_그린', cost: 1500000, imp: 3000000, click: 9000, cpm: 500, ctr: 0.0030, cpc: 166.7, scoreA: 3.5, scoreB: 2.0, total: 2.75, insight: 'Focus 소재', color: '#f59e0b', mediaInsight: 'GDN은 노출 효율(A)은 괜찮으나 소재 관심도(B)가 낮습니다. 소재 교체/타겟팅 정교화.' },
                    { media: '네이버 GFA', creative: '소재D_옐로우', cost: 800000, imp: 1800000, click: 4500, cpm: 444.4, ctr: 0.0025, cpc: 177.8, scoreA: 2.0, scoreB: 1.5, total: 1.75, insight: 'Low 소재', color: '#ef4444', mediaInsight: 'Low 소재는 즉시 OFF 및 예산을 Top 소재로 이관해야 합니다.' },
                    { media: '카카오 비즈보드', creative: '소재E_블루', cost: 600000, imp: 1000000, click: 3500, cpm: 600, ctr: 0.0035, cpc: 171.4, scoreA: 2.8, scoreB: 3.2, total: 3.0, insight: 'Potential 소재', color: '#3b82f6', mediaInsight: '비즈보드 Potential 소재는 CPM이 높습니다. 노출 기여도(A) 개선을 위해 타겟팅 확대 고려.' },
                ],
            },
            'PERF': {
                name: '퍼포먼스 캠페인 (전환 목표)',
                metrics: { xAxis: '전환 기여도 (B)', yAxis: '광고 관심도 (A)' },
                summary: [
                    { label: '총 광고비', key: 'cost', value: 6000000, type: 'currency' },
                    { label: '총 매출액', key: 'revenue', value: 30000000, type: 'currency' },
                    { label: '총 전환수', key: 'conv', value: 250, type: 'number' },
                    { label: '평균 CPA', key: 'cpa_avg', value: 24000, type: 'currency' },
                    { label: '평균 ROAS', key: 'roas_avg', value: 500, type: 'percent' },
                ],
                headers: [
                    { name: '매체', key: 'media' }, { name: '소재 구분', key: 'creative' }, 
                    { name: '노출수', key: 'imp' }, { name: '클릭수', key: 'click' }, 
                    { name: '전환수', key: 'conv' }, { name: '매출액(원)', key: 'revenue' }, 
                    { name: '광고비(원)', key: 'cost' }, { name: 'CTR(%)', key: 'ctr' }, 
                    { name: 'CPA(원)', key: 'cpa' }, { name: 'ROAS(%)', key: 'roas' },
                    { name: 'A (광고 관심도)', key: 'scoreA' }, { name: 'B (전환 기여도)', key: 'scoreB' }, 
                    { name: '총점', key: 'total' }, { name: 'INSIGHT', key: 'insight' }, 
                    { name: '교체 유무', key: 'action' }
                ],
                data: [
                    { media: '구글 SA', creative: '소재_키워드1', cost: 2000000, imp: 150000, click: 7500, conv: 100, revenue: 15000000, ctr: 0.050, cpa: 20000, roas: 750, scoreA: 5.0, scoreB: 4.8, total: 4.9, insight: 'Top 소재', color: '#10b981', mediaInsight: 'SA Top 키워드는 독보적인 효율입니다. 예산 최대 확대를 고려.' },
                    { media: '페이스북/인스타', creative: '소재_여성타겟', cost: 1800000, imp: 500000, click: 4000, conv: 80, revenue: 8000000, ctr: 0.008, cpa: 22500, roas: 444, scoreA: 4.0, scoreB: 4.5, total: 4.25, insight: 'Top 소재', color: '#10b981', mediaInsight: 'SNS는 관심도(A)는 우수하나, CPA 개선을 위해 랜딩페이지 최적화(LPO)가 필요합니다.' },
                    { media: '네이버 쇼핑검색', creative: '소재_상품A', cost: 1200000, imp: 200000, click: 1500, conv: 50, revenue: 5000000, ctr: 0.0075, cpa: 24000, roas: 416, scoreA: 3.5, scoreB: 3.0, total: 3.25, insight: 'Potential 소재', color: '#3b82f6', mediaInsight: '쇼핑검색은 전환 볼륨(B)을 늘려야 합니다. 예산 증액보다는 소재(A) 개선 필요.' },
                    { media: '구글 GDN', creative: '소재_리타겟팅', cost: 1000000, imp: 400000, click: 500, conv: 20, revenue: 2000000, ctr: 0.00125, cpa: 50000, roas: 200, scoreA: 1.5, scoreB: 1.0, total: 1.25, insight: 'Low 소재', color: '#ef4444', mediaInsight: 'Low 효율 리타겟팅 캠페인은 즉시 OFF하거나 타겟팅 세그먼트를 매우 좁게 재설정해야 합니다.' },
                    { media: '페이스북/인스타', creative: '소재_영상A', cost: 1500000, imp: 700000, click: 3000, conv: 45, revenue: 6500000, ctr: 0.0043, cpa: 33333, roas: 433, scoreA: 3.8, scoreB: 2.2, total: 3.0, insight: 'Focus 소재', color: '#f59e0b', mediaInsight: 'SNS 영상 소재는 광고 관심도(A)가 높은 편이나, 낮은 전환 기여도(B)를 보입니다. 소재 메시지의 Call-to-Action(CTA) 명확화 필요.' },
                ],
            }
        };

        let sortColumn = 'total';
        let sortDirection = 'desc';
        let currentCampaign = 'DA';

        // --- NEW: Validation Table Logic & Data Setup ---
        
        const validationTableConfigs = {
            'DA': {
                label: 'DA 캠페인',
                cols: [
                    { name: '매체명', key: 'media', type: 'text', placeholder: '매체명', width: 'w-24' },
                    { name: '지면', key: 'placement', type: 'text', placeholder: '지면', width: 'w-24' },
                    { name: '소진 광고비(원)', key: 'cost', type: 'number', placeholder: '금액', width: 'w-24', isLargeNumber: true }, 
                    { name: '노출수', key: 'imp', type: 'number', placeholder: '횟수', width: 'w-20', isLargeNumber: true }, 
                    { name: '목표 CPM(원)', key: 'targetCpm', type: 'currency', placeholder: '목표CPM', width: 'w-24' },
                    { name: '성과 CPM(원)', key: 'actualCpm', type: 'currency', placeholder: '성과CPM', width: 'w-24', calculated: true },
                    { name: '클릭수', key: 'click', type: 'number', placeholder: '횟수', width: 'w-20', isLargeNumber: true }, 
                    { name: '목표 CPC(원)', key: 'targetCpc', type: 'currency', placeholder: '목표CPC', width: 'w-24' },
                    { name: '성과 CPC(원)', key: 'actualCpc', type: 'currency', placeholder: '성과CPC', width: 'w-24', calculated: true },
                    { name: '목표 CTR(%)', key: 'targetCtr', type: 'percent', placeholder: '목표CTR', width: 'w-24' },
                    { name: '성과 CTR(%)', key: 'actualCtr', type: 'percent', placeholder: '성과CTR', width: 'w-24', calculated: true },
                    { name: '조회수', key: 'view', type: 'number', placeholder: '횟수', width: 'w-20', isLargeNumber: true }, 
                    { name: '목표 CPV(원)', key: 'targetCpv', type: 'currency', placeholder: '목표CPV', width: 'w-24' },
                    { name: '성과 CPV(원)', key: 'actualCpv', type: 'currency', placeholder: '성과CPV', width: 'w-24', calculated: true },
                ],
            },
            'PERF': {
                label: '퍼포먼스 캠페인',
                cols: [
                    { name: '매체명', key: 'media', type: 'text', placeholder: '매체명', width: 'w-24' },
                    { name: '지면', key: 'placement', type: 'text', placeholder: '지면', width: 'w-24' },
                    { name: '소진 광고비(원)', key: 'cost', type: 'number', placeholder: '금액', width: 'w-24', isLargeNumber: true }, 
                    { name: '노출수', key: 'imp', type: 'number', placeholder: '횟수', width: 'w-20', isLargeNumber: true }, 
                    { name: '목표 CPM(원)', key: 'targetCpm', type: 'currency', placeholder: '목표CPM', width: 'w-24' },
                    { name: '성과 CPM(원)', key: 'actualCpm', type: 'currency', placeholder: '성과CPM', width: 'w-24', calculated: true },
                    { name: '클릭수', key: 'click', type: 'number', placeholder: '횟수', width: 'w-20', isLargeNumber: true }, 
                    { name: '목표 CPC(원)', key: 'targetCpc', type: 'currency', placeholder: '목표CPC', width: 'w-24' },
                    { name: '성과 CPC(원)', key: 'actualCpc', type: 'currency', placeholder: '성과CPC', width: 'w-24', calculated: true },
                    { name: '목표 CTR(%)', key: 'targetCtr', type: 'percent', placeholder: '목표CTR', width: 'w-24' },
                    { name: '성과 CTR(%)', key: 'actualCtr', type: 'percent', placeholder: '성과CTR', width: 'w-24', calculated: true },
                    // PERF Additions
                    { name: '전환수', key: 'conv', type: 'number', placeholder: '횟수', width: 'w-20', isLargeNumber: true }, 
                    { name: '목표 CPA(원)', key: 'targetCpa', type: 'currency', placeholder: '목표CPA', width: 'w-24' },
                    { name: '성과 CPA(원)', key: 'actualCpa', type: 'currency', placeholder: '성과CPA', width: 'w-24', calculated: true },
                    { name: '구매/가입액(원)', key: 'revenue', type: 'currency', placeholder: '금액', width: 'w-24', isLargeNumber: true }, 
                ],
            }
        };

        let isValidationTableOpen = false;
        const validationData = { 'DA': [], 'PERF': [] };

        const getEmptyRow = (campaign) => {
            const row = { id: crypto.randomUUID() };
            validationTableConfigs[campaign].cols.forEach(col => {
                row[col.key] = col.type === 'number' || col.type === 'currency' || col.type === 'percent' ? null : '';
            });
            return row;
        };
        validationData.DA.push(getEmptyRow('DA'));
        validationData.PERF.push(getEmptyRow('PERF'));

        const validationTableContent = document.getElementById('validation-table-content');
        const toggleValidationTableButton = document.getElementById('toggle-validation-table');
        const validationTableHeader = document.getElementById('validation-table-header');
        const validationTableBody = document.getElementById('validation-table-body');
        const validationCampaignLabel = document.getElementById('validation-campaign-label');
        const addValidationRowButton = document.getElementById('add-validation-row');

        function toggleValidationTable() {
            isValidationTableOpen = !isValidationTableOpen;
            const toggleIcon = document.getElementById('toggle-icon');
            const toggleText = document.getElementById('toggle-text');

            if (isValidationTableOpen) {
                validationTableContent.classList.remove('hidden');
                toggleText.textContent = '입력 테이블 접기';
                toggleIcon.classList.add('rotate-180');
            } else {
                validationTableContent.classList.add('hidden');
                toggleText.textContent = '입력 테이블 열기';
                toggleIcon.classList.remove('rotate-180');
            }
        }
        
        /**
         * Calculates actual performance metrics (CPM, CPC, CTR, CPV, CPA) for a given row.
         */
        function calculateValidationMetrics(row, campaignType) {
            // Note: cost, imp, click, view, conv are stored as actual numbers (not strings with commas)
            const { cost, imp, click, view, conv } = row;

            // Helper to handle division by zero or invalid input
            const safeDivide = (numerator, denominator) => {
                if (typeof numerator !== 'number' || typeof denominator !== 'number' || denominator === 0 || isNaN(numerator) || isNaN(denominator) || numerator === null || denominator === null) {
                    return null;
                }
                return numerator / denominator;
            };

            // Common metrics
            // CPM = (Cost / Imp) * 1000
            row.actualCpm = safeDivide(cost, imp) !== null ? safeDivide(cost, imp) * 1000 : null;
            // CPC = Cost / Click
            row.actualCpc = safeDivide(cost, click);
            // CTR = Click / Imp (Stored as fraction, e.g., 0.005)
            row.actualCtr = safeDivide(click, imp); 

            if (campaignType === 'DA') {
                // CPV = Cost / View
                row.actualCpv = safeDivide(cost, view);
                row.actualCpa = null; // Ensure CPA is null for DA
            } else if (campaignType === 'PERF') {
                // CPA = Cost / Conversion
                row.actualCpa = safeDivide(cost, conv);
                row.actualCpv = null; // Ensure CPV is null for PERF
            }
        }

        /**
         * CRITICAL FIX: Updates only the calculated columns in the DOM without destroying input focus.
         * @param {string} rowId - The unique ID of the row.
         * @param {object} rowData - The data object for the row.
         */
        function updateCalculatedColumnsInDOM(rowId, rowData) {
            // Find the table row element using the data-row-id attribute
            const rowElement = document.querySelector(`#validation-table-body tr[data-row-id="${rowId}"]`);
            if (!rowElement) return;

            const config = validationTableConfigs[currentCampaign];
            
            // Iterate through columns to find calculated fields
            config.cols.forEach((col, colIndex) => {
                if (col.calculated) {
                    // Get the cell element. (The first child of the row is index 0)
                    const td = rowElement.children[colIndex];
                    const inputElement = td.querySelector('input');
                    if (!inputElement) return;

                    const rawValue = rowData[col.key];
                    let displayValue = '-';
                    
                    if (rawValue !== null) {
                        if (col.type === 'currency') {
                            // Display as formatted currency number (without '원' in the input field)
                            displayValue = formatNumber(rawValue, 'currency').replace('원', ''); 
                        } else if (col.type === 'percent') {
                            // Display as percentage with 2 decimal places
                            displayValue = `${(rawValue * 100).toFixed(2)}%`; 
                        } else {
                            displayValue = rawValue.toFixed(2);
                        }
                    }

                    // Update the input field value
                    inputElement.value = displayValue;
                }
            });
        }


        function handleValidationInputChange(rowId, key, event) {
            const index = validationData[currentCampaign].findIndex(r => r.id === rowId);
            if (index > -1) {
                const config = validationTableConfigs[currentCampaign].cols.find(c => c.key === key);
                let inputValue = event.target.value;
                let rawValueToStore = inputValue; 
                
                // --- Input Parsing and Storage ---
                if (config.isLargeNumber) {
                    // --- Cursor Position Preservation Logic (REFINED) ---
                    const originalCursorPos = event.target.selectionStart;
                    const originalValue = event.target.value; 
                    
                    // 1. Clean the input (remove all non-digits)
                    const cleanValue = inputValue.replace(/[^\d]/g, ''); 
                    
                    // 2. Identify the prefix (digits only) up to the cursor in the original value
                    const originalValuePrefix = originalValue.substring(0, originalCursorPos);
                    const cleanPrefix = originalValuePrefix.replace(/[^\d]/g, '');
                    
                    // 3. Format the clean value for display (inserts commas)
                    const formattedValue = formatNumericInput(cleanValue);
                    event.target.value = formattedValue;
                    
                    // 4. Calculate the new cursor position
                    let newCursorPos = 0;
                    let digitCount = 0;
                    
                    for (let i = 0; i < formattedValue.length; i++) {
                        if (digitCount === cleanPrefix.length) {
                            newCursorPos = i;
                            break;
                        }
                        if (/\d/.test(formattedValue[i])) {
                            digitCount++;
                        }
                        newCursorPos = i + 1;
                    }
                    
                    // 5. Restore cursor position
                    // This is the key fix that prevents the cursor from jumping
                    event.target.setSelectionRange(newCursorPos, newCursorPos);
                    
                    // 6. Determine the raw value to store (parsed number or null)
                    rawValueToStore = cleanValue === '' ? null : parseInt(cleanValue, 10);
                } else if (config.type === 'number' || config.type === 'currency') {
                    // For non-large number/currency fields (e.g., targetCpm, targetCpc), allow decimals
                    const cleanValue = inputValue.replace(/[^\d.]/g, ''); 
                    rawValueToStore = cleanValue === '' || cleanValue === '.' ? null : parseFloat(cleanValue);
                } else if (config.type === 'percent') {
                    // For percentage inputs
                    const cleanValue = inputValue.replace(/[^\d.]/g, ''); 
                    rawValueToStore = cleanValue === '' || cleanValue === '.' ? null : parseFloat(cleanValue);
                } 
                
                // Update the stored data with the cleaned/parsed value
                validationData[currentCampaign][index][key] = rawValueToStore;
                
                // --- Targeted Calculation and DOM Update ---
                const baseMetrics = ['cost', 'imp', 'click', 'view', 'conv', 'revenue'];
                
                // Only update calculated fields if a base input metric changes
                if (baseMetrics.includes(key)) {
                    calculateValidationMetrics(validationData[currentCampaign][index], currentCampaign);
                    // CRITICAL FIX: Only update the calculated columns in the DOM
                    updateCalculatedColumnsInDOM(rowId, validationData[currentCampaign][index]);
                }
            }
        }
        
        function addValidationRow() {
            validationData[currentCampaign].push(getEmptyRow(currentCampaign));
            renderValidationTable();
        }

        function removeValidationRow(rowId) {
            validationData[currentCampaign] = validationData[currentCampaign].filter(r => r.id !== rowId);
            if (validationData[currentCampaign].length === 0) {
                 validationData[currentCampaign].push(getEmptyRow(currentCampaign));
            }
            renderValidationTable();
        }

        function renderValidationTable() {
            const config = validationTableConfigs[currentCampaign];
            validationCampaignLabel.textContent = config.label;
            
            // 1. Render Header (Unchanged)
            validationTableHeader.innerHTML = '';
            config.cols.forEach(col => {
                const th = document.createElement('th');
                th.className = `px-2 py-2 text-xs font-semibold text-gray-700 uppercase tracking-wider sticky top-0 bg-gray-200 border-r border-gray-300 ${col.width || 'w-24'}`;
                th.textContent = col.name;
                validationTableHeader.appendChild(th);
            });
            const actionTh = document.createElement('th');
            actionTh.className = 'px-1 py-2 text-xs font-semibold text-gray-700 sticky top-0 bg-gray-200 w-10';
            actionTh.textContent = '삭제';
            validationTableHeader.appendChild(actionTh);
            
            // 2. Render Body
            validationTableBody.innerHTML = '';
            validationData[currentCampaign].forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-t border-gray-200';
                tr.dataset.rowId = row.id; // Added for targeted DOM updates
                

                config.cols.forEach(col => {
                    const td = document.createElement('td');
                    td.className = 'p-1 text-xs whitespace-nowrap border-r border-gray-100';
                    
                    let rawValue = row[col.key];
                    let displayValue = rawValue === null ? '' : rawValue;
                    
                    const isCalculated = col.calculated;

                    if (isCalculated) {
                        // Calculated fields: Read-only, centered, specific styling
                        if (rawValue !== null) {
                            if (col.type === 'currency') {
                                // Remove '원' for a cleaner look in the input field
                                displayValue = formatNumber(rawValue, 'currency').replace('원', '');
                            } else if (col.type === 'percent') {
                                displayValue = `${(rawValue * 100).toFixed(2)}%`; 
                            } else {
                                displayValue = rawValue.toFixed(2);
                            }
                        } else {
                            displayValue = '-';
                        }
                        
                        const inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        inputElement.readOnly = true;
                        inputElement.className = 'w-full p-1 border rounded-md text-xs bg-gray-200 font-semibold text-gray-700 pointer-events-none text-center';
                        inputElement.value = displayValue;
                        td.appendChild(inputElement);

                    } else if (col.type === 'select') {
                        // Select input (Unchanged)
                        const inputElement = document.createElement('select');
                        inputElement.className = 'w-full p-1 border rounded-md text-xs bg-white';
                        col.options.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option;
                            opt.textContent = option;
                            if (rawValue === option) opt.selected = true;
                            inputElement.appendChild(opt);
                        });
                        inputElement.addEventListener('input', (e) => handleValidationInputChange(row.id, col.key, e));
                        td.appendChild(inputElement);

                    } else {
                        // Regular input (text/number/currency/percent)
                        const inputElement = document.createElement('input');
                        inputElement.type = 'text'; 
                        inputElement.placeholder = col.placeholder;
                        inputElement.className = `w-full p-1 border rounded-md text-xs focus:ring-indigo-500 focus:border-indigo-500 ${col.type === 'number' || col.type === 'currency' || col.type === 'percent' ? 'text-right' : 'text-left'}`;
                        
                        if (col.isLargeNumber && typeof rawValue === 'number') {
                            // Display the formatted number in the input field
                            inputElement.value = formatNumericInput(rawValue);
                        } else if (col.type === 'percent' && typeof rawValue === 'number') {
                            // For percent fields, we display the raw number the user entered
                            inputElement.value = rawValue;
                        } else {
                            inputElement.value = displayValue;
                        }

                        // Attach the input handler
                        inputElement.addEventListener('input', (e) => handleValidationInputChange(row.id, col.key, e));
                        td.appendChild(inputElement);
                    }

                    tr.appendChild(td);
                });
                
                // Action column
                const actionTd = document.createElement('td');
                actionTd.className = 'p-1 text-center';
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'X';
                deleteButton.className = 'text-red-500 hover:text-red-700 font-bold text-sm transition-colors p-1';
                deleteButton.addEventListener('click', () => removeValidationRow(row.id));
                actionTd.appendChild(deleteButton);
                tr.appendChild(actionTd);

                validationTableBody.appendChild(tr);
            });
        }
        // --- END Validation Table Logic ---

        // Number formatting function (unchanged)
        const formatNumber = (num, type) => {
            if (typeof num !== 'number' || isNaN(num)) return '-'; // Added NaN check
            switch (type) {
                case 'percent': return `${(num * 100).toFixed(2)}%`; // Assumes num is fraction (e.g., 0.005)
                case 'currency': return `${Math.round(num).toLocaleString('ko-KR')}원`;
                case 'score': return num.toFixed(2);
                default: return num.toLocaleString('ko-KR');
            }
        };

        const matrixContainer = document.getElementById('quadrant-matrix');
        const tableBody = document.getElementById('table-body');
        const tooltip = document.createElement('div');
        tooltip.id = 'chart-tooltip';
        tooltip.className = 'absolute p-2 bg-gray-800 text-white text-xs rounded-lg shadow-xl pointer-events-none opacity-0 transition-opacity duration-200 z-[100] whitespace-nowrap';
        document.body.appendChild(tooltip);

        // [Chart/Summary/Table/Insight Logic - unchanged from previous version]

        function renderChart() {
            const data = campaignData[currentCampaign];
            const matrixRect = matrixContainer.getBoundingClientRect();
            const W = matrixRect.width;
            const H = matrixRect.height;

            matrixContainer.querySelectorAll('.chart-dot').forEach(dot => dot.remove());

            const MIN_SCORE = 0;
            const MAX_SCORE = 5;
            const PADDING = 25;
            const plotW = W - 2 * PADDING;
            const plotH = H - 2 * PADDING;
            const scaleX = plotW / (MAX_SCORE - MIN_SCORE);
            const scaleY = plotH / (MAX_SCORE - MIN_SCORE);

            document.getElementById('summary-title').textContent = `(${data.name.split('(')[1].replace(')', '')})`;
            document.getElementById('chart-axes-label').textContent = `Y축: ${data.metrics.yAxis} | X축: ${data.metrics.xAxis}`;
            document.getElementById('x-axis-label').textContent = data.metrics.xAxis;
            document.getElementById('y-high-label').textContent = data.metrics.yAxis + ' (높음)';
            document.getElementById('y-low-label').textContent = data.metrics.yAxis + ' (낮음)';

            data.data.forEach((item, index) => {
                let x = PADDING + (item.scoreB - MIN_SCORE) * scaleX; 
                let y = H - PADDING - (item.scoreA - MIN_SCORE) * scaleY;

                const dot = document.createElement('div');
                dot.className = 'chart-dot';
                dot.style.backgroundColor = item.color;
                
                const DOT_SIZE = 14;
                x = Math.max(PADDING + DOT_SIZE / 2, Math.min(W - PADDING - DOT_SIZE / 2, x));
                y = Math.max(PADDING + DOT_SIZE / 2, Math.min(H - PADDING - DOT_SIZE / 2, y));

                dot.style.left = `${x - DOT_SIZE / 2}px`;
                dot.style.top = `${y - DOT_SIZE / 2}px`;
                
                dot.dataset.index = index;
                dot.dataset.campaign = currentCampaign;
                dot.dataset.creative = item.creative;
                dot.dataset.insight = item.insight;
                dot.dataset.scoreA = item.scoreA.toFixed(1);
                dot.dataset.scoreB = item.scoreB.toFixed(1);
                dot.dataset.total = item.total.toFixed(2);
                
                dot.addEventListener('mouseenter', showTooltip);
                dot.addEventListener('mousemove', moveTooltip);
                dot.addEventListener('mouseleave', hideTooltip);

                matrixContainer.appendChild(dot);
            });
        }
        
        function showTooltip(e) { 
            const item = e.target.dataset;
            const tooltipContent = `
                <div class="font-bold text-base">${item.creative}</div>
                <div class="mt-1">등급: ${item.insight}</div>
                <div class="mt-0.5 text-xs text-indigo-300">A Score: ${item.scoreA} | B Score: ${item.scoreB} | Total: ${item.total}</div>
            `;
            tooltip.innerHTML = tooltipContent;
            tooltip.classList.add('opacity-100');
            moveTooltip(e);
        }
        function moveTooltip(e) {
            let x = e.pageX + 15;
            let y = e.pageY - 15;
            
            // Boundary checks (basic)
            const tooltipRect = tooltip.getBoundingClientRect();
            if (x + tooltipRect.width > window.innerWidth) {
                x = e.pageX - tooltipRect.width - 15;
            }
            if (y + tooltipRect.height > window.innerHeight) {
                y = window.innerHeight - tooltipRect.height - 10;
            }

            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;
        }
        function hideTooltip() { 
            tooltip.classList.remove('opacity-100');
        }

        function renderSummaryTable() {
            const data = campaignData[currentCampaign];
            const headerRow = document.getElementById('summary-header');
            const body = document.getElementById('summary-body');
            headerRow.innerHTML = '';
            body.innerHTML = '';

            data.summary.forEach(metric => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-center';
                th.textContent = metric.label;
                headerRow.appendChild(th);
            });

            const tr = document.createElement('tr');
            tr.className = 'text-gray-900';
            data.summary.forEach(metric => {
                const td = document.createElement('td');
                td.className = 'px-6 py-4 whitespace-nowrap text-center text-lg font-bold';
                
                let displayValue = metric.value;
                if (metric.type === 'percent') {
                    // This assumes summary value (e.g., 500 for 500% ROAS) is already scaled.
                    td.textContent = `${displayValue.toLocaleString('ko-KR')}%`; 
                } else if (metric.type === 'currency' || metric.type === 'number') {
                    td.textContent = formatNumber(displayValue, metric.type);
                } else {
                    td.textContent = displayValue;
                }

                tr.appendChild(td);
            });
            body.appendChild(tr);
        }

        function sortData(key) {
            if (sortColumn === key) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = key;
                sortDirection = 'desc';
            }

            const data = campaignData[currentCampaign].data;

            data.sort((a, b) => {
                const aVal = a[key];
                const bVal = b[key];

                let comparison = 0;
                if (aVal > bVal) {
                    comparison = 1;
                } else if (aVal < bVal) {
                    comparison = -1;
                }

                return sortDirection === 'asc' ? comparison : comparison * -1;
            });

            renderTable();
        }

        function renderTable() {
            const data = campaignData[currentCampaign];
            const headerRow = document.getElementById('table-header');
            tableBody.innerHTML = '';
            headerRow.innerHTML = '';

            data.headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left border-b border-gray-200 text-center sortable whitespace-nowrap';
                th.textContent = header.name;
                th.dataset.key = header.key;
                th.addEventListener('click', () => sortData(header.key));
                
                if (sortColumn === header.key) {
                    th.textContent += sortDirection === 'asc' ? ' ▲' : ' ▼';
                }

                headerRow.appendChild(th);
            });

            data.data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-indigo-50 transition-colors';
                
                const keys = data.headers.map(h => h.key);
                
                keys.forEach(key => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-600 text-center';
                    
                    let cellValue = item[key];

                    switch(key) {
                        case 'cost':
                        case 'revenue':
                        case 'cpm':
                        case 'cpc':
                        case 'cpa':
                            td.textContent = formatNumber(cellValue, 'currency');
                            break;
                        case 'imp':
                        case 'click':
                        case 'conv':
                            td.textContent = formatNumber(cellValue, 'number');
                            break;
                        case 'ctr':
                            td.textContent = formatNumber(cellValue, 'percent');
                            break;
                        case 'roas':
                            td.textContent = `${cellValue.toLocaleString('ko-KR')}%`;
                            break;
                        case 'scoreA':
                        case 'scoreB':
                        case 'total':
                            td.textContent = formatNumber(cellValue, 'score');
                            td.classList.add('font-bold', 'text-gray-800');
                            break;
                        case 'insight':
                            td.innerHTML = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color:${item.color}1A; color:${item.color}">${cellValue}</span>`;
                            break;
                        case 'action':
                            const action = item.total < 2.5 ? 'OFF/교체' : '유지/확대';
                            const colorClass = item.total < 2.5 ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100';
                            td.innerHTML = `<span class="font-bold rounded-lg px-2 py-1 ${colorClass}">${action}</span>`;
                            break;
                        default:
                            td.textContent = cellValue;
                            td.classList.remove('text-center');
                            td.classList.add('text-left');
                            break;
                    }
                    tr.appendChild(td);
                });

                tableBody.appendChild(tr);
            });
        }

        function renderInsights() {
            const data = campaignData[currentCampaign];
            const insightList = document.getElementById('insight-list');
            insightList.innerHTML = '';

            const gradeInsights = {};
            data.data.forEach(item => {
                if (!gradeInsights[item.insight]) {
                    gradeInsights[item.insight] = [];
                }
                gradeInsights[item.insight].push({ 
                    media: item.media, 
                    insight: item.mediaInsight,
                    color: item.color
                });
            });

            const insightOrder = ['Top 소재', 'Potential 소재', 'Focus 소재', 'Low 소재'];

            insightOrder.forEach(grade => {
                const items = gradeInsights[grade];
                if (items && items.length > 0) {
                    const gradeColor = items[0].color;
                    const gradeHeader = document.createElement('li');
                    gradeHeader.className = 'pt-2 mb-2 font-extrabold text-base border-b-2 pb-1';
                    gradeHeader.style.borderColor = gradeColor;
                    gradeHeader.style.color = gradeColor;
                    gradeHeader.textContent = `[${grade}] 핵심 전략 (${items.length}개 소재)`;
                    insightList.appendChild(gradeHeader);

                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'text-gray-700 text-sm flex items-start';
                        li.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mt-1 mr-2 flex-shrink-0" style="color:${gradeColor}" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                            <span class="font-semibold text-gray-900">${item.media}:</span> <span>${item.insight}</span>
                        `;
                        insightList.appendChild(li);
                    });
                }
            });
        }

        function renderDashboard() {
            // Reset sorting when switching campaigns
            sortColumn = 'total';
            sortDirection = 'desc';

            // Update Tab State
            document.querySelectorAll('.campaign-tab').forEach(tab => {
                if (tab.dataset.camp === currentCampaign) {
                    tab.classList.replace('text-gray-600', 'text-white');
                    tab.classList.add('bg-indigo-600', 'shadow-lg');
                    tab.classList.remove('hover:bg-white', 'hover:text-indigo-600');
                } else {
                    tab.classList.replace('text-white', 'text-gray-600');
                    tab.classList.remove('bg-indigo-600', 'shadow-lg');
                    tab.classList.add('hover:bg-white', 'hover:text-indigo-600');
                }
            });

            // New: Render Validation Table for the current campaign
            renderValidationTable();

            renderSummaryTable();
            renderTable();
            renderChart();
            renderInsights();
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.campaign-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    currentCampaign = e.target.dataset.camp;
                    renderDashboard();
                });
            });
            
            toggleValidationTableButton.addEventListener('click', toggleValidationTable);
            addValidationRowButton.addEventListener('click', addValidationRow);

            // Initial render
            // Before initial render, calculate metrics for default rows
            validationData.DA.forEach(row => calculateValidationMetrics(row, 'DA'));
            validationData.PERF.forEach(row => calculateValidationMetrics(row, 'PERF'));
            
            renderDashboard();

            // Handle window resize for chart responsiveness
            window.addEventListener('resize', renderChart);
        });
    </script>
</body>
</html>

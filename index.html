<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µí•© DA/í¼í¬ë¨¼ìŠ¤ ìº í˜ì¸ ì‹¬ì¸µ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse CSV Library CDN (REMOVED) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .scroll-container::-webkit-scrollbar { height: 8px; }
        .scroll-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .scroll-container::-webkit-scrollbar-track { background: #f1f5f9; }
        
        /* [NEW] 5ë‹¨ê³„: ìƒ˜í”Œ ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #sample-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        #sample-modal-content {
            max-width: 90vw;
            width: 1200px; /* ëª¨ë‹¬ ë„ˆë¹„ ê³ ì • */
            max-height: 80vh;
        }
        /* [NEW] 5ë‹¨ê³„: ìƒ˜í”Œ ëª¨ë‹¬ ë‚´ë¶€ ì°¨íŠ¸ìš© */
        .sample-quadrant-matrix {
            position: relative;
            width: 100%;
            height: 300px; /* ëª¨ë‹¬ìš© ì¶•ì†Œ ì‚¬ì´ì¦ˆ */
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }
        /* [NEW] 5ë‹¨ê³„: ìƒ˜í”Œ ëª¨ë‹¬ ë‚´ë¶€ ì¿¼ë“œëŸ°íŠ¸ */
        .sample-quadrant {
             padding: 0.5rem;
             display: flex;
             flex-direction: column; /* [FIX] 5ë‹¨ê³„: h3, p íƒœê·¸ ìˆ˜ì§ ì •ë ¬ */
             justify-content: center; 
             align-items: center; 
             position: relative;
             z-index: 10;
             text-align: center;
        }
        .sample-quadrant h3 { font-size: 1rem; font-weight: 800; }
        .sample-quadrant p { font-size: 0.75rem; margin-top: 4px; }
        /* 4-Quadrant Matrix Styling */
        .quadrant-matrix {
            position: relative;
            width: 100%;
            height: 480px; 
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
        }
        .quadrant {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            position: relative;
            z-index: 10;
        }
        /* Quadrant Colors & Labels for Intuitive Interpretation */
        .quadrant-top-right { background-color: rgba(16, 185, 129, 0.05); } /* Top-Right */
        .quadrant-top-left { background-color: rgba(59, 130, 246, 0.05); } /* Top-Left */
        .quadrant-bottom-right { background-color: rgba(245, 158, 11, 0.05); } /* Bottom-Right */
        .quadrant-bottom-left { background-color: rgba(239, 68, 68, 0.05); } /* Bottom-Left */
        
        .quadrant-label {
            display: none;
        }
        
        /* Quadrant Middle Lines (New Improvement) */
        .matrix-lines {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 20;
        }
        .v-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            border-left: 2px dashed #9ca3af; /* Gray dashed line for mid-point */
            transform: translateX(-1px);
        }
        .h-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            border-top: 2px dashed #9ca3af; /* Gray dashed line for mid-point */
            transform: translateY(-1px);
        }
        .chart-dot {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 50;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid #fff;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
        }
        .chart-dot:hover {
            transform: scale(1.5);
            z-index: 60;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        /* [MODIFY] (í•­ëª© 7) 5ë‹¨ê³„: PM ì  ìŠ¤íƒ€ì¼ (DA ì ê³¼ ë™ì¼, radiusë§Œ ë‹¤ë¦„) */
        .chart-dot-perf {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 3px; /* Square with slightly rounded corners */
            cursor: pointer;
            z-index: 49; /* Slightly behind the main dot if overlapping */
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid #fff; /* [MODIFY] (í•­ëª© 7) í°ìƒ‰ í…Œë‘ë¦¬ */
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
            /* background-colorëŠ” JSì—ì„œ item.colorë¡œ ì ìš© */
        }
        .chart-dot-perf:hover {
            transform: scale(1.5);
            z-index: 59;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .sortable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sortable:hover {
            background-color: #e5e7eb;
        }
        
        /* Custom styles for validation table headers */
        #validation-input-table thead th {
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #e5e7eb; /* Light gray border for separation */
        }
        #validation-input-table thead tr:first-child th {
            border-bottom: none; /* No double line between first and second header row */
            border-right: 1px solid #d1d5db; /* Darker line for group separation */
        }
        #validation-input-table thead tr:last-child th {
             border-right: 1px solid #e5e7eb; /* Separator for bottom row cells */
             padding-top: 4px; /* Adjust padding for better look */
        }
        
        /* Style for header sub-text */
        .header-subtext {
            display: block;
            font-size: 0.65rem; /* 10.4px */
            font-weight: 500;
            color: #4b5563; /* gray-600 */
            margin-top: 1px;
        }
        
        /* Style for prefill input text */
        .input-prefill {
            color: #9ca3af; /* gray-400 */
        }
        .input-prefill:focus {
            color: #111827; /* gray-900 (default text color) */
        }
        
        /* [NEW] ì•ˆì •í™” 1: ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #custom-modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            transition: opacity 0.2s ease-in-out;
        }
        #custom-modal-content {
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }
        #custom-modal-backdrop:not(.hidden) #custom-modal-content {
            transform: scale(1);
        }
        
    </style>
</head>
<body class="p-4 md:p-8"> <!-- ì¢Œìš° íŒ¨ë”©ì„ ì¤„ì˜€ìŠµë‹ˆë‹¤ -->
    <div id="app" class="w-full mx-auto bg-white rounded-xl shadow-2xl p-8 md:p-12">
        <!-- Header and Campaign Selector -->
        <header class="mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">í†µí•© ìº í˜ì¸ ì„±ê³¼ ì‹¬ì¸µ ë¶„ì„ ëŒ€ì‹œë³´ë“œ (PC)</h1>
            <p class="text-gray-500">DA/í¼í¬ë¨¼ìŠ¤ ëª©í‘œë³„ íš¨ìœ¨ ë¶„ì„ ë° ì†Œì¬ ë“±ê¸‰ë³„ ì§ê´€ì  ì¸ì‚¬ì´íŠ¸ ë„ì¶œ</p>
        </header>
        <!-- [NEW] Project Selector (í•­ëª© 2) -->
        <div class="mb-8 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <label for="project-selector" class="text-lg font-bold text-gray-800">í”„ë¡œì íŠ¸:</label>
                <select id="project-selector" class="rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <!-- Projects will be loaded here by JS -->
                </select>
                <!-- [NEW] (í•­ëª© 10) 5ë‹¨ê³„: í”„ë¡œì íŠ¸ ì‚­ì œ ë²„íŠ¼ -->
                <button id="delete-project-button" class="bg-red-500 text-white hover:bg-red-600 text-xs font-semibold py-1 px-3 rounded-md transition-colors" title="í˜„ì¬ í”„ë¡œì íŠ¸ ì‚­ì œ">ì‚­ì œ</button>
            </div>
            <button id="new-project-button" class="bg-green-500 text-white hover:bg-green-600 text-sm font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-1"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                ìƒˆ í”„ë¡œì íŠ¸
            </button>
        </div>
        
        <!-- Campaign Validation Input Section -->
        <div id="validation-section" class="mb-10">
            <!-- Title and Toggle Button -->
            <div class="flex items-center justify-between mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold text-gray-800">
                    ìº í˜ì¸ ëª©í‘œ & ì„±ê³¼ ê²€ì¦ í•­ëª© ì…ë ¥
                </h2>
                <!-- [MODIFY] (í•­ëª© 1) 5ë‹¨ê³„: ë²„íŠ¼ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ìŒ -->
                <div class="flex items-center space-x-2">
                    <!-- [NEW] (í•­ëª© 1) 5ë‹¨ê³„: ìƒ˜í”Œ ë³´ê¸° ë²„íŠ¼ -->
                    <button id="show-sample-modal-button" class="bg-gray-500 text-white hover:bg-gray-600 text-sm font-semibold py-2 px-4 rounded-lg transition-colors">
                        [ìƒ˜í”Œ ë³´ê¸°]
                    </button>
                    <button id="toggle-validation-table" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 text-sm font-semibold py-2 px-4 rounded-lg transition-colors flex items-center">
                        <span id="toggle-text">ì…ë ¥ í…Œì´ë¸” ì ‘ê¸°</span> 
                        <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-1 transform transition-transform rotate-180"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
            <!-- Collapsible Input Table Container (Removed 'hidden' class) -->
            <div id="validation-table-content" class="transition-all duration-300 overflow-hidden">
                <div class="bg-gray-50 p-4 rounded-xl shadow-inner border">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-sm text-gray-600">
                            <span id="validation-campaign-label" class="font-bold text-indigo-600">í†µí•© ìº í˜ì¸</span> íš¨ìœ¨ ê²€ì¦ í•­ëª©ì„ ì§ì ‘ ê¸°ì¬í•´ì£¼ì„¸ìš”. <!-- (í•­ëª© 1) ë¬¸êµ¬ ìˆ˜ì • -->
                        </p>
                        <!-- *** (LocalStorage) NEW: ë²„íŠ¼ ê·¸ë£¹ *** -->
                        <div class="flex items-center space-x-2">
                            <span id="save-status" class="text-sm text-green-600 font-medium hidden">ì €ì¥ë¨!</span>
                            <button id="save-data-button" class="bg-blue-500 text-white hover:bg-blue-600 text-xs font-semibold py-1 px-3 rounded-md transition-colors">
                                  ğŸ’¾   í˜„ì¬ ë‚´ìš© ì €ì¥
                            </button>
                            <button id="reset-data-button" class="bg-red-500 text-white hover:bg-red-600 text-xs font-semibold py-1 px-3 rounded-md transition-colors">
                                  ğŸ”„   ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                            </button>
                            <button id="add-validation-row" class="bg-green-500 text-white hover:bg-green-600 text-xs font-semibold py-1 px-3 rounded-md transition-colors">
                                + í•­ëª© ì¶”ê°€
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table id="validation-input-table" class="min-w-full divide-y divide-gray-200 border-separate border-spacing-0">
                            <thead id="validation-table-header" class="bg-gray-100 sticky top-0">
                                <!-- Table Headers will be injected here (2 rows) -->
                            </thead>
                            <tbody id="validation-table-body">
                                <!-- Input Rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analysis Trigger Button (Keep for manual re-run) -->
        <div class="mb-10 text-center">
            <button id="run-analysis-button" class="bg-blue-600 text-white hover:bg-blue-700 text-xl font-bold py-3 px-8 rounded-xl shadow-xl transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                   ğŸ“Š    ì…ë ¥ ë°ì´í„° ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ ë¶„ì„ ì¬ì‹¤í–‰
            </button>
        </div>
        <!-- Analysis Results Container (REMOVED 'hidden' class) -->
        <div id="analysis-results"> 
            <!-- 1. Overall Performance Summary Table -->
            <div class="mb-10">
                <!-- *** ìˆ˜ì •: (2.1) <h2>ì— ID ì¶”ê°€ *** -->
                <h2 id="summary-main-title" class="text-2xl font-bold text-gray-800 mb-4">
                    ì¢…í•© ì„±ê³¼ ìš”ì•½ 
                    <span id="summary-title" class="text-indigo-600 text-lg ml-2"></span>
                </h2>
                <!-- *** ìˆ˜ì •: (2.4) ê°€ë¡œ ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì¶”ê°€ *** -->
                <div class="scroll-container overflow-x-auto rounded-xl shadow-lg border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50">
                            <tr id="summary-header" class="text-sm font-semibold text-indigo-700 uppercase tracking-wider">
                                <!-- Summary Headers -->
                            </tr>
                        </thead>
                        <tbody id="summary-body" class="bg-white divide-y divide-gray-200">
                            <!-- Summary Data -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- 2. Visualization and Insights (3-Column Layout) -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-10">
                
                <!-- Left 2/3: 4-Quadrant Matrix (Existing Logic) -->
                <div class="xl:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <!-- *** (Problem 4) ìˆ˜ì •: íƒ€ì´í‹€ ë³€ê²½ *** -->
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            ì†Œì¬ ì„±ê³¼ ë§¤íŠ¸ë¦¬ìŠ¤
                            <!-- *** (Problem 2) ìˆ˜ì •: ë¶€ì œ span ì‚­ì œ *** -->
                        </h2>
                        
                        <div class="quadrant-matrix" id="quadrant-matrix">
                            <!-- Quadrant Lines (NEW) -->
                            <div class="matrix-lines">
                                <div class="v-line"></div>
                                <div class="h-line"></div>
                            </div>
                            
                            <!-- *** (Problem 1) ìˆ˜ì •: Top-Leftì™€ Top-Right ìˆœì„œ ë³€ê²½ *** -->
                            
                            <!-- Quadrant 1 -> 2: Top Left (Potential) -->
                            <div class="quadrant quadrant-top-left">
                                <!-- *** (Request 1) ìˆ˜ì •: h-full ì œê±°, justify-center ì¶”ê°€ *** -->
                                <div class="relative z-10 flex flex-col justify-center text-center">
                                    <h3 class="text-xl font-extrabold text-blue-700">High Potential</h3>
                                    <p class="text-sm text-gray-500 mt-2">ë…¸ì¶œ íš¨ìœ¨(Low) ì†Œì¬ ë§¤ë ¥ë„(High)</p>
                                    <p class="text-sm text-gray-700 mt-2">í›…í‚¹ì„±ì€ ë†’ì§€ë§Œ ì˜ ì•Œë ¤ì§€ì§€ ì•Šì€ ì†Œì¬</p>
                                    <div class="mt-4">
                                        <span class="inline-block py-1 px-3 rounded-full text-sm font-semibold text-blue-800 bg-blue-100">
                                            Action : íƒ€ê²ŸíŒ… í™•ì¥
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Quadrant 2 -> 1: Top Right (Top) -->
                            <div class="quadrant quadrant-top-right">
                                <!-- *** (Request 1) ìˆ˜ì •: h-full ì œê±°, justify-center ì¶”ê°€ *** -->
                                <div class="relative z-10 flex flex-col justify-center text-center">
                                    <h3 class="text-xl font-extrabold text-green-700">STAR</h3>
                                    <p class="text-sm text-gray-500 mt-2">ë…¸ì¶œ íš¨ìœ¨(High) ì†Œì¬ ë§¤ë ¥ë„(High)</p>
                                    <p class="text-sm text-gray-700 mt-2">ëŒ€ì¤‘ì ìœ¼ë¡œ ê°€ì¥ ë°˜ì‘ì´ ìš°ìˆ˜í•œ ì†Œì¬</p>
                                    <div class="mt-4">
                                        <span class="inline-block py-1 px-3 rounded-full text-sm font-semibold text-green-800 bg-green-100">
                                            Action : ìœ ì§€ / ì˜ˆì‚° ì¦ëŒ€
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Quadrant 3: Bottom Left (Low) -->
                            <div class="quadrant quadrant-bottom-left">
                                <!-- *** (Request 1) ìˆ˜ì •: h-full ì œê±°, justify-center ì¶”ê°€ *** -->
                                <div class="relative z-10 flex flex-col justify-center text-center">
                                    <h3 class="text-xl font-extrabold text-red-700">Question Mark</h3>
                                    <p class="text-sm text-gray-500 mt-2">ë…¸ì¶œ íš¨ìœ¨(Low) ì†Œì¬ ë§¤ë ¥ë„(Low)</p>
                                    <p class="text-sm text-gray-700 mt-2">ì˜ˆì‚° ë‚­ë¹„ ê°€ëŠ¥ì„±ì´ ë†’ì€ ì†Œì¬</p>
                                    <div class="mt-4">
                                        <span class="inline-block py-1 px-3 rounded-full text-sm font-semibold text-red-800 bg-red-100">
                                            Action : ê´‘ê³ OFF / ì˜ˆì‚°ì´ê´€
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Quadrant 4: Bottom Right (Focus) -->
                            <div class="quadrant quadrant-bottom-right">
                                <!-- *** (Request 1) ìˆ˜ì •: h-full ì œê±°, justify-center ì¶”ê°€ *** -->
                                <div class="relative z-10 flex flex-col justify-center text-center">
                                    <h3 class="text-xl font-extrabold text-amber-700">Niche</h3>
                                    <p class="text-sm text-gray-500 mt-2">ë…¸ì¶œ íš¨ìœ¨(High) ì†Œì¬ ë§¤ë ¥ë„(Low)</p>
                                    <p class="text-sm text-gray-700 mt-2">ì†Œìˆ˜ì˜ ì§‘ë‹¨ì—ì„œ ë°˜ì‘ì´ ë†’ì€ ì†Œì¬</p>
                                    <div class="mt-4">
                                        <span class="inline-block py-1 px-3 rounded-full text-sm font-semibold text-amber-800 bg-amber-100">
                                            Action : ë²”ìš©ì  ì†Œì¬ / í›…í‚¹ì„± ê°•í™”
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <!-- Dots are injected here -->
                        </div>
                        
                        <!-- *** (Problem 3) ìˆ˜ì •: í•˜ë‹¨ ë¼ë²¨ í…ìŠ¤íŠ¸ ì „ì²´ ì‚­ì œ *** -->
                    </div>
                </div>
                <!-- Right 1/3: Key Insights (Existing Logic) -->
                <div class="xl:col-span-1 space-y-6">
                    <div class="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200 h-full">
                        <!-- *** ìˆ˜ì •: (2.1) íƒ€ì´í‹€ ë³€ê²½ *** -->
                        <h2 class="text-2xl font-bold text-indigo-700 mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                            MEDIA INSIGHT
                        </h2>
                        <ul id="insight-list" class="space-y-4 text-gray-700 text-sm">
                            <!-- Insights will be injected here -->
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- 3. Efficiency Data Table (Existing Logic) -->
            <div class="mt-10">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ìº í˜ì¸ ìƒì„¸ íš¨ìœ¨ ì§€í‘œ (ì†Œì¬ë³„)</h2>
                <div class="scroll-container overflow-x-auto rounded-xl shadow-inner border">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr id="table-header" class="text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <!-- Headers will be injected here -->
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- [NEW] (í•­ëª© 1) 5ë‹¨ê³„: ìƒ˜í”Œ ë³´ê¸° ëª¨ë‹¬ -->
    <div id="sample-modal-backdrop" class="fixed inset-0 z-[100] hidden items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.5);">
        <div id="sample-modal-content" class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-6xl max-h-[80vh]">
            <header class="flex items-center justify-between p-4 border-b bg-gray-50">
                <h2 class="text-xl font-bold text-gray-800">[ìƒ˜í”Œ ë°ì´í„°] Top/Mid/Low ì˜ˆì‹œ</h2>
                <button id="sample-modal-close-button" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>
                </button>
            </header>
            <div id="sample-modal-body" class="p-6 overflow-auto" style="max-height: calc(80vh - 65px);">
                <!-- [MODIFY] (í•­ëª© 2) 5ë‹¨ê³„: ìƒ˜í”Œ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë Œë”ë§ë©ë‹ˆë‹¤. -->
                <p class="text-center text-gray-500">ìƒ˜í”Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>
    </div>
    
    <!-- [NEW] ì•ˆì •í™” 1: ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ HTML -->
    <div id="custom-modal-backdrop" class="fixed inset-0 z-[200] hidden items-center justify-center p-4">
        <div id="custom-modal-content" class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-md">
            <header class="flex items-center justify-between p-4 border-b bg-gray-50">
                <h2 id="custom-modal-title" class="text-lg font-bold text-gray-900">í™•ì¸</h2>
            </header>
            <div class="p-6">
                <p id="custom-modal-message" class="text-gray-700">ì´ ì‘ì—…ì„ ì •ë§ë¡œ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            </div>
            <footer class="flex justify-end space-x-3 p-4 bg-gray-50">
                <button id="custom-modal-cancel" class="bg-gray-200 text-gray-800 hover:bg-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors">
                    ì·¨ì†Œ
                </button>
                <button id="custom-modal-confirm" class="bg-red-500 text-white hover:bg-red-600 font-semibold py-2 px-4 rounded-lg transition-colors">
                    í™•ì¸
                </button>
            </footer>
        </div>
    </div>
    
    <script>
        // Firebase Config (Mandatory, though not used for persistence here)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        // [NEW] (í•­ëª© 2) í”„ë¡œì íŠ¸ë³„ ì €ì¥ì„ ìœ„í•´ í‚¤ êµ¬ì¡° ë³€ê²½
        const DASHBOARD_STORAGE_KEY = 'campaignDashboardStorage';
        
        // [NEW] (í•­ëª© 5) í¼í¬ë¨¼ìŠ¤ ì…ë ¥ì°½ í‘œì‹œ ìƒíƒœ
        let isPerfInputVisible = false; 
        
        // [NEW] (í•­ëª© 2) í˜„ì¬ ì„ íƒëœ í”„ë¡œì íŠ¸
        let currentProject = 'default';
        
        // *** ìˆ˜ì •: (1.2) ì „ì—­ í”Œë˜ê·¸ ì¶”ê°€ ***
        let isPrefillActive = true; 
        
        // [NEW] (í•­ëª© 2) Function to save data
        function saveDataToLocalStorage() {
            try {
                // validationData í¬ì¸í„°ê°€ ì•„ë‹Œ, storageData ì „ì²´ë¥¼ ì €ì¥
                localStorage.setItem(DASHBOARD_STORAGE_KEY, JSON.stringify(storageData));
                
                // (LocalStorage) NEW: Show save status
                const saveStatus = document.getElementById('save-status');
                saveStatus.classList.remove('hidden');
                setTimeout(() => {
                    saveStatus.classList.add('hidden');
                }, 2000); // 2ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¹€
                
            } catch (e) {
                console.error("Error saving to localStorage", e);
                // (Optional) UI alert if storage is full
            }
        }
        
        // [NEW] ì•ˆì •í™” 1: ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ ë¡œì§
        let modalResolve = null;
        
        function showCustomConfirm(title, message, confirmText = 'í™•ì¸', confirmColor = 'red') {
            const modalBackdrop = document.getElementById('custom-modal-backdrop');
            const modalTitle = document.getElementById('custom-modal-title');
            const modalMessage = document.getElementById('custom-modal-message');
            const modalConfirm = document.getElementById('custom-modal-confirm');
            
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirm.textContent = confirmText;
            
            // ë²„íŠ¼ ìƒ‰ìƒ í´ë˜ìŠ¤ ì´ˆê¸°í™”
            modalConfirm.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-blue-500', 'hover:bg-blue-600');
            
            if (confirmColor === 'red') {
                modalConfirm.classList.add('bg-red-500', 'hover:bg-red-600');
            } else if (confirmColor === 'blue') {
                modalConfirm.classList.add('bg-blue-500', 'hover:bg-blue-600');
            }
            
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('flex');
            
            return new Promise((resolve) => {
                modalResolve = resolve; // Promiseì˜ resolve í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ì €ì¥
            });
        }
        
        function hideCustomModal() {
            const modalBackdrop = document.getElementById('custom-modal-backdrop');
            modalBackdrop.classList.add('hidden');
            modalBackdrop.classList.remove('flex');
        }
        
        // Helper function for formatting numbers with commas
        const formatNumericInput = (value) => {
            // Remove all non-digit characters
            const cleanValue = value.toString().replace(/[^\d]/g, ''); 
            if (cleanValue === '') return '';
            // Add thousand separators
            return parseInt(cleanValue, 10).toLocaleString('ko-KR');
        };
        // Helper function for formatting numbers for display
        const formatNumber = (num, type) => {
            if (typeof num !== 'number' || isNaN(num) || num === null) return '-';
            switch (type) {
                case 'percent': return `${(num * 100).toFixed(2)}%`; // Assumes num is fraction (e.g., 0.005)
                case 'currency': return `${Math.round(num).toLocaleString('ko-KR')}ì›`;
                case 'score': return num.toFixed(2);
                default: return num.toLocaleString('ko-KR');
            }
        };
        // (í•­ëª© 1) Mock data structure (í†µí•©)
        const campaignData = {
            'MAIN': { // 'DA' -> 'MAIN'
                name: 'í†µí•© ìº í˜ì¸', // ì´ë¦„ ë³€ê²½
                metrics: { xAxis: 'ì†Œì¬ ê´€ì‹¬ë„ (B)', yAxis: 'ìœ íš¨ ë…¸ì¶œ ê¸°ì—¬ë„ (A)' },
                // [MODIFY] (í•­ëª© 7) 5ë‹¨ê³„: í—¤ë” 2ê°œ -> 4ê°œë¡œ ë¶„ë¦¬
                headers: [ 
                    { name: 'ë§¤ì²´', key: 'media' }, 
                    { name: 'ìƒí’ˆ', key: 'placement' },
                    { name: 'ì†Œì¬ëª…', key: 'creativeName' },
                    { name: 'ê´‘ê³ ë¹„(ì›)', key: 'cost' },
                    { name: 'ë…¸ì¶œìˆ˜', key: 'imp' },
                    { name: 'í´ë¦­ìˆ˜', key: 'click' },
                    { name: 'CPM(ì›)', key: 'cpm' }, 
                    { name: 'CTR(%)', key: 'ctr' }, 
                    { name: 'CPC(ì›)', key: 'cpc' },
                    { name: 'ì „í™˜ìˆ˜', key: 'conv' }, 
                    { name: 'ë§¤ì¶œì•¡(ì›)', key: 'revenue' },
                    { name: 'ì„±ê³¼ CVR(%)', key: 'actualCvr' },
                    { name: 'ì„±ê³¼ CPA(ì›)', key: 'actualCpa' },
                    { name: 'ROAS(%)', key: 'roas' },
                    // ì ìˆ˜
                    { name: 'A ì ìˆ˜', key: 'scoreA' }, 
                    { name: 'B ì ìˆ˜', key: 'scoreB' }, 
                    { name: 'C ì ìˆ˜', key: 'scoreC' },
                    // [REMOVED] (í•­ëª© 2) 5ë‹¨ê³„: ì´ì  ìˆ¨ê¸°ê¸°
                    // { name: 'ì´ì ', key: 'total' }, 
                    // [NEW] (í•­ëª© 7) 5ë‹¨ê³„: 4ê°œ ì—´ë¡œ ë¶„ë¦¬
                    { name: 'DA ì¸ì‚¬ì´íŠ¸', key: 'daInsightGrade' }, 
                    { name: 'DA í”¼ë“œë°±', key: 'daFeedback' },
                    { name: 'PM ì¸ì‚¬ì´íŠ¸', key: 'pmInsightGrade' },
                    { name: 'PM í”¼ë“œë°±', key: 'pmFeedback' }
                ],
                data: [ // [MODIFY] (í•­ëª© 6) 5ë‹¨ê³„: 'ë²„ì¦ˆë¹Œ' ìƒ˜í”Œ ì‚­ì œ
                    { media: 'ë„¤ì´ë²„', creative: 'ì†Œì¬A_ìŠ¤í˜ì…œDA', cost: 11480000, imp: 7200000, click: 16000, cpm: null, ctr: null, cpc: null, scoreA: null, scoreB: null, total: null, insight: null, color: null, mediaInsight: null },
                    { media: 'ì¹´ì¹´ì˜¤', creative: 'ì†Œì¬B_ë¹„ì¦ˆë³´ë“œ', cost: 150000000, imp: 170000000, click: 250000, cpm: null, ctr: null, cpc: null, scoreA: null, scoreB: null, total: null, insight: null, color: null, mediaInsight: null },
                    { media: 'êµ¬ê¸€', creative: 'ì†Œì¬C_GDN', cost: 80000000, imp: 9500000, click: 25000, cpm: null, ctr: null, cpc: null, scoreA: null, scoreB: null, total: null, insight: null, color: null, mediaInsight: null },
                ],
            },
        };
        
        // [MODIFY] (í•­ëª© 2, 3) 5ë‹¨ê³„: "ìƒ˜í”Œ ë³´ê¸°"ìš© Mock Data (9ì¢…ìœ¼ë¡œ ì „ë©´ ê°œí¸)
        const testProjectMockData = [
            // [MODIFY] 5ë‹¨ê³„: ì†Œì¬ëª…ì—ì„œ (Perf-Top) ë“± ì œê±° (ìš”ì²­ 3)
            // [MODIFY] 5ë‹¨ê³„: Top 3, Mid 3, Low 3 ë° 4ê°œ ë¶„ë©´ ë°°í¬ (ìš”ì²­ 1, 4)
            
            // --- Top 3 (STAR) ---
            // 1. Perf-Top (Star, ROAS 5ì )
            { media: 'êµ¬ê¸€', placement: 'GDN', creativeName: 'ì†Œì¬ A', cost: 20000000, imp: 1500000, click: 30000, targetCpm: 15000, targetCpc: 800, targetCtr: 0.015, conv: 1500, targetCvr: 0.04, targetCpa: 15000, revenue: 140000000 },
            // 2. DA-Top (Star)
            { media: 'ë„¤ì´ë²„', placement: 'ìŠ¤í˜ì…œDA', creativeName: 'ì†Œì¬ B', cost: 10000000, imp: 5000000, click: 20000, targetCpm: 2100, targetCpc: 700, targetCtr: 0.003, conv: null, targetCvr: null, targetCpa: null, revenue: null },
            // 3. Perf-Top (Star, B/Cì ìˆ˜ Mid) -> í”¼ë“œë°±: "íƒ€ì‚¬ ëŒ€ë¹„ ê°•ì  ê°•ì¡°" (Mid)
            { media: 'ì¹´ì¹´ì˜¤', placement: 'ë¹„ì¦ˆë³´ë“œ', creativeName: 'ì†Œì¬ C', cost: 5000000, imp: 1000000, click: 5000, targetCpm: 6000, targetCpc: 1200, targetCtr: 0.004, conv: 200, targetCvr: 0.03, targetCpa: 30000, revenue: 22000000 },
            
            // --- Mid 3 (High Potential & Niche) ---
            // 4. DA-Mid (High Potential) -> í”¼ë“œë°±: "íƒ€ê²ŸíŒ… í™•ì¥+ì˜ˆì‚° ì¦ëŒ€"
            { media: 'ë„¤ì´ë²„', placement: 'íƒ€ì„ë³´ë“œ', creativeName: 'ì†Œì¬ D', cost: 8000000, imp: 4000000, click: 16000, targetCpm: 3000, targetCpc: 600, targetCtr: 0.003, conv: null, targetCvr: null, targetCpa: null, revenue: null },
            // 5. Perf-Mid (High Potential) -> í”¼ë“œë°±: "íƒ€ì‚¬ ëŒ€ë¹„ ê°•ì  ê°•ì¡° / ì•¡ì…˜ í—ˆë“¤ ì ê²€"
            { media: 'ìœ íŠœë¸Œ', placement: 'ë²”í¼', creativeName: 'ì†Œì¬ E', cost: 6000000, imp: 10000000, click: 4000, targetCpm: 800, targetCpc: 1500, targetCtr: 0.003, conv: 100, targetCvr: 0.03, targetCpa: 70000, revenue: 15000000 },
            // 6. DA-Mid (Niche) -> í”¼ë“œë°±: "í›…í‚¹ì„± ì¦ëŒ€"
            { media: 'META', placement: 'PPA', creativeName: 'ì†Œì¬ F', cost: 5000000, imp: 2000000, click: 4000, targetCpm: 3000, targetCpc: 1500, targetCtr: 0.0015, conv: null, targetCvr: null, targetCpa: null, revenue: null },
            // --- Low 3 (Question Mark) ---
            // 7. DA-Low (Question Mark) -> í”¼ë“œë°±: "ì˜ˆì‚°ì´ê´€"
            { media: 'ì—ë¸Œë¦¬íƒ€ì„', placement: 'í™ˆë°°ë„ˆ', creativeName: 'ì†Œì¬ G', cost: 1000000, imp: 200000, click: 300, targetCpm: 4000, targetCpc: 3000, targetCtr: 0.002, conv: null, targetCvr: null, targetCpa: null, revenue: null },
            // 8. Perf-Low (Question Mark) -> í”¼ë“œë°±: "íŒë§¤ ìƒí’ˆ êµì²´"
            { media: 'í‹±í†¡', placement: 'ë„ë‹¬', creativeName: 'ì†Œì¬ H', cost: 2000000, imp: 1000000, click: 1000, targetCpm: 1500, targetCpc: 1500, targetCtr: 0.0015, conv: 10, targetCvr: 0.02, targetCpa: 150000, revenue: null },
            // 9. Perf-Low (Question Mark, ROAS 1ì ) -> í”¼ë“œë°±: "íŒë§¤ ìƒí’ˆ êµì²´"
            { media: 'ì˜¤í”ˆë§ˆì¼“', placement: 'ë°°ë„ˆ', creativeName: 'ì†Œì¬ I', cost: 3000000, imp: 1000000, click: 1000, targetCpm: 2500, targetCpc: 1000, targetCtr: 0.002, conv: 10, targetCvr: 0.02, targetCpa: 100000, revenue: 1000000 },
        ];
        let sortColumn = 'cost'; // [MODIFY] (í•­ëª© 2) 5ë‹¨ê³„: 'total' -> 'cost'
        let sortDirection = 'desc';
        let liveAnalysisData = null; // ë©”ì¸ í˜ì´ì§€ìš©
        let sampleAnalysisData = null; // ìƒ˜í”Œ ëª¨ë‹¬ìš©
        
        // (í•­ëª© 1, 3, 4) Validation Table Config í†µí•©
        const validationTableConfigs = {
            'MAIN': { 
                label: 'í†µí•© ìº í˜ì¸', 
                headerGroups: [
                    { name: 'ê¸°ë³¸ ì •ë³´', cols: ['media', 'placement', 'creativeName', 'cost', 'imp'] },
                    { name: 'ë…¸ì¶œ ì„±ê³¼ (CPM)', cols: ['targetCpm', 'actualCpm'] },
                    { name: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)', cols: ['click', 'targetCpc', 'actualCpc', 'targetCtr', 'actualCtr'] },
                    { name: 'ì „í™˜ ì„±ê³¼ (CPA)', cols: ['conv', 'targetCvr', 'actualCvr', 'targetCpa', 'actualCpa', 'revenue'] }, 
                ],
                cols: [
                    { name: 'ë§¤ì²´', key: 'media', type: 'text', placeholder: 'ë§¤ì²´', width: 'w-24', group: 'ê¸°ë³¸ ì •ë³´' },
                    { name: 'ìƒí’ˆ', key: 'placement', type: 'text', placeholder: 'ìƒí’ˆ', width: 'w-24', group: 'ê¸°ë³¸ ì •ë³´' },
                    { name: 'ì†Œì¬ëª…', key: 'creativeName', type: 'text', placeholder: 'ì†Œì¬ëª…', width: 'w-24', group: 'ê¸°ë³¸ ì •ë³´' },
                    { name: 'ê´‘ê³ ë¹„(ì›)', key: 'cost', type: 'number', placeholder: 'ê¸ˆì•¡', width: 'w-24', isLargeNumber: true, group: 'ê¸°ë³¸ ì •ë³´' },
                    { name: 'ë…¸ì¶œìˆ˜', key: 'imp', type: 'number', placeholder: 'íšŸìˆ˜', width: 'w-20', isLargeNumber: true, group: 'ê¸°ë³¸ ì •ë³´' }, 
                    
                    { name: 'ëª©í‘œ CPM(ì›)', key: 'targetCpm', type: 'currency', placeholder: 'ëª©í‘œCPM', width: 'w-24', isLargeNumber: true, group: 'ë…¸ì¶œ ì„±ê³¼ (CPM)' },
                    { name: 'ì„±ê³¼ CPM(ì›)', key: 'actualCpm', type: 'currency', placeholder: 'ì„±ê³¼CPM', width: 'w-24', calculated: true, group: 'ë…¸ì¶œ ì„±ê³¼ (CPM)' },
                    
                    { name: 'í´ë¦­ìˆ˜', key: 'click', type: 'number', placeholder: 'íšŸìˆ˜', width: 'w-20', isLargeNumber: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' }, 
                    { name: 'ëª©í‘œ CPC(ì›)', key: 'targetCpc', type: 'currency', placeholder: 'ëª©í‘œCPC', width: 'w-24', isLargeNumber: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    { name: 'ì„±ê³¼ CPC(ì›)', key: 'actualCpc', type: 'currency', placeholder: 'ì„±ê³¼CPC', width: 'w-24', calculated: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    { name: 'ëª©í‘œ CTR(%)', key: 'targetCtr', type: 'percent', placeholder: 'ëª©í‘œCTR', width: 'w-24', group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    { name: 'ì„±ê³¼ CTR(%)', key: 'actualCtr', type: 'percent', placeholder: 'ì„±ê³¼CTR', width: 'w-24', calculated: true, group: 'í´ë¦­ ì„±ê³¼ (CPC/CTR)' },
                    
                    { name: 'ì „í™˜ìˆ˜', key: 'conv', type: 'number', placeholder: 'íšŸìˆ˜', width: 'w-20', isLargeNumber: true, group: 'ì „í™˜ ì„±ê³¼ (CPA)' }, 
                    { name: 'ëª©í‘œ ì „í™˜ìœ¨(%)', key: 'targetCvr', type: 'percent', placeholder: 'ëª©í‘œCVR', width: 'w-24', group: 'ì „í™˜ ì„±ê³¼ (CPA)' },
                    { name: 'ì„±ê³¼ ì „í™˜ìœ¨(%)', key: 'actualCvr', type: 'percent', placeholder: 'ì„±ê³¼CVR', width: 'w-24', calculated: true, group: 'ì „í™˜ ì„±ê³¼ (CPA)' },
                    { name: 'ëª©í‘œ CPA(ì›)', key: 'targetCpa', type: 'currency', placeholder: 'ëª©í‘œCPA', width: 'w-24', isLargeNumber: true, group: 'ì „í™˜ ì„±ê³¼ (CPA)' },
                    { name: 'ì„±ê³¼ CPA(ì›)', key: 'actualCpa', type: 'currency', placeholder: 'ì„±ê³¼CPA', width: 'w-24', calculated: true, group: 'ì „í™˜ ì„±ê³¼ (CPA)' },
                    { name: 'ë§¤ì¶œì•¡(ì›)', key: 'revenue', type: 'currency', placeholder: 'ê¸ˆì•¡(ì˜µì…˜)', width: 'w-24', isLargeNumber: true, group: 'ì „í™˜ ì„±ê³¼ (CPA)' }, 
                ],
            },
        };
        
        // [FIX] (í•­ëª© 1) 5ë‹¨ê³„: ì•ˆì •í™” íŒ¨ì¹˜ (Crash on new project)
        const mapCampaignDataToValidation = (sourceData) => {
            const configCols = validationTableConfigs['MAIN'].cols; 
            
            return sourceData.map((sourceItem) => {
                const row = { id: crypto.randomUUID() };
                row.isPrefill = !!sourceItem.media; 
                
                // [FIX] 5ë‹¨ê³„: sourceItemì´ ë¹„ì–´ìˆì„ ë•Œ(ì˜ˆ: [{}])ë¥¼ ëŒ€ë¹„í•´ ë¨¼ì € nullë¡œ ì´ˆê¸°í™”
                configCols.forEach(col => {
                    row[col.key] = null;
                });
                // [FIX] 5ë‹¨ê³„: sourceItemì´ ì¡´ì¬í•  ë•Œë§Œ ê°’ì„ ë§¤í•‘
                if (sourceItem && Object.keys(sourceItem).length > 0) {
                    configCols.forEach(col => {
                         // sourceItemì— ê°’ì´ ì •ì˜ë˜ì–´ ìˆìœ¼ë©´ ê·¸ ê°’ì„ ì“°ê³ , ì•„ë‹ˆë©´ null
                        row[col.key] = sourceItem[col.key] !== undefined ? sourceItem[col.key] : null;
                    });
                    row.media = sourceItem.media || null;
                    const parts = sourceItem.creative ? String(sourceItem.creative).split('_') : [null, null];
                    row.creativeName = sourceItem.creativeName || parts[0] || null; 
                    row.placement = sourceItem.placement || parts[1] || null; 
                    
                    row.cost = sourceItem.cost || null;
                    row.imp = sourceItem.imp || null;
                    row.click = sourceItem.click || null;
                    
                    if (row.isPrefill) {
                         if (sourceItem.media === 'ë„¤ì´ë²„') {
                            row.targetCpm = sourceItem.targetCpm || 2000;
                            row.targetCpc = sourceItem.targetCpc || 740;
                            row.targetCtr = sourceItem.targetCtr || 0.0020;
                        } else if (sourceItem.media === 'ì¹´ì¹´ì˜¤') {
                            row.targetCpm = sourceItem.targetCpm || 900;
                            row.targetCpc = sourceItem.targetCpc || 400;
                            row.targetCtr = sourceItem.targetCtr || 0.0025;
                        } else if (sourceItem.media === 'êµ¬ê¸€') {
                            row.targetCpm = sourceItem.targetCpm || 5000;
                            row.targetCpc = sourceItem.targetCpc || 2000;
                            row.targetCtr = sourceItem.targetCtr || 0.0040;
                        } else {
                            row.targetCpm = sourceItem.targetCpm || null; 
                            row.targetCpc = sourceItem.targetCpc || null;
                            row.targetCtr = sourceItem.targetCtr || null;
                        }
                    } else {
                        // ìƒˆ í–‰ (ì´ë¯¸ nullë¡œ ì´ˆê¸°í™”ë¨)
                    }
                    
                    row.conv = sourceItem.conv || null;
                    row.revenue = sourceItem.revenue || null;
                    row.targetCvr = sourceItem.targetCvr || null;
                    row.targetCpa = sourceItem.targetCpa || null;
                }
                
                return row;
            });
        };
        
        let isValidationTableOpen = true; 
        
        // (í•­ëª© 1) defaultValidationData ìˆ˜ì •
        const defaultValidationData = { 
            'MAIN': mapCampaignDataToValidation(campaignData.MAIN.data), 
        };
        // [NEW] (í•­ëª© 2) validationDataëŠ” ì´ì œ storageDataì˜ í¬ì¸í„°
        let storageData = { currentProject: 'default', projects: { 'default': defaultValidationData } };
        let validationData = storageData.projects[currentProject]; // í¬ì¸í„°
        
        // --- NEW Element references ---
        const runAnalysisButton = document.getElementById('run-analysis-button');
        const analysisResults = document.getElementById('analysis-results'); 
        const validationTableContent = document.getElementById('validation-table-content');
        const toggleValidationTableButton = document.getElementById('toggle-validation-table');
        const validationTableHeader = document.getElementById('validation-table-header');
        const validationTableBody = document.getElementById('validation-table-body');
        const validationCampaignLabel = document.getElementById('validation-campaign-label');
        const addValidationRowButton = document.getElementById('add-validation-row');
        const saveDataButton = document.getElementById('save-data-button');
        const resetDataButton = document.getElementById('reset-data-button');
        
        // [NEW] (í•­ëª© 2) í”„ë¡œì íŠ¸ UI ìš”ì†Œ
        const projectSelector = document.getElementById('project-selector');
        const newProjectButton = document.getElementById('new-project-button');
        // [NEW] (í•­ëª© 10) 5ë‹¨ê³„: ì‚­ì œ ë²„íŠ¼
        const deleteProjectButton = document.getElementById('delete-project-button'); 
        // [NEW] (í•­ëª© 1) 5ë‹¨ê³„: ìƒ˜í”Œ ë²„íŠ¼
        const showSampleModalButton = document.getElementById('show-sample-modal-button');
        
        // [NEW] (í•­ëª© 1) 5ë‹¨ê³„: ìƒ˜í”Œ ëª¨ë‹¬ UI ìš”ì†Œ
        const sampleModalBackdrop = document.getElementById('sample-modal-backdrop');
        const sampleModalBody = document.getElementById('sample-modal-body');
        const sampleModalCloseButton = document.getElementById('sample-modal-close-button');
        // [NEW] (í•­ëª© 2) í”„ë¡œì íŠ¸ ëª©ë¡ UI ì—…ë°ì´íŠ¸
        function updateProjectSelector() {
            projectSelector.innerHTML = ''; // Clear options
            Object.keys(storageData.projects).forEach(projectName => {
                const option = document.createElement('option');
                option.value = projectName;
                option.textContent = projectName;
                if (projectName === currentProject) {
                    option.selected = true;
                }
                projectSelector.appendChild(option);
            });
        }
        
        // [NEW] (í•­ëª© 5) í¼í¬ë¨¼ìŠ¤ ì—´ í† ê¸€ í•¨ìˆ˜
        function togglePerfColumns() {
            isPerfInputVisible = !isPerfInputVisible;
            
            // Find all elements with .perf-col class (headers and cells)
            const perfCols = document.querySelectorAll('#validation-input-table .perf-col');
            perfCols.forEach(col => {
                col.classList.toggle('hidden', !isPerfInputVisible);
            });
            // [NEW] 5ë‹¨ê³„: PM ì¸ì‚¬ì´íŠ¸/í”¼ë“œë°± ì—´ í† ê¸€
            const pmInsightCols = document.querySelectorAll('#table-header .pm-insight-col, #table-body .pm-insight-col');
             pmInsightCols.forEach(col => {
                col.classList.toggle('hidden', !isPerfInputVisible);
            });
            // Update button text
            const perfToggleBtn = document.getElementById('toggle-perf-cols');
            if (perfToggleBtn) {
                perfToggleBtn.textContent = isPerfInputVisible ? '[-] í¼í¬ë¨¼ìŠ¤ ì„±ê³¼ ìˆ¨ê¸°ê¸°' : '[+] í¼í¬ë¨¼ìŠ¤ ì„±ê³¼ ì…ë ¥';
            }
        }
        function toggleValidationTable() {
            isValidationTableOpen = !isValidationTableOpen;
            const toggleIcon = document.getElementById('toggle-icon');
            const toggleText = document.getElementById('toggle-text');
            if (isValidationTableOpen) {
                validationTableContent.classList.remove('hidden');
                toggleText.textContent = 'ì…ë ¥ í…Œì´ë¸” ì ‘ê¸°';
                toggleIcon.classList.add('rotate-180');
            } else {
                validationTableContent.classList.add('hidden');
                toggleText.textContent = 'ì…ë ¥ í…Œì´ë¸” ì—´ê¸°';
                toggleIcon.classList.remove('rotate-180');
            }
        }
        
        
        /**
         * (í•­ëª© 3, 4, 5) Calculates actual performance metrics (CPV ì œê±°, CVR/CPA ì¶”ê°€)
         */
        function calculateValidationMetrics(row) {
            // (í•­ëª© 4) 'conv' ì¶”ê°€, (í•­ëª© 3) 'view' ì œê±°
            const { cost, imp, click, conv } = row;
            
            const safeDivide = (numerator, denominator) => {
                if (typeof numerator !== 'number' || typeof denominator !== 'number' || denominator <= 0 || isNaN(numerator) || isNaN(denominator) || numerator === null || denominator === null) {
                    return null;
                }
                return numerator / denominator;
            };
            
            // Common metrics
            row.actualCpm = safeDivide(cost, imp) !== null ? safeDivide(cost, imp) * 1000 : null;
            row.actualCpc = safeDivide(cost, click);
            row.actualCtr = safeDivide(click, imp); 
            
            // (í•­ëª© 3) CPV ë¡œì§ ì œê±°
            
            // (í•­ëª© 4) CVR, CPA ë¡œì§ ì¶”ê°€
            // CVR = Conv / Click
            row.actualCvr = safeDivide(conv, click);
            // CPA = Cost / Conversion
            row.actualCpa = safeDivide(cost, conv);
        }
        /**
         * Updates only the calculated columns in the DOM without destroying input focus.
         */
        function updateCalculatedColumnsInDOM(rowId, rowData) {
            const rowElement = document.querySelector(`#validation-table-body tr[data-row-id="${rowId}"]`);
            if (!rowElement) return;
            const config = validationTableConfigs['MAIN']; // 'MAIN'ìœ¼ë¡œ ê³ ì •
            
            config.cols.forEach((col, colIndex) => {
                if (col.calculated) {
                    const td = rowElement.children[colIndex]; 
                    if (!td) return;
                    const inputElement = td.querySelector('input');
                    if (!inputElement) return;
                    const rawValue = rowData[col.key];
                    let displayValue = '-';
                    
                    if (rawValue !== null) {
                        if (col.type === 'currency') {
                            displayValue = formatNumber(Math.round(rawValue), 'currency').replace('ì›', ''); 
                        } else if (col.type === 'percent') {
                            // (í•­ëª© 4) actualCvrë„ %ë¡œ í‘œì‹œ
                            displayValue = `${(rawValue * 100).toFixed(2)}%`; 
                        } else {
                            displayValue = rawValue.toFixed(2);
                        }
                    }
                    inputElement.value = displayValue;
                }
            });
        }
        
        function handleValidationInputChange(rowId, key, event) {
            const index = validationData['MAIN'].findIndex(r => r.id === rowId); // 'MAIN'ìœ¼ë¡œ ê³ ì •
            if (index > -1) {
                const config = validationTableConfigs['MAIN'].cols.find(c => c.key === key); // 'MAIN'ìœ¼ë¡œ ê³ ì •
                if (!config) return;
                let inputValue = event.target.value;
                let rawValueToStore = inputValue; 
                
                // --- Input Parsing and Storage ---
                if (config.isLargeNumber) {
                    const originalCursorPos = event.target.selectionStart;
                    const originalValue = event.target.value; 
                    const cleanValue = inputValue.replace(/[^\d]/g, ''); 
                    const originalValuePrefix = originalValue.substring(0, originalCursorPos);
                    const cleanPrefix = originalValuePrefix.replace(/[^\d]/g, '');
                    const formattedValue = formatNumericInput(cleanValue);
                    event.target.value = formattedValue;
                    
                    let newCursorPos = 0;
                    let digitCount = 0;
                    for (let i = 0; i < formattedValue.length; i++) {
                        if (digitCount === cleanPrefix.length) {
                            newCursorPos = i;
                            break;
                        }
                        if (/\d/.test(formattedValue[i])) {
                            digitCount++;
                        }
                        newCursorPos = i + 1;
                    }
                    setTimeout(() => event.target.setSelectionRange(newCursorPos, newCursorPos), 0);
                    rawValueToStore = cleanValue === '' ? null : parseInt(cleanValue, 10);
                } else if (config.type === 'number' || config.type === 'currency' || config.type === 'percent') {
                    const cleanValue = inputValue.replace(/[^\d.]/g, ''); 
                    rawValueToStore = cleanValue === '' || cleanValue === '.' ? null : parseFloat(cleanValue);
                    
                    // (í•­ëª© 4) targetCvr, targetCtr ë‘˜ ë‹¤ % ë³€í™˜
                    if ((key.includes('targetCtr') || key.includes('targetCvr')) && rawValueToStore !== null) {
                        rawValueToStore = rawValueToStore / 100;
                    }
                } else if (config.type === 'text') {
                    rawValueToStore = inputValue;
                }
                
                validationData['MAIN'][index][key] = rawValueToStore;
                
                // (í•­ëª© 3, 4) 'view' ì œê±°, 'conv', 'revenue', 'click' ì¶”ê°€
                const baseMetrics = ['cost', 'imp', 'click', 'conv', 'revenue'];
                
                if (baseMetrics.includes(key)) {
                    calculateValidationMetrics(validationData['MAIN'][index]); // campaignType ì œê±°
                    updateCalculatedColumnsInDOM(rowId, validationData['MAIN'][index]);
                }
            }
        }
        
        function addValidationRow() {
            const row = mapCampaignDataToValidation([{}])[0]; // campaignType ì œê±°
            validationData['MAIN'].push(row); // 'MAIN'ìœ¼ë¡œ ê³ ì •
            renderValidationTable();
        }
        function removeValidationRow(rowId) {
            validationData['MAIN'] = validationData['MAIN'].filter(r => r.id !== rowId); // 'MAIN'ìœ¼ë¡œ ê³ ì •
            if (validationData['MAIN'].length === 0) {
                 validationData['MAIN'].push(mapCampaignDataToValidation([{}])[0]); // 'MAIN'ìœ¼ë¡œ ê³ ì •
            }
            renderValidationTable();
            runAnalysis();
        }
        
        /**
         * Renders the validation input table with 2-level headers.
         */
        function renderValidationTable() {
            const config = validationTableConfigs['MAIN']; // 'MAIN'ìœ¼ë¡œ ê³ ì •
            validationCampaignLabel.textContent = config.label;
            
            validationTableHeader.innerHTML = '';
            
            // --- 1. Render Level 1 Header (Groups) ---
            const trGroup = document.createElement('tr');
            trGroup.className = 'bg-gray-200 border-b-2 border-gray-300';
            
            config.headerGroups.forEach(group => {
                const th = document.createElement('th');
                th.className = 'px-2 py-2 text-xs font-bold text-gray-700 uppercase tracking-wider sticky top-0 bg-gray-300';
                th.colSpan = group.cols.length;
                
                // [NEW] (í•­ëª© 5) 'í´ë¦­ ì„±ê³¼' í—¤ë”ì— ë²„íŠ¼ ì¶”ê°€
                if (group.name === 'í´ë¦­ ì„±ê³¼ (CPC/CTR)') {
                    th.innerHTML = `
                        <div class="flex items-center justify-center relative">
                            <span>${group.name}</span>
                            <button id="toggle-perf-cols" class="ml-2 text-xs bg-indigo-500 text-white rounded px-2 py-0.5 hover:bg-indigo-700 transition-colors">
                                ${isPerfInputVisible ? '[-] í¼í¬ë¨¼ìŠ¤ ì„±ê³¼ ìˆ¨ê¸°ê¸°' : '[+] í¼í¬ë¨¼ìŠ¤ ì„±ê³¼ ì…ë ¥'}
                            </button>
                        </div>
                    `;
                } else {
                    th.textContent = group.name;
                }
                
                // [NEW] (í•­ëª© 5) 'ì „í™˜ ì„±ê³¼' ê·¸ë£¹ì— perf-col í´ë˜ìŠ¤ ë° hidden ì ìš©
                if (group.name === 'ì „í™˜ ì„±ê³¼ (CPA)') {
                    th.classList.add('perf-col');
                    if (!isPerfInputVisible) th.classList.add('hidden');
                }
                
                trGroup.appendChild(th);
            });
            
            // [NEW] (í•­ëª© 5) ì´ë²¤íŠ¸ ìœ„ì„ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const perfToggleBtn = trGroup.querySelector('#toggle-perf-cols');
            if (perfToggleBtn) {
                perfToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent sortable header click
                    togglePerfColumns();
                });
            }
            const thDeleteTop = document.createElement('th');
            thDeleteTop.className = 'px-1 py-2 text-xs font-bold text-gray-700 sticky top-0 bg-gray-300 w-10';
            thDeleteTop.textContent = 'ì‚­ì œ';
            thDeleteTop.rowSpan = 2;
            trGroup.appendChild(thDeleteTop);
            validationTableHeader.appendChild(trGroup);
            
            // --- 2. Render Level 2 Header (Details) ---
            const trDetail = document.createElement('tr');
            trDetail.className = 'bg-gray-100 border-b border-gray-200';
            
            config.cols.forEach(col => {
                const th = document.createElement('th');
                th.className = `px-2 py-2 text-xs font-semibold text-gray-700 uppercase tracking-wider sticky top-0 border-r border-gray-200 ${col.width || 'w-24'}`;
                
                if (col.key === 'cost') {
                    th.innerHTML = `${col.name} <span class="header-subtext">(ì†Œì§„ ê¸ˆì•¡)</span>`;
                } else {
                    th.textContent = col.name;
                }
                
                // [NEW] (í•­ëª© 5) 'ì „í™˜ ì„±ê³¼' ê·¸ë£¹ì— perf-col í´ë˜ìŠ¤ ë° hidden ì ìš©
                if (col.group === 'ì „í™˜ ì„±ê³¼ (CPA)') {
                    th.classList.add('perf-col');
                    if (!isPerfInputVisible) th.classList.add('hidden');
                }
                trDetail.appendChild(th);
            });
            
            validationTableHeader.appendChild(trDetail);
            
            
            // --- 3. Render Body ---
            validationTableBody.innerHTML = '';
            validationData['MAIN'].forEach(row => { // 'MAIN'ìœ¼ë¡œ ê³ ì •
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors';
                tr.dataset.rowId = row.id; 
                
                config.cols.forEach(col => {
                    const td = document.createElement('td');
                    td.className = 'p-1 text-xs whitespace-nowrap border-r border-gray-100';
                    
                    // [NEW] (í•­ëª© 5) 'ì „í™˜ ì„±ê³¼' ê·¸ë£¹ì— perf-col í´ë˜ìŠ¤ ë° hidden ì ìš©
                    if (col.group === 'ì „í™˜ ì„±ê³¼ (CPA)') {
                        td.classList.add('perf-col');
                        if (!isPerfInputVisible) td.classList.add('hidden');
                    }
                    let rawValue = row[col.key];
                    // [FIX] (í•­ëª© 1) 5ë‹¨ê³„: ì•ˆì •í™” íŒ¨ì¹˜ (undefined ë²„ê·¸ ìˆ˜ì •)
                    let displayValue = (rawValue === null || typeof rawValue === 'undefined') ? '' : rawValue;
                    
                    const isCalculated = col.calculated;
                    if (isCalculated) {
                        // Calculated fields
                        if (rawValue !== null) {
                            if (col.type === 'currency') {
                                displayValue = formatNumber(Math.round(rawValue), 'currency').replace('ì›', '');
                            } else if (col.type === 'percent') {
                                displayValue = `${(rawValue * 100).toFixed(2)}%`; 
                            } else {
                                displayValue = rawValue.toFixed(2);
                            }
                        } else {
                            displayValue = '-';
                        }
                        
                        const inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        inputElement.readOnly = true;
                        inputElement.className = 'w-full p-1 border rounded-md text-xs bg-indigo-50 font-semibold text-indigo-700 pointer-events-none text-center'; 
                        inputElement.value = displayValue;
                        td.appendChild(inputElement);
                    } else {
                        // Regular input
                        const inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        inputElement.placeholder = col.placeholder;
                        inputElement.dataset.key = col.key; // [NEW] ì•ˆì •í™” 2: í¬ì»¤ìŠ¤ ë³µì›ì„ ìœ„í•´ key ì¶”ê°€
                        
                        let inputClasses = `w-full p-1 border rounded-md text-xs focus:ring-indigo-500 focus:border-indigo-500 ${col.type === 'number' || col.type === 'currency' || col.type === 'percent' || col.isLargeNumber ? 'text-right' : 'text-left'}`;
                        
                        if (col.isLargeNumber && typeof rawValue === 'number') {
                            displayValue = formatNumericInput(rawValue);
                        } else if (col.type === 'percent' && typeof rawValue === 'number') {
                            // (í•­ëª© 4) targetCvrë„ %ë¡œ í‘œì‹œ
                            displayValue = `${(rawValue * 100).toFixed(2).replace(/\.00$/, '')}%`;
                        } else if ((col.type === 'currency' || col.type === 'number') && typeof rawValue === 'number') {
                            displayValue = rawValue;
                        } else {
                            // displayValueëŠ” ì´ë¯¸ ìœ„ì—ì„œ undefined/nullì´ ''ë¡œ ì²˜ë¦¬ë¨
                        }
                        
                        if (isPrefillActive && row.isPrefill && (displayValue || displayValue === 0)) {
                            inputClasses += ' input-prefill';
                        }
                        inputElement.className = inputClasses;
                        inputElement.value = displayValue;
                        
                        inputElement.dataset.defaultValue = displayValue;
                        
                        // [NEW] ì•ˆì •í™” 2: 'focus' ì´ë²¤íŠ¸ ë¡œì§ ìˆ˜ì •
                        inputElement.addEventListener('focus', (e) => {
                            if (isPrefillActive) {
                                isPrefillActive = false;
                                
                                validationData['MAIN'].forEach(dataRow => { // 'MAIN'ìœ¼ë¡œ ê³ ì •
                                    // ì„±ê³¼ ì§€í‘œ ì´ˆê¸°í™”
                                    dataRow.actualCpm = null;
                                    dataRow.actualCpc = null;
                                    dataRow.actualCtr = null;
                                    dataRow.actualCvr = null; 
                                    dataRow.actualCpa = null; 
                                    
                                    if (dataRow.isPrefill) {
                                        dataRow.isPrefill = false;
                                        config.cols.forEach(c => {
                                            if (!c.calculated) {
                                                dataRow[c.key] = null; 
                                            }
                                        });
                                    }
                                });
                                
                                // [NEW] ì•ˆì •í™”: DOM ìˆ˜ë™ ì¡°ì‘ ëŒ€ì‹  í…Œì´ë¸” ì „ì²´ ì¬ë Œë”ë§
                                renderValidationTable();
                                
                                // [NEW] ì¬ë Œë”ë§ í›„, í˜„ì¬ í´ë¦­í•œ(ì´ì œëŠ” *ìƒˆ* ìš”ì†Œê°€ ëœ) ì…ë ¥ì°½ì— ë‹¤ì‹œ í¬ì»¤ìŠ¤ë¥¼ ì‹œë„í•©ë‹ˆë‹¤.
                                // ì´ ì‹œì ì— row.idì™€ col.keyëŠ” ì´ ë¦¬ìŠ¤ë„ˆì˜ í´ë¡œì €ì— ìº¡ì²˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                                const newRowElement = validationTableBody.querySelector(`tr[data-row-id="${row.id}"]`);
                                if (newRowElement) {
                                    const newInputElement = newRowElement.querySelector(`input[data-key="${col.key}"]`);
                                    if (newInputElement) {
                                        newInputElement.focus(); // ìƒˆ ìš”ì†Œì— í¬ì»¤ìŠ¤
                                        // ìƒˆ ìš”ì†Œì—ì„œ 'focus' ì´ë²¤íŠ¸ê°€ ë‹¤ì‹œ ë°œìƒí•˜ì§€ë§Œ,
                                        // isPrefillActiveê°€ falseì´ë¯€ë¡œ ì´ ë¸”ë¡ì€ ê±´ë„ˆëœë‹ˆë‹¤.
                                    }
                                }
                                
                                return; // í˜„ì¬ (ì˜¤ë˜ëœ) ìš”ì†Œì˜ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰ ì¤‘ì§€
                            }
                            
                            // isPrefillActiveê°€ falseì¼ ë•Œì˜ ì¼ë°˜ì ì¸ ë™ì‘
                            e.target.classList.remove('input-prefill');
                        });
                        
                        inputElement.addEventListener('blur', (e) => {
                            handleValidationInputChange(row.id, col.key, e);
                            
                            const index = validationData['MAIN'].findIndex(r => r.id === row.id); // 'MAIN'
                            if (index === -1) return;
                            const rawValue = validationData['MAIN'][index][col.key]; // 'MAIN'
                            
                            // (í•­ëª© 4) targetCvrë„ % ì²˜ë¦¬
                            if (col.type === 'percent' && typeof rawValue === 'number' && !e.target.value.includes('%')) {
                                e.target.value = `${(rawValue * 100).toFixed(2).replace(/\.00$/, '')}%`;
                            }
                        });
                        
                        inputElement.addEventListener('input', (e) => {
                            e.target.classList.remove('input-prefill');
                            handleValidationInputChange(row.id, col.key, e);
                        });
                        
                        td.appendChild(inputElement);
                    }
                    tr.appendChild(td);
                });
                
                // Action column
                const actionTd = document.createElement('td');
                actionTd.className = 'p-1 text-center';
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'X';
                deleteButton.className = 'text-red-500 hover:text-red-700 font-bold text-sm transition-colors p-1';
                deleteButton.addEventListener('click', () => removeValidationRow(row.id));
                actionTd.appendChild(deleteButton);
                tr.appendChild(actionTd);
                validationTableBody.appendChild(tr);
            });
        }
        // --- END Validation Table Logic ---
        
        // --- Scoring Functions (DA) ---
        
        const getScoreCpm = (actualCpm, targetCpm) => {
            if (actualCpm === null || targetCpm === null || targetCpm <= 0) return 1;
            const ratio = actualCpm / targetCpm;
            if (ratio < 0.8) return 5;
            if (ratio < 1.0) return 4;
            if (ratio < 1.3) return 3;
            if (ratio < 1.6) return 2;
            return 1;
        };
        const getScoreCtr = (actualCtr, targetCtr) => {
            if (actualCtr === null || targetCtr === null || targetCtr <= 0) return 1;
            const ratio = actualCtr / targetCtr;
            if (ratio > 1.3) return 5;  // 130% ì´ˆê³¼
            if (ratio > 1.1) return 4;  // 110% ì´ˆê³¼
            if (ratio > 1.0) return 3;  // 100% ì´ˆê³¼
            if (ratio > 0.5) return 2;  // 50% ì´ˆê³¼
            return 1; // 50% ì´í•˜
        };
        const getScoreCpc = (actualCpc, targetCpc) => {
            if (actualCpc === null || targetCpc === null || targetCpc <= 0) return 1;
            const ratio = actualCpc / targetCpc;
            if (ratio < 0.85) return 5;  // 85% ë¯¸ë§Œ
            if (ratio < 0.95) return 4;  // 95% ë¯¸ë§Œ
            if (ratio < 1.04) return 3;  // 104% ë¯¸ë§Œ
            if (ratio < 1.4) return 2;  // 140% ë¯¸ë§Œ
            return 1; // 140% ì´ìƒ
        };
        
        // --- Insight Functions (DA) ---
        const getDaInsight = (scoreA, scoreB) => {
            if (scoreA === null || scoreB === null) return { grade: "ë°ì´í„° ë¶€ì¡±", text: "DA ì„±ê³¼(A/B) ë¶„ì„ì„ ìœ„í•œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤." };
            if (scoreA >= 4 && scoreB >= 4) return { grade: "Top ì†Œì¬", text: "ë…¸ì¶œì´ ë§¤ìš° ì›í™œí•˜ê³ , ì†Œì¬ ê´€ì‹¬ë„ë„ ë§¤ìš° ë†’ì•„ íƒ€ê²ŸíŒ…ê³¼ ë©”ì‹œì§€ íš¨ê³¼ì ì¸ ì†Œì¬" };
            if (scoreA >= 4 && scoreB >= 3) return { grade: "Top ì†Œì¬", text: "ë…¸ì¶œì´ ë§¤ìš° ì›í™œí•˜ê³ , ì†Œì¬ ê´€ì‹¬ì€ ìš°ìˆ˜í•œ í¸ì´ë¯€ë¡œ ì¢€ ë” ë²”ìš©ì ì¸ ì†Œì¬ë¡œ ê°œì„  í•„ìš”" };
            if (scoreA >= 4 && scoreB >= 1.5) return { grade: "Mid ì†Œì¬", text: "ë…¸ì¶œì€ ë§¤ìš° ì›í• í•˜ì§€ë§Œ, ì†Œì¬ ê´€ì‹¬ì´ ë‚®ì€ í¸ìœ¼ë¡œ í›…í‚¹ì„±ì„ ë†’ì¸ ì†Œì¬ë¡œ ìˆ˜ì • í•„ìš”" };
            if (scoreA >= 4 && scoreB >= 0) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œì€ ë§¤ìš° ì›í™œí•˜ì§€ë§Œ ê·¹ì†Œìˆ˜ì˜ ì§‘ë‹¨ì—ì„œ ë°˜ì‘ì´ ë°œìƒí•¨ìœ¼ë¡œ ì†Œì¬ í›…í‚¹ì„± ì¦ëŒ€ í•„ìš”" };
            if (scoreA >= 3 && scoreB >= 4) return { grade: "Top ì†Œì¬", text: "ë…¸ì¶œì´ ì ì ˆí•˜ë©°, ì†Œì¬ ê´€ì‹¬ì´ ë§¤ìš° ë†’ì•„ ë©”ì‹œì§€ íš¨ê³¼ì„±ì´ ë†’ì€ ì†Œì¬" };
            if (scoreA >= 3 && scoreB >= 3) return { grade: "Topì†Œì¬", text: "ë…¸ì¶œì´ ì ì ˆí•˜ê³ , ì†Œì¬ ê´€ì‹¬ë„ ë™ë°˜ë˜ì–´ ìš°ìˆ˜í•œ ì†Œì¬" };
            if (scoreA >= 3 && scoreB >= 1.5) return { grade: "Mid ì†Œì¬", text: "ë…¸ì¶œì€ ì ì ˆí•˜ì§€ë§Œ ì†Œì¬ ê´€ì‹¬ì´ ë‚®ì€ í¸ìœ¼ë¡œ íƒ€ê²ŸíŒ… í™•ì¥ ë° ë²”ìš©ì ì¸ ì†Œì¬ë¡œ ê°œì„  í•„ìš”" };
            if (scoreA >= 3 && scoreB >= 0) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œì€ ì ì ˆí•˜ì§€ë§Œ ê´€ì‹¬ì´ ì €ì¡°í•˜ì—¬ ì†Œì¬ OFF ë° ì˜ˆì‚° ì´ê´€ ê³ ë ¤" };
            if (scoreA >= 1.5 && scoreB >= 4) return { grade: "Midì†Œì¬", text: "ì†Œì¬ ê´€ì‹¬ì´ ë§¤ìš° ë†’ì§€ë§Œ ë…¸ì¶œì´ ì›í™œí•˜ì§€ ì•ŠëŠ” ì†Œì¬ë¡œ íƒ€ê²ŸíŒ… ì¡°ì • ë° ì˜ˆì‚° ì¦ì•¡ìœ¼ë¡œ ë…¸ì¶œ ì¦ëŒ€ë°©ì•ˆ ê³ ë ¤" };
            if (scoreA >= 1.5 && scoreB >= 3) return { grade: "Lowì†Œì¬", text: "ì†Œì¬ í›…í‚¹ì„±ì€ ìˆì§€ë§Œ ë…¸ì¶œì´ ì›í™œí•˜ì§€ ì•ŠëŠ” ì†Œì¬ë¡œ íƒ€ê²ŸíŒ… í™•ì¥ í•„ìš”" };
            if (scoreA >= 1.5 && scoreB >= 1.5) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œê³¼ ì†Œì¬ ê´€ì‹¬ì´ ë‚®ì€ í¸ìœ¼ë¡œ ì†Œì¬ OFF ë° ì˜ˆì‚° ì´ê´€ ê³ ë ¤" };
            if (scoreA >= 1.5 && scoreB >= 0) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œê³¼ ì†Œì¬ ê´€ì‹¬ì´ ì €ì¡°í•˜ì—¬ ì†Œì¬ OFF ë° ì˜ˆì‚° ì´ê´€ ê³ ë ¤" };
            if (scoreA >= 0 && scoreB >= 4) return { grade: "Lowì†Œì¬", text: "ì†Œì¬ ê´€ì‹¬ì€ ë§¤ìš° ë†’ì§€ë§Œ ê·¹ì†Œìˆ˜ì˜ ì§‘ë‹¨ì—ë§Œ ë…¸ì¶œë˜ì–´ íƒ€ê²ŸíŒ… í™•ì¥ ë° ì˜ˆì‚° ì¦ì•¡ìœ¼ë¡œ ë…¸ì¶œ ì¦ëŒ€ë°©ì•ˆ ê³ ë ¤" };
            if (scoreA >= 0 && scoreB >= 3) return { grade: "Lowì†Œì¬", text: "ì†Œì¬ í›…í‚¹ì„±ì€ ìˆì§€ë§Œ ê·¹ì†Œìˆ˜ì˜ ì§‘ë‹¨ì—ë§Œ ë…¸ì¶œë˜ì–´ íƒ€ê²ŸíŒ… ì¡°ì • í•„ìš”" };
            if (scoreA >= 0 && scoreB >= 1.5) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œì´ ì €ì¡°í•˜ê³  ì†Œì¬ ê´€ì‹¬ì´ ë‚®ì€ í¸ìœ¼ë¡œ ì†Œì¬ OFF ë° ì˜ˆì‚° ì´ê´€ ê³ ë ¤" };
            if (scoreA >= 0 && scoreB >= 0) return { grade: "Lowì†Œì¬", text: "ë…¸ì¶œê³¼ ì†Œì¬ ê´€ì‹¬ì´ ì €ì¡°í•˜ì—¬ ì†Œì¬ OFF ë° ì˜ˆì‚° ì´ê´€ ê³ ë ¤" };
            return { grade: "ì˜¤ë¥˜", text: "ì ìˆ˜ ê³„ì‚° ì˜¤ë¥˜" };
        };
        
        const getDaFeedback = (scoreA, scoreB) => {
            if (scoreA === null || scoreB === null) return '';
            if (scoreA >= 4 && scoreB >= 4) return "ìœ ì§€/ê°•í™”";
            if (scoreA >= 4 && scoreB >= 3) return "ë²”ìš©ì  ë©”ì‹œì§€ ê°•í™”";
            if (scoreA >= 4 && scoreB >= 1.5) return "í›…í‚¹ì„± ì¦ëŒ€";
            if (scoreA >= 4 && scoreB >= 0) return "í›…í‚¹ì„± ì¦ëŒ€";
            if (scoreA >= 3 && scoreB >= 4) return "ìœ ì§€/ê°•í™”";
            if (scoreA >= 3 && scoreB >= 3) return "ìœ ì§€/ê°•í™”";
            if (scoreA >= 3 && scoreB >= 1.5) return "íƒ€ê²ŸíŒ… í™•ì¥/ë²”ìš©ì  ë©”ì‹œì§€";
            if (scoreA >= 3 && scoreB >= 0) return "íƒ€ê²ŸíŒ… í™•ì¥+í›…í‚¹ì„± ì¦ëŒ€";
            if (scoreA >= 1.5 && scoreB >= 4) return "íƒ€ê²ŸíŒ… í™•ì¥+ì˜ˆì‚° ì¦ëŒ€";
            if (scoreA >= 1.5 && scoreB >= 3) return "íƒ€ê²ŸíŒ… ì¡°ì •";
            if (scoreA >= 1.5 && scoreB >= 1.5) return "ì˜ˆì‚°ì´ê´€";
            if (scoreA >= 1.5 && scoreB >= 0) return "ì˜ˆì‚°ì´ê´€";
            if (scoreA >= 0 && scoreB >= 4) return "íƒ€ê²ŸíŒ… í™•ì¥+ì˜ˆì‚° ì¦ëŒ€";
            if (scoreA >= 0 && scoreB >= 3) return "íƒ€ê²ŸíŒ… ì¡°ì •+í›…í‚¹ì„± ì¦ëŒ€";
            if (scoreA >= 0 && scoreB >= 1.5) return "ì˜ˆì‚°ì´ê´€";
            if (scoreA >= 0 && scoreB >= 0) return "ì˜ˆì‚°ì´ê´€";
            return "";
        };
        // --- [NEW] (í•­ëª© 1) 5ë‹¨ê³„: Scoring Functions (Perf) ---
        /**
         * CVR ì ìˆ˜: ëª©í‘œ CVR ê¸°ì¤€ 5ì  ì²™ë„í™” (Higher is Better)
         * CSV ê¸°ì¤€: 5ì (150% ì´ˆê³¼), 4ì (115%~149%), 3ì (95%~114%), 2ì (75%~94%), 1ì (75% ë¯¸ë§Œ)
         */
        const getScoreCvr = (actualCvr, targetCvr) => {
            if (actualCvr === null || targetCvr === null || targetCvr <= 0) return null;
            const ratio = actualCvr / targetCvr;
            
            if (ratio > 1.50) return 5;  // 150% ì´ˆê³¼
            if (ratio >= 1.15) return 4; // 115% ~ 149%
            if (ratio >= 0.95) return 3; // 95% ~ 114%
            if (ratio >= 0.75) return 2; // 75% ~ 94%
            return 1; // 75% ë¯¸ë§Œ
        };
        
        /**
         * CPA ì ìˆ˜: ëª©í‘œ CPA ê¸°ì¤€ 5ì  ì²™ë„í™” (Lower is Better)
         * CSV ê¸°ì¤€: 5ì (70% ë¯¸ë§Œ), 4ì (71%~90%), 3ì (91%~105%), 2ì (106%~125%), 1ì (125% ì´ˆê³¼)
         */
        const getScoreCpa = (actualCpa, targetCpa) => {
            if (actualCpa === null || targetCpa === null || targetCpa <= 0) return null;
            const ratio = actualCpa / targetCpa;
            
            if (ratio < 0.70) return 5;  // 70% ë¯¸ë§Œ
            if (ratio <= 0.90) return 4; // 71% ~ 90%
            if (ratio <= 1.05) return 3; // 91% ~ 105%
            if (ratio <= 1.25) return 2; // 106% ~ 125%
            return 1; // 125% ì´ˆê³¼
        };
        // --- [NEW] (í•­ëª© 3) 5ë‹¨ê³„: Insight Functions (Perf) ---
        /**
         * í¼í¬ë¨¼ìŠ¤ ì¸ì‚¬ì´íŠ¸ (B/C ì ìˆ˜ ê¸°ì¤€)
         * CSV íŒŒì¼ ê¸°ì¤€ (ì›Œë”© ìˆ˜ì •ë¨)
         */
        const getPerfInsight = (scoreB, scoreC) => {
            if (scoreB === null || scoreC === null) return { grade: "ë°ì´í„° ë¶€ì¡±", text: "í¼í¬ë¨¼ìŠ¤ ì„±ê³¼(C) ë¶„ì„ì„ ìœ„í•œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤." };
            
            if (scoreB >= 4 && scoreC >= 4) return { grade: "Top ì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ê³¼ ì „í™˜ íš¨ìœ¨ì´ ë§¤ìš° ë†’ì•„ ë©”ì‹œì§€ì™€ íŒë§¤ ìƒí’ˆì´ ì›Œí‚¹í•˜ëŠ” ì†Œì¬" };
            if (scoreB >= 4 && scoreC >= 3) return { grade: "Top ì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ì€ ë§¤ìš° ë†’ì§€ë§Œ ì „í™˜ íš¨ìœ¨ì€ ìš°ìˆ˜í•œ í¸ìœ¼ë¡œ ì•¡ì…˜ì— ë‹¤ì†Œ ì‹ ì¤‘í•œ íƒœë„ë¥¼ ë³´ì´ëŠ” ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            if (scoreB >= 4 && scoreC >= 1.5) return { grade: "Mid ì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ì€ ë§¤ìš° ë†’ì§€ë§Œ ì „í™˜ íš¨ìœ¨ì´ ë‚®ì€ í¸ìœ¼ë¡œ íƒ€ ìƒí’ˆê³¼ ë¹„êµ ì¤‘ì´ê±°ë‚˜ ì „í™˜ í”„ë¡œì„¸ìŠ¤ì— í—ˆë“¤ì´ ìˆì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            if (scoreB >= 4 && scoreC >= 0) return { grade: "Lowì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ì€ ë§¤ìš° ë†’ì§€ë§Œ ì „í™˜ íš¨ìœ¨ì´ ì €ì¡°í•˜ì—¬ ì†Œì¬ì— í˜¸ê¸°ì‹¬ì€ ìˆì§€ë§Œ ìƒí’ˆ ìì²´ì— ê´€ì‹¬ì´ ì—†ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            
            if (scoreB >= 3 && scoreC >= 4) return { grade: "Top ì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ì€ ì ì ˆí•œ ë°˜ë©´ ì „í™˜ íš¨ìœ¨ì€ ë§¤ìš° ë†’ì€ í¸ìœ¼ë¡œ í•œ ë²ˆì— ë‹¤ìˆ˜ ì•¡ì…˜ì´ ë°œìƒí•˜ê±°ë‚˜ ë°”ì´ëŸ´ ëœ ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            if (scoreB >= 3 && scoreC >= 3) return { grade: "Topì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ê³¼ ì „í™˜ íš¨ìœ¨ì´ ìš°ìˆ˜í•œ í¸ì´ì§€ë§Œ ì•¡ì…˜ì— ë‹¤ì†Œ ì‹ ì¤‘í•œ íƒœë„ë¥¼ ë³´ì´ê³  ìˆì–´ì„œ ë² ë„¤í• ê°•ì¡° ì‹œ ê°œì„  ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒ" }; 
            if (scoreB >= 3 && scoreC >= 1.5) return { grade: "Mid ì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ì€ ì ì ˆí•˜ì§€ë§Œ ì „í™˜ íš¨ìœ¨ì´ ë‚®ì€ í¸ìœ¼ë¡œ íƒ€ ìƒí’ˆê³¼ ë¹„êµ ì¤‘ì´ê±°ë‚˜ ì „í™˜ í”„ë¡œì„¸ìŠ¤ì— í—ˆë“¤ì´ ìˆì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            if (scoreB >= 3 && scoreC >= 0) return { grade: "Lowì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ì€ ì ì ˆí•˜ì§€ë§Œ ì „í™˜ íš¨ìœ¨ì´ ì €ì¡°í•˜ì—¬ ì†Œì¬ì— í˜¸ê¸°ì‹¬ì€ ìˆì§€ë§Œ ìƒí’ˆ ìì²´ì— ê´€ì‹¬ì´ ì—†ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            if (scoreB >= 1.5 && scoreC >= 4) return { grade: "Midì†Œì¬", text: "ì „í™˜ íš¨ìœ¨ì€ ë§¤ìš° ë†’ì§€ë§Œ ê´‘ê³  ë°˜ì‘ì´ ë‚®ì€ í¸ìœ¼ë¡œ ë²”ìš©ì ì¸ ë² ë„¤í•ì„ ê°•ì¡°í•œ ì†Œì¬ë¡œ ìˆ˜ì • ì‹œ ê°œì„  ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            if (scoreB >= 1.5 && scoreC >= 3) return { grade: "Midì†Œì¬", text: "ì „í™˜ íš¨ìœ¨ì€ ìš°ìˆ˜í•œ í¸ì´ì§€ë§Œ ê´‘ê³  ë°˜ì‘ì´ ë‚®ì€ í¸ìœ¼ë¡œ ë²”ìš©ì ì¸ ë² ë„¤í•ì„ ê°•ì¡°í•œ ì†Œì¬ë¡œ ìˆ˜ì • ì‹œ ê°œì„  ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            if (scoreB >= 1.5 && scoreC >= 1.5) return { grade: "Lowì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ê³¼ ì „í™˜ íš¨ìœ¨ì´ ëª¨ë‘ ë‚®ì€ í¸ìœ¼ë¡œ ìƒí’ˆ ìì²´ì— ê´€ì‹¬ì´ ì—†ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            if (scoreB >= 1.5 && scoreC >= 0) return { grade: "Lowì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ê³¼ ì „í™˜ íš¨ìœ¨ì´ ëª¨ë‘ ì €ì¡°í•˜ì—¬ ìƒí’ˆ ìì²´ì— ê´€ì‹¬ì´ ì—†ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            
            if (scoreB >= 0 && scoreC >= 4) return { grade: "Midì†Œì¬", text: "ì „í™˜ íš¨ìœ¨ì€ ë§¤ìš° ë†’ì§€ë§Œ ê´‘ê³  ê´€ì‹¬ì´ ë§¤ìš° ì €ì¡°í•˜ì—¬ ë² ë„¤í•ì„ ê°•ì¡°í•œ ì†Œì¬ë¡œ ìˆ˜ì • ì‹œ ê°œì„  ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            if (scoreB >= 0 && scoreC >= 3) return { grade: "Lowì†Œì¬", text: "ì „í™˜ íš¨ìœ¨ì€ ìš°ìˆ˜í•œ í¸ì´ì§€ë§Œ ê´‘ê³  ë°˜ì‘ì´ ë§¤ìš° ì €ì¡°í•˜ì—¬ ë² ë„¤í•ì„ ê°•ì¡°í•œ ì†Œì¬ë¡œ ìˆ˜ì • ì‹œ ê°œì„  ë  ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            if (scoreB >= 0 && scoreC >= 1.5) return { grade: "Lowì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ì´ ì €ì¡°í•˜ê³  ì „í™˜ íš¨ìœ¨ì´ ë‚®ì€ í¸ìœ¼ë¡œ ìƒí’ˆ ìì²´ì— ê´€ì‹¬ì´ ì—†ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            if (scoreB >= 0 && scoreC >= 0) return { grade: "Lowì†Œì¬", text: "ê´‘ê³  ë°˜ì‘ê³¼ ì „í™˜ íš¨ìœ¨ì´ ëª¨ë‘ ì €ì¡°í•˜ì—¬ ìƒí’ˆ ìì²´ì— ê´€ì‹¬ì´ ì—†ì„ ê²ƒìœ¼ë¡œ ì˜ˆìƒ" };
            return { grade: "ì˜¤ë¥˜", text: "í¼í¬ë¨¼ìŠ¤ ì ìˆ˜ ê³„ì‚° ì˜¤ë¥˜" };
        };
        /**
         * í¼í¬ë¨¼ìŠ¤ í”¼ë“œë°± (B/C ì ìˆ˜ ê¸°ì¤€)
         * CSV íŒŒì¼ ê¸°ì¤€ (ì›Œë”© ìˆ˜ì •ë¨)
         */
        const getPerfFeedback = (scoreB, scoreC) => {
            if (scoreB === null || scoreC === null) return '';
            
            if (scoreB >= 4 && scoreC >= 4) return "ìœ ì§€/ê°•í™”";
            if (scoreB >= 4 && scoreC >= 3) return "ê²°ì •ì ì¸ ë² ë„¤í• ê°•ì¡°";
            if (scoreB >= 4 && scoreC >= 1.5) return "íƒ€ì‚¬ ëŒ€ë¹„ ê°•ì  ê°•ì¡° / ì•¡ì…˜ í—ˆë“¤ ì ê²€";
            if (scoreB >= 4 && scoreC >= 0) return "íŒë§¤ ìƒí’ˆ êµì²´";
            
            if (scoreB >= 3 && scoreC >= 4) return "ìœ ì§€/ê°•í™”";
            if (scoreB >= 3 && scoreC >= 3) return "íƒ€ì‚¬ ëŒ€ë¹„ ê°•ì  ê°•ì¡°";
            if (scoreB >= 3 && scoreC >= 1.5) return "íƒ€ì‚¬ ëŒ€ë¹„ ê°•ì  ê°•ì¡° / ì•¡ì…˜ í—ˆë“¤ ì ê²€";
            if (scoreB >= 3 && scoreC >= 0) return "íŒë§¤ ìƒí’ˆ êµì²´";
            if (scoreB >= 1.5 && scoreC >= 4) return "ë²”ìš©ì ì¸ ë² ë„¤í• ê°•ì¡°";
            if (scoreB >= 1.5 && scoreC >= 3) return "ë²”ìš©ì ì¸ ë² ë„¤í• / ì•¡ì…˜ í—ˆë“¤ ì ê²€";
            if (scoreB >= 1.5 && scoreC >= 1.5) return "íŒë§¤ ìƒí’ˆ êµì²´";
            if (scoreB >= 1.5 && scoreC >= 0) return "íŒë§¤ ìƒí’ˆ êµì²´";
            
            if (scoreB >= 0 && scoreC >= 4) return "í›…í‚¹ì„± ìˆëŠ” ë² ë„¤í• ê°•ì¡°";
            if (scoreB >= 0 && scoreC >= 3) return "í›…í‚¹ì„± ìˆëŠ” ë² ë„¤í• / ì•¡ì…˜ í—ˆë“¤ ì ê²€";
            if (scoreB >= 0 && scoreC >= 1.5) return "íŒë§¤ ìƒí’ˆ êµì²´";
            if (scoreB >= 0 && scoreC >= 0) return "íŒë§¤ ìƒí’ˆ êµì²´";
            return "";
        };
        // --- [NEW] (í•­ëª© 4) 5ë‹¨ê³„: Insight Functions (ROAS) ---
        /**
         * ROAS ì˜µì…”ë„ ì¸ì‚¬ì´íŠ¸ (ì ˆëŒ€ ìˆ˜ì¹˜ ê¸°ì¤€)
         * CSV íŒŒì¼ ê¸°ì¤€
         */
        const getRoasInsight = (actualRoas, mediaPrefix) => {
            if (actualRoas === null || isNaN(actualRoas) || actualRoas <= 0) return null;
            
            const roasPercent = actualRoas; // roasëŠ” ì´ë¯¸ % (ì˜ˆ: 550)
            let grade = "1ì ";
            // [FIX] (í•­ëª© 8c) 5ë‹¨ê³„: ë¬¸ì¥ ì™„ì„±
            let text = "ê´‘ê³ ë¹„ ì†Œì§„ ëŒ€ë¹„ ì†ìµë¶„ê¸° ë¯¸ë‹¬ì´ê±°ë‚˜ ë‹¨ìˆœ ë³¸ì „ì„ ë‹¬ì„±í•œ ê²ƒìœ¼ë¡œ íŒë‹¨ ë¨";
            let roasDisplay = roasPercent.toFixed(0);
            if (roasPercent > 600) { // 600% ì´ˆê³¼
                grade = "5ì ";
                text = "ì••ë„ì ì¸ ìˆ˜ìµì´ ë°œìƒë˜ëŠ” ì†Œì¬ë¡œ ì¦‰ê°ì ì¸ ì˜ˆì‚° ì¦ì•¡ì„ í†µí•œ ìœ ì§€ê°•í™” í•„ìš”";
            } else if (roasPercent >= 400) { // 400% ~ 599%
                grade = "4ì ";
                text = "ë†’ì€ ìˆœì´ìµì„ ê¸°ë¡í•˜ëŠ” ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ë©° ì˜ˆì‚° ì¦ì•¡ì„ í†µí•œ ìœ ì§€ê°•í™” ê¶Œì¥";
            } else if (roasPercent >= 250) { // 250% ~ 399%
                grade = "3ì ";
                text = "ìˆœì´ìµì´ ë°œìƒë˜ëŠ” êµ¬ê°„ì— ì§„ì…í•œ ê²ƒìœ¼ë¡œ ì˜ˆìƒë˜ë©° ì¶”ì´ë¥¼ ì§€ì¼œë³¸ í›„ ì˜ˆìƒ ì¦ì•¡ ì—¬ë¶€ íŒë‹¨ì„ ê¶Œì¥";
            } else if (roasPercent >= 150) { // 150% ~ 249%
                grade = "2ì ";
                text = "ì†ìµë¶„ê¸°ì— ê·¼ì ‘í•˜ê±°ë‚˜ ìˆœì´ìµì„ ì†Œí­ ê¸°ë¡í•˜ëŠ” ì¤‘ìœ¼ë¡œ ì˜ˆìƒ ë¨";
            }
            
            return {
                // [MODIFY] (í•­ëª© 8b) 5ë‹¨ê³„: % ìˆ˜ì¹˜ í¬í•¨, ìˆœì„œ ë³€ê²½
                text: `${mediaPrefix}: [ROAS ${roasDisplay}% (${grade})] ${text}`
            };
        };
        
        /**
         * [MODIFY] 5ë‹¨ê³„: Data Aggregation and Scoring Logic
         */
        function calculateScoresAndInsight(row) {
            let scoreA = null;
            let scoreB = null;
            let scoreC = null;
            let totalDaScore = null;  // [NEW] (í•­ëª© 6) 5ë‹¨ê³„
            let totalPmScore = null;  // [NEW] (í•­ëª© 6) 5ë‹¨ê³„
            
            // [NEW] (í•­ëª© 7) 5ë‹¨ê³„: ë¶„ë¦¬ëœ ì¸ì‚¬ì´íŠ¸/í”¼ë“œë°±
            let daInsightGrade = "ë°ì´í„° ë¶€ì¡±";
            let daInsightText = "ë¯¸ë””ì–´ ì„±ê³¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.";
            let daFeedback = "";
            let pmInsightGrade = "ë°ì´í„° ë¶€ì¡±";
            let pmInsightText = "í¼í¬ë¨¼ìŠ¤ ì„±ê³¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.";
            let pmFeedback = "";
            
            let finalInsightGrade = "ë°ì´í„° ë¶€ì¡±";
            let finalInsightColor = "#94a3b8";
            const mediaPrefix = (row.media || row.placement || row.creativeName) 
                ? `${row.media || 'N/A'}/${row.placement || 'N/A'}/${row.creativeName || 'N/A'}` 
                : 'ë§¤ì²´ ìƒí’ˆê³¼ ì†Œì¬ëª… ì—†ìŒ';
            
            // --- A/B Score (DA) Calculation ---
            const daCriticalMissing = row.cost === null || row.cost === 0 || 
                                      row.imp === null || row.imp === 0 || 
                                      row.click === null ||
                                      row.targetCpm === null ||
                                      row.targetCpc === null ||
                                      row.targetCtr === null;
            
            if (!daCriticalMissing) {
                scoreA = getScoreCpm(row.actualCpm, row.targetCpm);
                const bScoreCtr = getScoreCtr(row.actualCtr, row.targetCtr);
                const bScoreCpc = getScoreCpc(row.actualCpc, row.targetCpc);
                scoreB = (bScoreCtr + bScoreCpc) / 2;
                
                // [NEW] (í•­ëª© 7) 5ë‹¨ê³„: DA ì¸ì‚¬ì´íŠ¸/í”¼ë“œë°± ê³„ì‚°
                const daInsight = getDaInsight(scoreA, scoreB);
                daInsightGrade = daInsight.grade;
                daInsightText = daInsight.text;
                daFeedback = getDaFeedback(scoreA, scoreB);
                totalDaScore = (scoreA + scoreB) / 2;
            }
            // --- [NEW] (í•­ëª© 1) 5ë‹¨ê³„: C Score (Perf) Calculation ---
            const perfCriticalMissing = row.conv === null || 
                                        row.targetCvr === null || 
                                        row.targetCpa === null ||
                                        row.click === null || row.click === 0; // CVR (conv/click) ë¶„ëª¨
            
            if (!perfCriticalMissing && row.actualCvr !== null && row.actualCpa !== null) {
                const cvrScore = getScoreCvr(row.actualCvr, row.targetCvr);
                const cpaScore = getScoreCpa(row.actualCpa, row.targetCpa);
                
                if (cvrScore !== null && cpaScore !== null) {
                    scoreC = (cvrScore + cpaScore) / 2;
                }
            }
            
            // [NEW] (í•­ëª© 7) 5ë‹¨ê³„: PM ì¸ì‚¬ì´íŠ¸/í”¼ë“œë°± ê³„ì‚°
            if (scoreC !== null && scoreB !== null) {
                 const pmInsight = getPerfInsight(scoreB, scoreC);
                 pmInsightGrade = pmInsight.grade;
                 pmInsightText = pmInsight.text;
                 pmFeedback = getPerfFeedback(scoreB, scoreC);
                 totalPmScore = (scoreB + scoreC) / 2; // B/C ì´ì 
            }
            // --- ìµœì¢… ì¸ì‚¬ì´íŠ¸/ì»¬ëŸ¬ ê²°ì • (PM ìš°ì„ ) ---
            if (scoreC !== null && scoreB !== null) {
                finalInsightGrade = pmInsightGrade;
            } else if (scoreA !== null && scoreB !== null) {
                finalInsightGrade = daInsightGrade;
            }
            if (finalInsightGrade.includes("Top")) finalInsightColor = '#10b981';
            else if (finalInsightGrade.includes("Mid")) finalInsightColor = '#f59e0b';
            else if (finalInsightGrade.includes("Low")) finalInsightColor = '#ef4444';
            else finalInsightColor = '#94a3b8';
            // daCriticalMissingì€ A/B/C ëª¨ë‘ì— ëŒ€í•œ í•„ìˆ˜ê°’ì„
            if (daCriticalMissing) {
                 daInsightGrade = 'ë°ì´í„° ë¶€ì¡±';
                 daInsightText = 'ë¯¸ë””ì–´ ì„±ê³¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.';
                 daFeedback = '';
                 finalInsightGrade = 'ë°ì´í„° ë¶€ì¡±';
                 finalInsightColor = '#94a3b8';
                 scoreA = null;
                 scoreB = null;
                 scoreC = null;
                 totalDaScore = null;
                 totalPmScore = null;
            }
            
            return {
                // Scores
                scoreA: scoreA !== null ? parseFloat(scoreA.toFixed(2)) : null,
                scoreB: scoreB !== null ? parseFloat(scoreB.toFixed(2)) : null,
                scoreC: scoreC !== null ? parseFloat(scoreC.toFixed(2)) : null,
                totalDaScore: totalDaScore !== null ? parseFloat(totalDaScore.toFixed(2)) : null,
                totalPmScore: totalPmScore !== null ? parseFloat(totalPmScore.toFixed(2)) : null,
                // Insights
                insight: finalInsightGrade, // ëŒ€í‘œ ì¸ì‚¬ì´íŠ¸ (PM ìš°ì„ )
                color: finalInsightColor,
                mediaInsight: (scoreC !== null && scoreB !== null) ? `${mediaPrefix}: ${pmInsightText}` : `${mediaPrefix}: ${daInsightText}`, // [NEW] 5ë‹¨ê³„: ë¶„ê¸°
                // [NEW] (í•­ëª© 7) 5ë‹¨ê³„: 4ê°œ ì—´ ë°˜í™˜
                daInsightGrade: daInsightGrade,
                daFeedback: daFeedback,
                pmInsightGrade: (scoreC !== null && scoreB !== null) ? pmInsightGrade : '-',
                pmFeedback: (scoreC !== null && scoreB !== null) ? pmFeedback : '-',
                // Raw/Calculated Metrics for Detail Table
                media: row.media,
                placement: row.placement || '',
                creativeName: row.creativeName || '',
                cost: row.cost || 0,
                imp: row.imp || 0,
                click: row.click || 0,
                conv: row.conv || 0,
                revenue: row.revenue || 0,
                ctr: row.actualCtr || 0,
                cpm: row.actualCpm || 0,
                cpc: row.actualCpc || 0,
                actualCvr: row.actualCvr || 0,
                actualCpa: row.actualCpa || 0,
                roas: (row.cost > 0 && row.revenue !== null) ? (row.revenue / row.cost) * 100 : 0
            };
        }
        
        /**
         * [MODIFY] 5ë‹¨ê³„: ë¶„ì„ ëŒ€ìƒ ë°ì´í„°ë¥¼ ì¸ìë¡œ ë°›ë„ë¡ ìˆ˜ì • (ë©”ì¸/ìƒ˜í”Œ ê³µìš©í™”)
         * @param {Array} dataToAnalyze - ë¶„ì„í•  scoredData ë°°ì—´
         * @returns {Object} - ì§‘ê³„ëœ ë°ì´í„° (liveAnalysisDataì™€ ë™ì¼í•œ êµ¬ì¡°)
         */
        function aggregateAndScoreData(sourceValidationData) {
            const rawInputData = sourceValidationData;
            
            const scoredData = rawInputData
                .filter(row => row.media || row.creativeName || row.cost !== null || row.imp !== null)
                .map(row => {
                     calculateValidationMetrics(row);
                     return calculateScoresAndInsight(row);
                });
                
            // --- Calculate Summary Metrics ---
            let totalCost = 0;
            let totalImp = 0;
            let totalClick = 0;
            let totalConv = 0;
            let totalRevenue = 0;
            
            scoredData.forEach(item => {
                totalCost += item.cost || 0;
                totalImp += item.imp || 0;
                totalClick += item.click || 0;
                totalConv += item.conv || 0;
                totalRevenue += item.revenue || 0;
            });
            
            const avgCpm = totalImp > 0 ? (totalCost / totalImp) * 1000 : 0;
            const avgCtr = totalImp > 0 ? (totalClick / totalImp) : 0;
            const avgCpc = totalClick > 0 ? (totalCost / totalClick) : 0;
            const avgCvr = totalClick > 0 ? (totalConv / totalClick) : 0;
            const avgCpa = totalConv > 0 ? (totalCost / totalConv) : 0;
            const avgRoas = totalCost > 0 ? (totalRevenue / totalCost) * 100 : 0;
            
            let summaryMetrics = [];
            
            summaryMetrics = [
                { label: 'ì´ ê´‘ê³ ë¹„', key: 'cost', value: totalCost, type: 'currency' },
                { label: 'ì´ ë…¸ì¶œìˆ˜', key: 'imp', value: totalImp, type: 'number',
                    subMetrics: [
                        { label: 'ì„±ê³¼ CPM', value: avgCpm, type: 'currency' }
                    ]
                },
                { label: 'ì´ í´ë¦­ìˆ˜', key: 'click', value: totalClick, type: 'number',
                    subMetrics: [
                        { label: 'ì„±ê³¼ CPC', value: avgCpc, type: 'currency' },
                        { label: 'ì„±ê³¼ CTR', value: avgCtr, type: 'percent' }
                    ]
                },
                { label: 'ì´ ì „í™˜ìˆ˜', key: 'conv', value: totalConv, type: 'number',
                    subMetrics: [
                        { label: 'ì„±ê³¼ CVR', value: avgCvr, type: 'percent' },
                        { label: 'ì„±ê³¼ CPA', value: avgCpa, type: 'currency' }
                    ]
                },
                { label: 'ì´ ë§¤ì¶œì•¡', key: 'revenue', value: totalRevenue, type: 'currency',
                    subMetrics: [
                        { label: 'ì„±ê³¼ ROAS', value: avgRoas, type: 'percent' }
                    ]
                },
            ];
            
            // [MODIFY] 5ë‹¨ê³„: liveAnalysisDataë¥¼ ì„¤ì •í•˜ëŠ” ëŒ€ì‹  ê°ì²´ ë°˜í™˜
            return { 
                data: scoredData, 
                summary: summaryMetrics, 
                metrics: { xAxis: 'ë…¸ì¶œ ì˜í–¥ë ¥ (Aì ìˆ˜)', yAxis: 'ì†Œì¬ ê´€ì‹¬ë„ (Bì ìˆ˜)' },
                headers: campaignData['MAIN'].headers,
                name: "ì§‘í–‰ ì„±ê³¼ ìš”ì•½"
            };
        }
        // --- Rendering Functions (Updated to use liveAnalysisData) ---
        const matrixContainer = document.getElementById('quadrant-matrix');
        const tableBody = document.getElementById('table-body');
        const tooltip = document.createElement('div');
        tooltip.id = 'chart-tooltip';
        tooltip.className = 'fixed p-2 bg-gray-800 text-white text-xs rounded-lg shadow-xl pointer-events-none opacity-0 transition-opacity duration-200 z-[100] whitespace-nowrap';
        document.body.appendChild(tooltip);
        
        /**
         * [MODIFY] 5ë‹¨ê³„: ë Œë”ë§ í•¨ìˆ˜ë“¤ì´ ë¶„ì„ ë°ì´í„°ë¥¼ ì¸ìë¡œ ë°›ë„ë¡ ìˆ˜ì •
         * @param {Object} analysisData - aggregateAndScoreDataê°€ ë°˜í™˜í•œ ê°ì²´
         * @param {HTMLElement} targetContainer - ë Œë”ë§ ëŒ€ìƒ (ë©”ì¸ í˜ì´ì§€ or ëª¨ë‹¬)
         */
        function renderChart(analysisData, targetContainer) {
            const matrixRect = targetContainer.getBoundingClientRect();
            // [FIX] 5ë‹¨ê³„: ëª¨ë‹¬ì—ì„œ 0x0ìœ¼ë¡œ ê³„ì‚°ë˜ëŠ” ë¬¸ì œ ìˆ˜ì •
            const W = matrixRect.width || targetContainer.parentElement.clientWidth || 500;
            const H = matrixRect.height || 300; 
            targetContainer.innerHTML = ''; // ê¸°ì¡´ ì ë“¤ ì œê±°
            // 4ê°œ ë¶„ë©´ ë°°ê²½ ì¶”ê°€
            targetContainer.innerHTML = `
                <div class="matrix-lines">
                    <div class="v-line"></div>
                    <div class="h-line"></div>
                </div>
                <!-- [MODIFY] 5ë‹¨ê³„: ëª¨ë‹¬ìš© í…ìŠ¤íŠ¸/ìŠ¤íƒ€ì¼ ì ìš© -->
                <div class="sample-quadrant quadrant-top-left">
                    <div>
                        <h3 class="text-blue-700">High Potential</h3>
                        <p class="text-gray-500">ë…¸ì¶œ(Low) ë°˜ì‘(High)</p>
                    </div>
                </div>
                <div class="sample-quadrant quadrant-top-right">
                    <div>
                        <h3 class="text-green-700">STAR</h3>
                        <p class="text-gray-500">ë…¸ì¶œ(High) ë°˜ì‘(High)</p>
                    </div>
                </div>
                <div class="sample-quadrant quadrant-bottom-left">
                     <div>
                        <h3 class="text-red-700">Question Mark</h3>
                        <p class="text-gray-500">ë…¸ì¶œ(Low) ë°˜ì‘(Low)</p>
                    </div>
                </div>
                <div class="sample-quadrant quadrant-bottom-right">
                    <div>
                        <h3 class="text-amber-700">Niche</h3>
                        <p class="text-gray-500">ë…¸ì¶œ(High) ë°˜ì‘(Low)</p>
                    </div>
                </div>
            `;
            
            if (!analysisData || analysisData.data.length === 0) {
                 return;
            }
            
            const data = analysisData;
            const MIN_SCORE = 0;
            const MAX_SCORE = 5;
            const PADDING = 20; // ëª¨ë‹¬ ì°¨íŠ¸ìš© íŒ¨ë”© ì¶•ì†Œ
            const plotW = W - 2 * PADDING;
            const plotH = H - 2 * PADDING;
            const scaleX = plotW / (MAX_SCORE - MIN_SCORE);
            const scaleY = plotH / (MAX_SCORE - MIN_SCORE);
            
            data.data.forEach((item, index) => {
                const DOT_SIZE = 14;
                // DA ì  (A, B) ë Œë”ë§
                if (item.scoreA !== null && item.scoreB !== null) { 
                    let x = PADDING + (item.scoreA - MIN_SCORE) * scaleX; 
                    let y = H - PADDING - (item.scoreB - MIN_SCORE) * scaleY;
                    const dot = document.createElement('div');
                    dot.className = 'chart-dot';
                    dot.style.backgroundColor = item.color;
                    
                    x = Math.max(PADDING + DOT_SIZE / 2, Math.min(W - PADDING - DOT_SIZE / 2, x));
                    y = Math.max(PADDING + DOT_SIZE / 2, Math.min(H - PADDING - DOT_SIZE / 2, y));
                    dot.style.left = `${x - DOT_SIZE / 2}px`;
                    dot.style.top = `${y - DOT_SIZE / 2}px`;
                    
                    // Dataset ì±„ìš°ê¸°
                    dot.dataset.index = index;
                    dot.dataset.media = item.media || 'N/A';
                    dot.dataset.placement = item.placement || 'N/A';
                    dot.dataset.creativeName = item.creativeName || 'N/A';
                    dot.dataset.insight = item.daInsightGrade; // [MODIFY] 5ë‹¨ê³„: DA ë“±ê¸‰
                    dot.dataset.scoreA = item.scoreA.toFixed(1);
                    dot.dataset.scoreB = item.scoreB.toFixed(1);
                    dot.dataset.totalDaScore = item.totalDaScore !== null ? item.totalDaScore.toFixed(2) : 'N/A';
                    if (item.scoreC !== null) {
                        dot.dataset.scoreC = item.scoreC.toFixed(1);
                        dot.dataset.totalPmScore = item.totalPmScore !== null ? item.totalPmScore.toFixed(2) : 'N/A';
                    }
                    
                    dot.addEventListener('mouseenter', showTooltip);
                    dot.addEventListener('mousemove', moveTooltip);
                    dot.addEventListener('mouseleave', hideTooltip);
                    targetContainer.appendChild(dot);
                }
                // Perf ì  (C, B) ë Œë”ë§
                if (item.scoreC !== null && item.scoreB !== null) {
                    let xPerf = PADDING + (item.scoreC - MIN_SCORE) * scaleX; 
                    let yPerf = H - PADDING - (item.scoreB - MIN_SCORE) * scaleY; 
                    const dotPerf = document.createElement('div');
                    dotPerf.className = 'chart-dot-perf'; 
                    dotPerf.style.backgroundColor = item.color; // [MODIFY] (í•­ëª© 7) 5ë‹¨ê³„
                    xPerf = Math.max(PADDING + DOT_SIZE / 2, Math.min(W - PADDING - DOT_SIZE / 2, xPerf));
                    yPerf = Math.max(PADDING + DOT_SIZE / 2, Math.min(H - PADDING - DOT_SIZE / 2, yPerf));
                    dotPerf.style.left = `${xPerf - DOT_SIZE / 2}px`;
                    dotPerf.style.top = `${yPerf - DOT_SIZE / 2}px`;
                    // ë™ì¼í•œ datasetì„ ê³µìœ 
                    dotPerf.dataset.index = index;
                    dotPerf.dataset.media = item.media || 'N/A';
                    dotPerf.dataset.placement = item.placement || 'N/A';
                    dotPerf.dataset.creativeName = item.creativeName || 'N/A';
                    dotPerf.dataset.insight = item.pmInsightGrade; // [MODIFY] 5ë‹¨ê³„: PM ë“±ê¸‰
                    dotPerf.dataset.scoreA = item.scoreA !== null ? item.scoreA.toFixed(1) : 'N/A';
                    dotPerf.dataset.scoreB = item.scoreB.toFixed(1);
                    dotPerf.dataset.scoreC = item.scoreC.toFixed(1);
                    dotPerf.dataset.totalDaScore = item.totalDaScore !== null ? item.totalDaScore.toFixed(2) : 'N/A';
                    dotPerf.dataset.totalPmScore = item.totalPmScore !== null ? item.totalPmScore.toFixed(2) : 'N/A';
                    
                    dotPerf.addEventListener('mouseenter', showTooltip);
                    dotPerf.addEventListener('mousemove', moveTooltip);
                    dotPerf.addEventListener('mouseleave', hideTooltip);
                    targetContainer.appendChild(dotPerf);
                }
            });
        }
        
        /**
         * [MODIFY] (í•­ëª© 3, 4, 5, 6) 5ë‹¨ê³„: íˆ´íŒ ë¡œì§ ì „ì²´ ìˆ˜ì •
         */
        function showTooltip(e) { 
            const item = e.target.dataset;
            const insightText = item.insight;
            const isPerfDot = e.target.classList.contains('chart-dot-perf');
            // [NEW] (í•­ëª© 3) 5ë‹¨ê³„: ì „ì²´ ì´ë¦„
            let creativeName = `${item.media} / ${item.placement} / ${item.creativeName}`;
            if (creativeName === 'N/A / N/A / N/A') creativeName = 'ì´ë¦„ ì—†ìŒ';
            let tooltipContent = `<div class="font-bold text-base">${creativeName}</div>`;
            
            if (isPerfDot && item.scoreC) {
                // [NEW] (í•­ëª© 6) 5ë‹¨ê³„: PM íˆ´íŒ
                tooltipContent += `<div class="mt-1">ë“±ê¸‰: ${insightText} (PM)</div>`;
                // [NEW] (í•­ëª© 5) 5ë‹¨ê³„: ìš©ì–´ ìˆ˜ì •
                tooltipContent += `<div class="mt-0.5 text-xs text-green-300">PM ì„±ê³¼ : ì „í™˜ ${item.scoreC} / ë°˜ì‘ ${item.scoreB}</div>`;
                tooltipContent += `<div class="mt-1 text-xs text-gray-400">PM ì„±ê³¼ ì´ì : ${item.totalPmScore}</div>`;
            } else {
                // [NEW] (í•­ëª© 6) 5ë‹¨ê³„: DA íˆ´íŒ
                tooltipContent += `<div class="mt-1">ë“±ê¸‰: ${insightText} (DA)</div>`;
                // [NEW] (í•­ëª© 5) 5ë‹¨ê³„: ìš©ì–´ ìˆ˜ì •
                tooltipContent += `<div class="mt-0.5 text-xs text-indigo-300">DA ì„±ê³¼ : ë…¸ì¶œ ${item.scoreA} / ë°˜ì‘ ${item.scoreB}</div>`;
                tooltipContent += `<div class="mt-1 text-xs text-gray-400">DA ì„±ê³¼ ì´ì : ${item.totalDaScore}</div>`;
            }
            
            tooltip.innerHTML = tooltipContent;
            tooltip.classList.add('opacity-100');
            moveTooltip(e);
        }
        function moveTooltip(e) {
            let x = e.clientX + 15;
            let y = e.clientY - 15;
            const tooltipRect = tooltip.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            if (x + tooltipRect.width + 15 > viewportWidth) {
                x = e.clientX - tooltipRect.width - 15;
            }
            if (y - 15 < 0) {
                 y = e.clientY + 15;
            }
            else if (y + tooltipRect.height > viewportHeight) {
                y = viewportHeight - tooltipRect.height - 10;
            }
            tooltip.style.left = `${x}px`;
            tooltip.style.top = `${y}px`;
        }
        function hideTooltip() { 
            tooltip.classList.remove('opacity-100');
        }
        
        function renderSummaryTable(analysisData, targetHeader, targetBody) {
            if (!analysisData || analysisData.summary.length === 0) return;
            const data = analysisData;
            const headerRow = targetHeader;
            const body = targetBody;
            headerRow.innerHTML = '';
            body.innerHTML = '';
            
            data.summary.forEach(metric => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-center min-w-[150px]';
                th.textContent = metric.label;
                headerRow.appendChild(th);
            });
            
            const tr = document.createElement('tr');
            tr.className = 'text-gray-900';
            
            data.summary.forEach(metric => {
                const td = document.createElement('td');
                td.className = 'px-6 py-4 whitespace-nowrap text-center align-top';
                
                let mainValueText = formatNumber(metric.value, metric.type);
                
                if (metric.key === 'roas_avg') {
                     mainValueText = `${Math.round(metric.value).toLocaleString('ko-KR')}%`;
                }
                let tdHtml = `<div class="text-lg font-bold">${mainValueText}</div>`;
                
                if (metric.subMetrics) {
                    metric.subMetrics.forEach(sub => {
                        let subValueText = formatNumber(sub.value, sub.type);
                        if (sub.label === 'ì„±ê³¼ ROAS') {
                             subValueText = `${Math.round(sub.value).toLocaleString('ko-KR')}%`;
                        }
                        
                        tdHtml += `<div class="text-sm text-gray-600 mt-2">
                                     <span class="font-semibold">${sub.label}:</span> ${subValueText}
                                   </div>`;
                    });
                }
                
                td.innerHTML = tdHtml;
                tr.appendChild(td);
            });
            body.appendChild(tr);
        }
        
        function sortData(key) {
            if (!liveAnalysisData) return; // [FIX] 5ë‹¨ê³„: ì•ˆì •í™”
            if (sortColumn === key) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = key;
                sortDirection = 'desc';
            }
            const data = liveAnalysisData.data;
            data.sort((a, b) => {
                // [FIX] (í•­ëª© 2) 5ë‹¨ê³„: null ê°’ ì •ë ¬ ì˜¤ë¥˜ ë°©ì§€
                const aVal = a[key] === null ? (sortDirection === 'asc' ? Infinity : -Infinity) : a[key];
                const bVal = b[key] === null ? (sortDirection === 'asc' ? Infinity : -Infinity) : b[key];
                
                let comparison = 0;
                if (aVal > bVal) {
                    comparison = 1;
                } else if (aVal < bVal) {
                    comparison = -1;
                }
                return sortDirection === 'asc' ? comparison : comparison * -1;
            });
            renderTable(liveAnalysisData, document.getElementById('table-header'), document.getElementById('table-body'));
        }
        
        /**
         * [MODIFY] (í•­ëª© 7) 5ë‹¨ê³„: 4ì—´ ë¶„ë¦¬
         */
        function renderTable(analysisData, targetHeader, targetBody) {
            if (!analysisData || analysisData.data.length === 0) {
                 targetBody.innerHTML = `<tr><td colspan="20" class="text-center py-4 text-gray-500">ë¯¸ë””ì–´ ì„±ê³¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”</td></tr>`; // [MODIFY] 5ë‹¨ê³„: colspan 20
                 targetHeader.innerHTML = '';
                 return;
            }
            
            const data = analysisData;
            const headerRow = targetHeader;
            const body = targetBody;
            body.innerHTML = '';
            headerRow.innerHTML = '';
            
            data.headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left border-b border-gray-200 text-center sortable whitespace-nowrap';
                
                // [NEW] (í•­ëª© 5) 'ì „í™˜ ì„±ê³¼' ê´€ë ¨ í—¤ë”ì— perf-col í´ë˜ìŠ¤ ë° hidden ì ìš©
                const perfKeys = ['conv', 'revenue', 'actualCvr', 'actualCpa', 'roas', 'scoreC'];
                if (perfKeys.includes(header.key)) {
                    th.classList.add('perf-col');
                    if (targetHeader.id === 'table-header' && !isPerfInputVisible) th.classList.add('hidden'); // ë©”ì¸ í…Œì´ë¸”ì—ë§Œ hidden ì ìš©
                }
                // [NEW] (í•­ëª© 7) 5ë‹¨ê³„: PM ì¸ì‚¬ì´íŠ¸/í”¼ë“œë°± ì—´
                const pmInsightKeys = ['pmInsightGrade', 'pmFeedback'];
                if (pmInsightKeys.includes(header.key)) {
                    th.classList.add('pm-insight-col');
                    if (targetHeader.id === 'table-header' && !isPerfInputVisible) th.classList.add('hidden'); // ë©”ì¸ í…Œì´ë¸”ì—ë§Œ hidden ì ìš©
                }
                if (header.key === 'cost') {
                     th.innerHTML = `${header.name} <span class="header-subtext">(ì†Œì§„ ê¸ˆì•¡)</span>`;
                } else if (header.key === 'scoreA') {
                     th.innerHTML = `${header.name} <span class="header-subtext">(ë…¸ì¶œ ì˜í–¥ë ¥)</span>`;
                } else if (header.key === 'scoreB') {
                     th.innerHTML = `${header.name} <span class="header-subtext">(ì†Œì¬ ê´€ì‹¬ë„)</span>`;
                } else if (header.key === 'scoreC') { 
                     th.innerHTML = `${header.name} <span class="header-subtext">(ì „í™˜ ê¸°ì—¬ë„)</span>`;
                } else {
                    th.textContent = header.name;
                }
                
                th.dataset.key = header.key;
                if (targetHeader.id === 'table-header') { // ìƒ˜í”Œ ëª¨ë‹¬ì—ì„œëŠ” ì •ë ¬ X
                    th.addEventListener('click', () => sortData(header.key));
                    if (sortColumn === header.key) {
                        th.innerHTML += sortDirection === 'asc' ? ' â–²' : ' â–¼';
                    }
                }
                headerRow.appendChild(th);
            });
            
            data.data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-indigo-50 transition-colors';
                
                const keys = data.headers.map(h => h.key);
                
                keys.forEach(key => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-600 text-center';
                    
                    // [NEW] (í•­ëª© 5) 'ì „í™˜ ì„±ê³¼' ê´€ë ¨ ì…€ì— perf-col í´ë˜ìŠ¤ ë° hidden ì ìš©
                    const perfKeys = ['conv', 'revenue', 'actualCvr', 'actualCpa', 'roas', 'scoreC'];
                    if (perfKeys.includes(key)) {
                        td.classList.add('perf-col');
                         if (targetBody.id === 'table-body' && !isPerfInputVisible) td.classList.add('hidden');
                    }
                    // [NEW] (í•­ëª© 7) 5ë‹¨ê³„: PM ì¸ì‚¬ì´íŠ¸/í”¼ë“œë°± ì—´
                    const pmInsightKeys = ['pmInsightGrade', 'pmFeedback'];
                    if (pmInsightKeys.includes(key)) {
                        td.classList.add('pm-insight-col');
                        if (targetBody.id === 'table-body' && !isPerfInputVisible) td.classList.add('hidden');
                    }
                    
                    let cellValue = item[key];
                    switch(key) {
                        case 'cost':
                        case 'revenue':
                        case 'cpm':
                        case 'cpc':
                        case 'actualCpa':
                            td.textContent = formatNumber(cellValue, 'currency');
                            break;
                        case 'imp':
                        case 'click':
                        case 'conv':
                            td.textContent = formatNumber(cellValue, 'number');
                            break;
                        case 'ctr':
                        case 'actualCvr':
                            td.textContent = formatNumber(cellValue, 'percent');
                            break;
                        case 'roas':
                            td.textContent = `${Math.round(cellValue).toLocaleString('ko-KR')}%`;
                            break;
                        case 'scoreA':
                        case 'scoreB':
                        case 'scoreC':
                            td.textContent = formatNumber(cellValue, 'score');
                            td.classList.add('font-bold', 'text-gray-800');
                            break;
                        // [MODIFY] (í•­ëª© 7) 5ë‹¨ê³„: 4ì—´ ë¶„ë¦¬
                        case 'daInsightGrade':
                        case 'pmInsightGrade':
                            const insightText = cellValue;
                            if (insightText === '-' || insightText === 'ë°ì´í„° ë¶€ì¡±') {
                                td.textContent = '-';
                            } else {
                                const color = item.color; // [FIX] 5ë‹¨ê³„: item.color ì‚¬ìš©
                                td.innerHTML = `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color:${color}1A; color:${color}">${insightText}</span>`;
                            }
                            break;
                        case 'daFeedback':
                        case 'pmFeedback':
                            let actionText = cellValue;
                            let colorClass = 'text-gray-800';
                            
                            // [FIX] 5ë‹¨ê³„: item.insightê°€ ì•„ë‹Œ finalInsightGrade (item.insight) ê¸°ì¤€ìœ¼ë¡œ
                            if (item.insight.includes("Top")) {
                                colorClass = 'text-green-600 bg-green-100';
                            } else if (item.insight.includes("Mid")) {
                                colorClass = 'text-amber-600 bg-amber-100';
                            } else if (item.insight.includes("Low")) {
                                colorClass = 'text-red-600 bg-red-100';
                            } else {
                                actionText = '-';
                                colorClass = '';
                            }
                            if (actionText === '-') {
                                td.textContent = '-';
                            } else {
                                td.innerHTML = `<span class="font-bold rounded-lg px-2 py-1 ${colorClass}">${actionText}</span>`;
                            }
                            break;
                        default:
                            td.textContent = cellValue;
                            td.classList.remove('text-center');
                            td.classList.add('text-left');
                            break;
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        /**
         * [MODIFY] (í•­ëª© 3, 4, 8, 9 / ë²„ê·¸ 1) 5ë‹¨ê³„: Insight ë Œë”ë§ ìˆ˜ì •
         */
        function renderInsights(analysisData, targetList) {
            if (!analysisData || analysisData.data.length === 0) {
                 targetList.innerHTML = `<li class="text-gray-500">ë¯¸ë””ì–´ ì„±ê³¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”</li>`;
                 return;
            }
            const data = analysisData.data;
            const insightList = targetList;
            insightList.innerHTML = '';
            
            const daInsights = {};
            const perfInsights = {};
            const roasInsights = []; // [NEW] (í•­ëª© 4)
            let hasValidDaData = false;
            let hasValidPerfData = false;
            
            data.forEach(item => {
                // [FIX] (í•­ëª© 1) 5ë‹¨ê³„: mediaPrefixë¥¼ ë£¨í”„ ìƒë‹¨ìœ¼ë¡œ ì´ë™
                const mediaPrefix = (item.media || item.placement || item.creativeName) 
                        ? `${item.media || 'N/A'}/${item.placement || 'N/A'}/${item.creativeName || 'N/A'}` 
                        : 'ë§¤ì²´ ìƒí’ˆê³¼ ì†Œì¬ëª… ì—†ìŒ';
                        
                // [NEW] (í•­ëª© 4) ROAS ì¸ì‚¬ì´íŠ¸ ìˆ˜ì§‘
                if (item.revenue > 0 && item.cost > 0) {
                    // const mediaPrefix = ... [REMOVED]
                    const roasData = getRoasInsight(item.roas, mediaPrefix);
                    if (roasData) roasInsights.push(roasData);
                }
                // [MODIFY] (í•­ëª© 3) DA / Perf ì¸ì‚¬ì´íŠ¸ ë¶„ë¦¬
                if (item.scoreC !== null && item.scoreB !== null) {
                    // Perf Insight
                    hasValidPerfData = true;
                    const grade = item.pmInsightGrade; // [NEW] (í•­ëª© 7) 5ë‹¨ê³„
                    if (!perfInsights[grade]) {
                        perfInsights[grade] = [];
                    }
                    perfInsights[grade].push({ 
                        // [FIX] 5ë‹¨ê³„: item.mediaInsightë¥¼ ì§ì ‘ ì‚¬ìš©
                        insight: item.mediaInsight,
                        color: item.color
                    });
                } else if (item.scoreA !== null && item.scoreB !== null) {
                    // DA Insight
                    hasValidDaData = true;
                    const grade = item.daInsightGrade; // [NEW] (í•­ëª© 7) 5ë‹¨ê³„
                    if (!daInsights[grade]) {
                        daInsights[grade] = [];
                    }
                    daInsights[grade].push({ 
                        // [FIX] 5ë‹¨ê³„: item.mediaInsightë¥¼ ì§ì ‘ ì‚¬ìš©
                        insight: item.mediaInsight, 
                        color: item.color
                    });
                }
            });
            
            if (!hasValidDaData && !hasValidPerfData && roasInsights.length === 0) {
                 insightList.innerHTML = `<li class="text-gray-500">ë¯¸ë””ì–´ ì„±ê³¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”</li>`;
                 return;
            }
            
            // --- Helper for rendering insight list items ---
            const renderInsightSection = (title, insights, order, color) => {
                const gradeHeader = document.createElement('li');
                gradeHeader.className = `pt-4 mb-2 font-extrabold text-lg border-b-2 pb-1`;
                gradeHeader.style.borderColor = color;
                gradeHeader.style.color = color;
                gradeHeader.innerHTML = title;
                insightList.appendChild(gradeHeader);
                let itemCount = 0;
                order.forEach(grade => {
                    const items = insights[grade];
                    if (items && items.length > 0) {
                        itemCount += items.length;
                        items.forEach(item => {
                            const li = document.createElement('li');
                            li.className = 'text-gray-700 text-sm flex items-start';
                            
                            // [FIX] (ë²„ê·¸ 1) 5ë‹¨ê³„: ì¤„ë°”ê¿ˆ ì˜¤ë¥˜ ìˆ˜ì •
                            let prefix = '';
                            let text = item.insight;
                            const insightParts = item.insight.split(/:(.+)/);
                            if (insightParts.length > 1) {
                                prefix = insightParts[0].trim();
                                text = insightParts[1].trim();
                            }
                            
                            li.innerHTML = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mt-1 mr-2 flex-shrink-0" style="color:${item.color}" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                <span>
                                    <strong class="font-bold text-gray-900 block">${prefix}</strong>
                                    <span class="block ${prefix ? 'mt-1' : ''}">${text}</span>
                                </span>
                            `;
                            insightList.appendChild(li);
                        });
                    }
                });
                if (itemCount === 0) insightList.removeChild(gradeHeader); // í•­ëª© ì—†ìœ¼ë©´ í—¤ë” ì œê±°
            };
            
            const insightOrder = ["Top ì†Œì¬", "Topì†Œì¬", "Mid ì†Œì¬", "Midì†Œì¬", "Lowì†Œì¬", "ë°ì´í„° ë¶€ì¡±", "ì˜¤ë¥˜"];
            
            // [NEW] (í•­ëª© 3) 5ë‹¨ê³„: í¼í¬ë¨¼ìŠ¤ ì¸ì‚¬ì´íŠ¸ ë Œë”ë§
            if (hasValidPerfData) {
                renderInsightSection("[PM ì¸ì‚¬ì´íŠ¸]", perfInsights, insightOrder, '#6366f1'); // [FIX] (í•­ëª© 9) 5ë‹¨ê³„: ê´„í˜¸ ì œê±°
            }
            // [NEW] (í•­ëª© 3) 5ë‹¨ê³„: DA ì¸ì‚¬ì´íŠ¸ ë Œë”ë§
            if (hasValidDaData) {
                renderInsightSection("[DA ì¸ì‚¬ì´íŠ¸]", daInsights, insightOrder, '#059669'); // [FIX] (í•­ëª© 9) 5ë‹¨ê³„: ê´„í˜¸ ì œê±°
            }
            // [NEW] (í•­ëª© 4) 5ë‹¨ê³„: ROAS ì¸ì‚¬ì´íŠ¸ ë Œë”ë§
            if (roasInsights.length > 0) {
                 const gradeHeader = document.createElement('li');
                gradeHeader.className = `pt-4 mb-2 font-extrabold text-lg border-b-2 pb-1`;
                gradeHeader.style.borderColor = '#ca8a04'; // Yello
                gradeHeader.style.color = '#ca8a04';
                gradeHeader.innerHTML = "[ROAS ì„±ê³¼]"; // [FIX] (í•­ëª© 8a) 5ë‹¨ê³„: (ì˜µì…˜) ì œê±°
                insightList.appendChild(gradeHeader);
                
                roasInsights.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'text-gray-700 text-sm flex items-start';
                    
                    let prefix = '';
                    let text = item.text; // [MODIFY] (í•­ëª© 8b) 5ë‹¨ê³„: item.textëŠ” ì´ë¯¸ `[ROAS 440% (4ì )] ...` í¬í•¨
                    const insightParts = item.text.split(/:(.+)/);
                    if (insightParts.length > 1) {
                        prefix = insightParts[0].trim();
                        text = insightParts[1].trim();
                    }
                    
                    li.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mt-1 mr-2 flex-shrink-0" style="color:#ca8a04" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                        <span>
                            <strong class="font-bold text-gray-900 block">${prefix}</strong>
                            <span class="block ${prefix ? 'mt-1' : ''}">${text}</span>
                        </span>
                    `;
                    insightList.appendChild(li);
                });
            }
        }
        
        
        /**
         * (í•­ëª© 1) Runs all analysis and renders the results section.
         */
        function runAnalysis() {
            try {
                // [MODIFY] 5ë‹¨ê³„: í˜„ì¬ validationDataë¡œ ë¶„ì„
                liveAnalysisData = aggregateAndScoreData(validationData['MAIN']);
                
                renderSummaryTable(liveAnalysisData, document.getElementById('summary-header'), document.getElementById('summary-body'));
                renderTable(liveAnalysisData, document.getElementById('table-header'), document.getElementById('table-body'));
                renderInsights(liveAnalysisData, document.getElementById('insight-list'));
                
                setTimeout(() => {
                    // [MODIFY] 5ë‹¨ê³„: ë©”ì¸ ì°¨íŠ¸ ë Œë”ë§
                    renderChart(liveAnalysisData, matrixContainer);
                }, 0); 
            } catch (error) {
                console.error("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        }
        // [NEW] (í•­ëª© 2) 5ë‹¨ê³„: ìƒ˜í”Œ ëª¨ë‹¬ ë Œë”ë§ í•¨ìˆ˜
        function showSampleModal() {
            sampleModalBody.innerHTML = '<p class="text-center text-gray-500">ìƒ˜í”Œ ë°ì´í„° ë¶„ì„ ì¤‘...</p>';
            sampleModalBackdrop.classList.remove('hidden');
            sampleModalBackdrop.classList.add('flex');
            try {
                // [FIX] 5ë‹¨ê³„: ìƒ˜í”Œ ëª¨ë‹¬ì€ í•­ìƒ testProjectMockDataë¥¼ ì‚¬ìš©
                const sampleValidationData = mapCampaignDataToValidation(testProjectMockData);
                const sampleScoredData = aggregateAndScoreData(sampleValidationData); // ìƒ˜í”Œ ë°ì´í„° ë¶„ì„
                sampleAnalysisData = sampleScoredData; // (ì„ íƒì ) ì „ì—­ ìƒ˜í”Œ ë°ì´í„°ì— ì €ì¥
                // 2. ëª¨ë‹¬ì— ë Œë”ë§í•  HTML ìƒì„±
                sampleModalBody.innerHTML = `
                    <p class="mb-4 text-sm text-gray-700">ì´ ìƒ˜í”Œì€ 4ê°œ ë¶„ë©´(STAR, High Potential, Niche, Question Mark)ê³¼ Top/Mid/Low ë“±ê¸‰ì´ ê³ ë¥´ê²Œ ë¶„í¬ë˜ë„ë¡ êµ¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. DA ì„±ê³¼, PM ì„±ê³¼, ROAS ì„±ê³¼ê°€ ì–´ë–»ê²Œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    
                    <!-- 1. ì„±ê³¼ ìš”ì•½ (ìƒ˜í”Œìš©) -->
                    <h3 class="text-xl font-bold text-gray-800 mt-6 mb-2">ì¢…í•© ì„±ê³¼ ìš”ì•½ (ìƒ˜í”Œ)</h3>
                    <div class="scroll-container overflow-x-auto rounded-xl shadow-lg border">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-indigo-50">
                                <tr id="sample-summary-header" class="text-sm font-semibold text-indigo-700 uppercase tracking-wider"></tr>
                            </thead>
                            <tbody id="sample-summary-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <!-- 2. ì°¨íŠ¸ / ì¸ì‚¬ì´íŠ¸ (ìƒ˜í”Œìš©) -->
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mt-6">
                        <div class="xl:col-span-2 space-y-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">ì†Œì¬ ì„±ê³¼ ë§¤íŠ¸ë¦¬ìŠ¤ (ìƒ˜í”Œ)</h3>
                            <div id="sample-quadrant-matrix" class="sample-quadrant-matrix">
                                <!-- ìƒ˜í”Œ ì°¨íŠ¸ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤. -->
                            </div>
                        </div>
                        <div class="xl:col-span-1 space-y-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">MEDIA INSIGHT (ìƒ˜í”Œ)</h3>
                            <div class="bg-indigo-50 p-4 rounded-xl shadow-lg border border-indigo-200 h-full max-h-[340px] overflow-auto">
                                <ul id="sample-insight-list" class="space-y-4 text-gray-700 text-sm"></ul>
                            </div>
                        </div>
                    </div>
                    <!-- 3. ìƒì„¸ ì§€í‘œ (ìƒ˜í”Œìš©) -->
                    <h3 class="text-xl font-bold text-gray-800 mt-6 mb-2">ìº í˜ì¸ ìƒì„¸ íš¨ìœ¨ ì§€í‘œ (ìƒ˜í”Œ)</h3>
                    <div class="scroll-container overflow-x-auto rounded-xl shadow-inner border max-h-[300px]">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr id="sample-table-header" class="text-xs font-medium text-gray-500 uppercase tracking-wider"></tr>
                            </thead>
                            <!-- [FIX] 5ë‹¨ê³„: tbody íƒœê·¸ ì˜¤ë¥˜ ìˆ˜ì • (</tr> ì œê±°) -->
                            <tbody id="sample-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                `;
                // 3. ìƒì„±ëœ HTML ìš”ì†Œì— ìƒ˜í”Œ ë°ì´í„° ë Œë”ë§
                renderSummaryTable(sampleScoredData, document.getElementById('sample-summary-header'), document.getElementById('sample-summary-body'));
                renderInsights(sampleScoredData, document.getElementById('sample-insight-list'));
                renderTable(sampleScoredData, document.getElementById('sample-table-header'), document.getElementById('sample-table-body'));
                
                // ì°¨íŠ¸ëŠ” DOMì´ ê·¸ë ¤ì§„ í›„ ë Œë”ë§
                setTimeout(() => {
                    renderChart(sampleScoredData, document.getElementById('sample-quadrant-matrix'));
                }, 0);
            } catch (e) {
                console.error("ìƒ˜í”Œ ëª¨ë‹¬ ìƒì„± ì¤‘ ì˜¤ë¥˜:", e);
                sampleModalBody.innerHTML = '<p class="text-center text-red-500">ìƒ˜í”Œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }
        // [NEW] (í•­ëª© 2) renderDashboard ìˆ˜ì •
        function renderDashboard() {
            // (í•­ëª© 2) validationDataëŠ” ì´ì œ í˜„ì¬ í”„ë¡œì íŠ¸ì˜ í¬ì¸í„°
            validationData = storageData.projects[currentProject];
            
            // [FIX] (í•­ëª© 1) 5ë‹¨ê³„: ì•ˆì •í™” íŒ¨ì¹˜
            if (!validationData || !validationData.MAIN || validationData.MAIN.length === 0) {
                 validationData = { 'MAIN': mapCampaignDataToValidation([{}]) }; 
                 storageData.projects[currentProject] = validationData; 
                 isPrefillActive = false;
            } else {
                isPrefillActive = validationData.MAIN.some(row => row.isPrefill);
            }
            
            sortColumn = 'cost'; // ê¸°ë³¸ ì •ë ¬
            sortDirection = 'desc';
            
            // renderValidationTable() ì „ì— ì„±ê³¼ ê³„ì‚° ë¡œì§ ì‹¤í–‰
            validationData['MAIN'].forEach(row => calculateValidationMetrics(row));
            
            renderValidationTable();
            runAnalysis();
        }
        
        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // [NEW] ì•ˆì •í™” 1: ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìš”ì†Œ ì°¸ì¡°
            const customModalBackdrop = document.getElementById('custom-modal-backdrop');
            const customModalConfirm = document.getElementById('custom-modal-confirm');
            const customModalCancel = document.getElementById('custom-modal-cancel');
            
            // [NEW] ì•ˆì •í™” 1: ì»¤ìŠ¤í…€ ëª¨ë‹¬ ë¦¬ìŠ¤ë„ˆ
            customModalConfirm.addEventListener('click', () => {
                if (modalResolve) modalResolve(true);
                hideCustomModal();
            });
            customModalCancel.addEventListener('click', () => {
                if (modalResolve) modalResolve(false);
                hideCustomModal();
            });
            customModalBackdrop.addEventListener('click', (e) => {
                if (e.target === customModalBackdrop) {
                    if (modalResolve) modalResolve(false);
                    hideCustomModal();
                }
            });
            
            try {
                // [NEW] (í•­ëª© 2) localStorage ë¡œë“œ ë¡œì§ ìˆ˜ì •
                const savedStorage = localStorage.getItem(DASHBOARD_STORAGE_KEY);
                if (savedStorage) {
                    try {
                        storageData = JSON.parse(savedStorage);
                        if (!storageData.projects) { // ì´ì „ ë²„ì „ í˜¸í™˜
                            storageData = { currentProject: 'default', projects: { 'default': defaultValidationData } };
                        }
                        currentProject = storageData.currentProject || 'default';
                    } catch(e) {
                         console.error("Failed to parse localStorage data", e);
                         storageData = { currentProject: 'default', projects: { 'default': defaultValidationData } };
                    }
                } else {
                    // [NEW] (í•­ëª© 2) ì²« ë°©ë¬¸ ì‹œ ë˜ëŠ” ë§ˆì´ê·¸ë ˆì´ì…˜
                    const oldData = localStorage.getItem('campaignDashboardData'); // 1ë‹¨ê³„ í‚¤
                    if (oldData) {
                        try {
                            const parsedOldData = JSON.parse(oldData);
                            if(parsedOldData.MAIN || parsedOldData.DA) {
                                // 1ë‹¨ê³„ ë°ì´í„°(DA/MAIN)ë¥¼ 'default' í”„ë¡œì íŠ¸ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
                                storageData.projects['default'] = { MAIN: parsedOldData.MAIN || parsedOldData.DA };
                                localStorage.removeItem('campaignDashboardData'); // 1ë‹¨ê³„ í‚¤ ì œê±°
                            }
                        } catch(e) { console.error("Failed to migrate old data", e); }
                    } else {
                         // storageDataì— defaultValidationDataê°€ ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìŒ
                    }
                }
                // [REMOVED] (í•­ëª© 2) 5ë‹¨ê³„: "í…ŒìŠ¤íŠ¸" í”„ë¡œì íŠ¸ ìë™ ìƒì„± (ìƒ˜í”Œ ë³´ê¸° ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì²´)
                // (í•­ëª© 2) validationData í¬ì¸í„° ì„¤ì •
                if (!storageData.projects[currentProject]) { // ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ì—†ëŠ” ê²½ìš°
                    currentProject = 'default';
                }
                validationData = storageData.projects[currentProject];
                
                
                // [NEW] (í•­ëª© 2) í”„ë¡œì íŠ¸ ì…€ë ‰í„° ì±„ìš°ê¸°
                updateProjectSelector();
                
                toggleValidationTableButton.addEventListener('click', toggleValidationTable);
                addValidationRowButton.addEventListener('click', addValidationRow);
                runAnalysisButton.addEventListener('click', runAnalysis);
                
                // [NEW] (í•­ëª© 1) 5ë‹¨ê³„: ìƒ˜í”Œ ë³´ê¸° ë¦¬ìŠ¤ë„ˆ
                showSampleModalButton.addEventListener('click', showSampleModal);
                sampleModalCloseButton.addEventListener('click', () => {
                    sampleModalBackdrop.classList.add('hidden');
                    sampleModalBackdrop.classList.remove('flex');
                });
                sampleModalBackdrop.addEventListener('click', (e) => {
                    if (e.target === sampleModalBackdrop) {
                        sampleModalBackdrop.classList.add('hidden');
                        sampleModalBackdrop.classList.remove('flex');
                    }
                });
                // [NEW] (í•­ëª© 2) ì €ì¥ ë²„íŠ¼ ë¡œì§ ìˆ˜ì •
                saveDataButton.addEventListener('click', () => {
                    validationData['MAIN'].forEach(row => row.isPrefill = isPrefillActive);
                    storageData.projects[currentProject] = validationData; // í˜„ì¬ í”„ë¡œì íŠ¸ì— ë°ì´í„° ì €ì¥
                    storageData.currentProject = currentProject; // í˜„ì¬ ì„ íƒëœ í”„ë¡œì íŠ¸ ì €ì¥
                    saveDataToLocalStorage(); // ì „ì²´ storageData ê°ì²´ ì €ì¥
                });
                
                // [NEW] ì•ˆì •í™” 1: ë¦¬ì…‹ ë²„íŠ¼ ë¡œì§ ìˆ˜ì • (async ë° ì»¤ìŠ¤í…€ ëª¨ë‹¬)
                resetDataButton.addEventListener('click', async () => {
                    const confirmed = await showCustomConfirm(
                        'í”„ë¡œì íŠ¸ ì´ˆê¸°í™”', 
                        `'${currentProject}' í”„ë¡œì íŠ¸ì˜ ì„±ê³¼ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì €ì¥ëœ ë‚´ìš©ì´ ëª¨ë‘ ì§€ì›Œì§‘ë‹ˆë‹¤.`,
                        'ì´ˆê¸°í™”',
                        'red'
                    );
                    if (confirmed) {
                        validationData = { 'MAIN': [mapCampaignDataToValidation([{}])] }; // ê³µë€ìœ¼ë¡œ
                        storageData.projects[currentProject] = validationData; // í˜„ì¬ í”„ë¡œì íŠ¸ ë¦¬ì…‹
                        isPrefillActive = false;
                        saveDataToLocalStorage();
                        renderDashboard();
                    }
                });
                
                // [NEW] (í•­ëª© 2) ìƒˆ í”„ë¡œì íŠ¸ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
                newProjectButton.addEventListener('click', () => {
                    const newProjectName = prompt("ìƒˆ í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "ìƒˆ í”„ë¡œì íŠ¸");
                    if (newProjectName && newProjectName.trim() !== "") {
                        const cleanProjectName = newProjectName.trim();
                        if (storageData.projects[cleanProjectName]) {
                            // [NEW] ì•ˆì •í™” 1: alert ëŒ€ì‹  ì»¤ìŠ¤í…€ ëª¨ë‹¬ (í™•ì¸ìš©)
                            showCustomConfirm('ì˜¤ë¥˜', 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í”„ë¡œì íŠ¸ ì´ë¦„ì…ë‹ˆë‹¤.', 'í™•ì¸', 'blue');
                            return;
                        }
                        // ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
                        currentProject = cleanProjectName;
                        const newProjectData = { MAIN: [mapCampaignDataToValidation([{}])] }; // ê³µë€
                        storageData.projects[currentProject] = newProjectData;
                        storageData.currentProject = currentProject;
                        validationData = newProjectData; // í¬ì¸í„° ì—…ë°ì´íŠ¸
                        
                        updateProjectSelector(); // ë“œë¡­ë‹¤ìš´ UI ì—…ë°ì´íŠ¸
                        saveDataToLocalStorage();
                        
                        isPrefillActive = false; // ìƒˆ í”„ë¡œì íŠ¸ëŠ” ê³µë€
                        renderDashboard();
                    }
                });
                
                // [NEW] ì•ˆì •í™” 1: í”„ë¡œì íŠ¸ ì‚­ì œ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì • (async ë° ì»¤ìŠ¤í…€ ëª¨ë‹¬)
                deleteProjectButton.addEventListener('click', async () => {
                    if (currentProject === 'default') {
                        // [NEW] ì•ˆì •í™” 1: alert ëŒ€ì‹  ì»¤ìŠ¤í…€ ëª¨ë‹¬ (í™•ì¸ìš©)
                        showCustomConfirm("'default' í”„ë¡œì íŠ¸", "'default' í”„ë¡œì íŠ¸ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'í™•ì¸', 'blue');
                        return;
                    }
                    
                    const confirmed = await showCustomConfirm(
                        'í”„ë¡œì íŠ¸ ì‚­ì œ', 
                        `'${currentProject}' í”„ë¡œì íŠ¸ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
                        'ì‚­ì œ',
                        'red'
                    );
                    if (confirmed) {
                        delete storageData.projects[currentProject];
                        currentProject = 'default';
                        storageData.currentProject = 'default';
                        saveDataToLocalStorage();
                        updateProjectSelector();
                        renderDashboard();
                    }
                });
                // [NEW] (í•­ëª© 2) í”„ë¡œì íŠ¸ ì„ íƒ ë¦¬ìŠ¤ë„ˆ
                projectSelector.addEventListener('change', (e) => {
                    currentProject = e.target.value;
                    storageData.currentProject = currentProject;
                    validationData = storageData.projects[currentProject]; // í¬ì¸í„° ì—…ë°ì´íŠ¸
                    
                    // ë¡œë“œëœ í”„ë¡œì íŠ¸ì˜ prefill ìƒíƒœ ì¬í™•ì¸
                    if (!validationData || !validationData.MAIN || validationData.MAIN.length === 0) {
                        validationData = { 'MAIN': mapCampaignDataToValidation(campaignData.MAIN.data) };
                        storageData.projects[currentProject] = validationData;
                        isPrefillActive = true;
                    } else {
                        isPrefillActive = validationData.MAIN.some(row => row.isPrefill);
                    }
                    
                    renderDashboard();
                });
                renderDashboard(); // Initial render
                
                const toggleIcon = document.getElementById('toggle-icon');
                const toggleText = document.getElementById('toggle-text');
                if (isValidationTableOpen) {
                    toggleText.textContent = 'ì…ë ¥ í…Œì´ë¸” ì ‘ê¸°';
                    toggleIcon.classList.add('rotate-180');
                }
                
                window.addEventListener('resize', () => {
                     // [FIX] 5ë‹¨ê³„: ë©”ì¸ ì°¨íŠ¸ë§Œ ë¦¬ì‚¬ì´ì¦ˆ
                    if (liveAnalysisData) {
                         renderChart(liveAnalysisData, matrixContainer);
                    }
                });
                
            } catch (error) {
                 console.error("ì´ˆê¸°í™” ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ ë°œìƒ:", error);
                 document.body.innerHTML = `<div class="p-8 bg-red-100 text-red-700">í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. consoleì„ í™•ì¸í•´ì£¼ì„¸ìš”. ì˜¤ë¥˜: ${error.message}</div>`;
            }
        });
    </script>
</body>
</html>
